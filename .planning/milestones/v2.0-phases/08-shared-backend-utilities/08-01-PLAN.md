---
phase: 08-shared-backend-utilities
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - backend/shared/src/utils/db-pool.ts
  - backend/shared/src/index.ts
  - backend/shared/tests/db-pool.test.ts
autonomous: true
requirements:
  - RESIL-01
  - RESIL-02
  - RESIL-03

must_haves:
  truths:
    - "createPool() returns a pg Pool instance with error handler attached before the pool is returned"
    - "Default connectionTimeoutMillis is 5000 (not 2000) for Railway cold start resilience"
    - "An idle client error is logged but does NOT crash the process"
    - "Pool config (max, idleTimeout, connectionTimeout, SSL) is defined once and configurable via env vars"
  artifacts:
    - path: "backend/shared/src/utils/db-pool.ts"
      provides: "createPool factory function"
      exports: ["createPool", "CreatePoolOptions"]
    - path: "backend/shared/src/index.ts"
      provides: "Re-export of createPool and CreatePoolOptions"
      contains: "createPool"
    - path: "backend/shared/tests/db-pool.test.ts"
      provides: "Unit tests for createPool factory"
      min_lines: 50
  key_links:
    - from: "backend/shared/src/index.ts"
      to: "backend/shared/src/utils/db-pool.ts"
      via: "re-export"
      pattern: "export.*from.*utils/db-pool"
    - from: "backend/shared/src/utils/db-pool.ts"
      to: "pg"
      via: "Pool constructor"
      pattern: "new Pool\\("
---

<objective>
Create the `createPool()` factory function in `@vlvt/shared` that centralizes PostgreSQL pool configuration with resilient defaults and error handling.

Purpose: Eliminate duplicated pool configuration across three services and ensure all pools handle idle client errors without crashing (RESIL-01), use 5-second connection timeouts for Railway cold starts (RESIL-02), and share a single source of truth for pool settings (RESIL-03).

Output: `backend/shared/src/utils/db-pool.ts` with factory function and types, re-exported from `backend/shared/src/index.ts`, with comprehensive tests.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-shared-backend-utilities/08-RESEARCH.md

@backend/shared/src/index.ts
@backend/shared/src/utils/logger.ts
@backend/shared/package.json
@backend/shared/tsconfig.json
@backend/shared/jest.config.js

<interfaces>
<!-- Existing shared package patterns the executor needs -->

From backend/shared/src/utils/logger.ts:
```typescript
export interface LoggerOptions {
  service: string;
  level?: string;
  enableSentry?: boolean;
  sentryDsn?: string;
  silent?: boolean;
}
export const createLogger = (options: LoggerOptions): winston.Logger => { ... };
```

From backend/shared/src/index.ts (export pattern):
```typescript
// Utilities section exports follow this pattern:
export {
  createLogger,
  defaultLogger,
  type LoggerOptions,
} from './utils/logger';
```

From pg (already in dependencies):
```typescript
import { Pool, PoolConfig } from 'pg';
// Pool is the class; PoolConfig is the options interface
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write createPool tests (RED phase)</name>
  <files>backend/shared/tests/db-pool.test.ts</files>
  <action>
Create test file `backend/shared/tests/db-pool.test.ts` that tests the `createPool()` factory function. Mock `pg` globally using `jest.mock('pg')`.

Test cases to write (all should FAIL since the source doesn't exist yet):

1. **Returns a Pool instance**: Call `createPool()` and verify `Pool` constructor was called and result is the mock pool.

2. **Uses DATABASE_URL from environment**: Set `process.env.DATABASE_URL = 'postgresql://test'`, call `createPool()`, verify Pool constructor received `connectionString: 'postgresql://test'`.

3. **Default connectionTimeoutMillis is 5000** (RESIL-02): Call `createPool()` without overrides, verify Pool constructor received `connectionTimeoutMillis: 5000`.

4. **Default max is 20**: Call `createPool()`, verify Pool constructor received `max: 20`.

5. **Default idleTimeoutMillis is 30000**: Call `createPool()`, verify Pool constructor received `idleTimeoutMillis: 30000`.

6. **Respects env var overrides**: Set `DATABASE_POOL_MAX=10`, `DATABASE_IDLE_TIMEOUT_MS=15000`, `DATABASE_CONNECTION_TIMEOUT_MS=3000`, call `createPool()`, verify constructor received those values.

7. **Attaches error handler that logs but does not crash** (RESIL-01): Call `createPool()`, verify `pool.on` was called with `'error'` and a callback. Simulate calling that callback with a fake error. Verify the logger's `error` method was called. Verify `process.exit` was NOT called.

8. **Attaches connect, acquire, and remove handlers**: Verify `pool.on` was called for each event type.

9. **SSL enabled for Railway URLs** (RESIL-03): Set `DATABASE_URL` to a string containing 'railway', verify Pool constructor received `ssl: { rejectUnauthorized: false }`.

10. **SSL disabled for non-Railway URLs**: Set `DATABASE_URL` to a string NOT containing 'railway', verify Pool constructor received `ssl: false`.

11. **Accepts connectionString override**: Call `createPool({ connectionString: 'custom://url' })`, verify it uses the override instead of env var.

12. **Accepts poolConfig overrides**: Call `createPool({ poolConfig: { max: 5 } })`, verify the override is applied (spread over defaults).

Mock setup pattern:
```typescript
const mockOn = jest.fn();
const mockPool = { query: jest.fn(), on: mockOn, connect: jest.fn(), end: jest.fn() };
jest.mock('pg', () => ({ Pool: jest.fn(() => mockPool) }));
```

Use `beforeEach` to clear mocks and save/restore env vars. Use `jest.spyOn(process, 'exit').mockImplementation()` to verify no crash on error.

Run tests: `cd backend/shared && npx jest tests/db-pool.test.ts` -- all tests should FAIL (module not found).
  </action>
  <verify>
    <automated>cd "C:/Users/dasbl/AndroidStudioProjects/VLVT/backend/shared" && npx jest tests/db-pool.test.ts --no-coverage 2>&1 | tail -5</automated>
  </verify>
  <done>Test file exists with 10+ test cases. All tests fail because `backend/shared/src/utils/db-pool.ts` does not exist yet (RED phase confirmed).</done>
</task>

<task type="auto">
  <name>Task 2: Implement createPool factory and make tests pass (GREEN phase)</name>
  <files>backend/shared/src/utils/db-pool.ts, backend/shared/src/index.ts</files>
  <action>
**Step 1: Create `backend/shared/src/utils/db-pool.ts`**

Implement the factory function following the research pattern (see 08-RESEARCH.md Code Examples section):

```typescript
import { Pool, PoolConfig } from 'pg';
import winston from 'winston';

export interface CreatePoolOptions {
  /** Override DATABASE_URL from env */
  connectionString?: string;
  /** Winston logger instance for pool events */
  logger?: winston.Logger;
  /** Override default pool config */
  poolConfig?: Partial<PoolConfig>;
}

export function createPool(options: CreatePoolOptions = {}): Pool {
  const {
    connectionString = process.env.DATABASE_URL,
    logger,
    poolConfig = {},
  } = options;

  const pool = new Pool({
    connectionString,
    max: parseInt(process.env.DATABASE_POOL_MAX || '20', 10),
    idleTimeoutMillis: parseInt(process.env.DATABASE_IDLE_TIMEOUT_MS || '30000', 10),
    connectionTimeoutMillis: parseInt(process.env.DATABASE_CONNECTION_TIMEOUT_MS || '5000', 10),
    // SEC-01-DOCUMENTED: rejectUnauthorized: false is acceptable for Railway's
    // internal private network with self-signed certs.
    ssl: connectionString?.includes('railway')
      ? { rejectUnauthorized: false }
      : false,
    ...poolConfig,
  });

  const log = logger ?? {
    info: console.log,
    debug: console.debug,
    error: console.error,
  };

  pool.on('connect', () => {
    log.info('New database connection established');
  });

  pool.on('acquire', () => {
    if (typeof log.debug === 'function') log.debug('Database client acquired from pool');
  });

  pool.on('remove', () => {
    if (typeof log.debug === 'function') log.debug('Database client removed from pool');
  });

  // RESIL-01: Log error and continue. pg-pool already removes the dead client
  // and will create a new one on the next connect()/query() call.
  pool.on('error', (err: Error) => {
    log.error('Unexpected error on idle database client', {
      error: err.message,
      stack: err.stack,
    });
  });

  return pool;
}
```

**Step 2: Add exports to `backend/shared/src/index.ts`**

Add these exports in the "Utilities" section (after the existing `AuditLogger` exports, before "Services"):

```typescript
// Database Pool Factory (RESIL-01, RESIL-02, RESIL-03)
export {
  createPool,
  type CreatePoolOptions,
} from './utils/db-pool';
```

**Step 3: Build the shared package**

Run `cd backend/shared && npm run build` to compile TypeScript to `dist/`. This must succeed for services to import from `@vlvt/shared`.

**Step 4: Run tests -- all should pass (GREEN phase)**

Run `cd backend/shared && npx jest tests/db-pool.test.ts` -- all tests should now PASS.

If any test fails, fix the implementation to match the test expectations. Do NOT modify tests to pass -- fix the source.
  </action>
  <verify>
    <automated>cd "C:/Users/dasbl/AndroidStudioProjects/VLVT/backend/shared" && npm run build 2>&1 | tail -3 && npx jest tests/db-pool.test.ts --no-coverage 2>&1 | tail -5</automated>
  </verify>
  <done>`createPool` factory function exists in `backend/shared/src/utils/db-pool.ts`, is re-exported from `index.ts`, builds without errors, and all tests pass. The pool uses 5000ms connection timeout by default (RESIL-02), attaches error handler that logs without crashing (RESIL-01), and centralizes all pool config (RESIL-03).</done>
</task>

</tasks>

<verification>
1. `cd backend/shared && npm run build` completes without errors
2. `cd backend/shared && npx jest tests/db-pool.test.ts` -- all tests pass
3. `cd backend/shared && npx jest` -- full test suite passes (no regressions)
4. `grep -n "createPool" backend/shared/src/index.ts` shows the export
5. `grep -n "connectionTimeoutMillis.*5000" backend/shared/src/utils/db-pool.ts` confirms RESIL-02
6. `grep -n "pool.on.*error" backend/shared/src/utils/db-pool.ts` confirms RESIL-01 error handler
7. No `process.exit` in `backend/shared/src/utils/db-pool.ts`
</verification>

<success_criteria>
- createPool() factory function exists and is exported from @vlvt/shared
- Default connectionTimeoutMillis is 5000 (RESIL-02)
- Error handler logs and continues, no process.exit (RESIL-01)
- Pool config centralized in one file (RESIL-03)
- All shared package tests pass (existing + new)
- Shared package builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/08-shared-backend-utilities/08-01-SUMMARY.md`
</output>
