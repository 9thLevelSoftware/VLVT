---
phase: 09-backend-service-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/auth-service/src/index.ts
autonomous: true
requirements:
  - RESIL-04
  - RESIL-07

must_haves:
  truths:
    - "Auth-service stops accepting new HTTP requests on SIGTERM before closing resources"
    - "Auth-service calls pool.end() during shutdown to drain database connections"
    - "Auth-service exits cleanly with code 0 after successful shutdown"
    - "Auth-service force-exits with code 1 after 10 seconds if shutdown hangs"
    - "Sending SIGTERM twice does not crash auth-service (guard flag prevents double pool.end())"
    - "Signal handlers are only registered when NODE_ENV !== 'test' (no interference with Jest)"
  artifacts:
    - path: "backend/auth-service/src/index.ts"
      provides: "gracefulShutdown function with guard flag, server.close, pool.end, 10s force-exit"
      contains: "gracefulShutdown"
    - path: "backend/auth-service/src/index.ts"
      provides: "http.Server reference captured from app.listen()"
      contains: "const server = app.listen"
  key_links:
    - from: "backend/auth-service/src/index.ts"
      to: "pool.end()"
      via: "gracefulShutdown calls pool.end() to drain DB connections"
      pattern: "await pool\\.end\\(\\)"
    - from: "backend/auth-service/src/index.ts"
      to: "server.close()"
      via: "gracefulShutdown calls server.close() to stop accepting new requests"
      pattern: "server\\.close\\("
    - from: "backend/auth-service/src/index.ts"
      to: "process.on('SIGTERM'|'SIGINT')"
      via: "Signal handlers registered inside NODE_ENV !== 'test' block"
      pattern: "process\\.on\\('SIGTERM'"
---

<objective>
Add graceful shutdown handling to auth-service so it cleanly stops on SIGTERM/SIGINT during Railway deployments.

Purpose: Auth-service currently has NO shutdown handler and does NOT capture the `http.Server` reference from `app.listen()`. When Railway sends SIGTERM during a deployment, the process crashes rather than draining in-flight requests and closing the database pool. This risks mid-request failures for users during deploys.

Output: Updated `backend/auth-service/src/index.ts` with a `gracefulShutdown()` function that captures the server reference, stops accepting requests, closes the pool, and force-exits after 10 seconds.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-backend-service-integration/09-RESEARCH.md

@backend/auth-service/src/index.ts

<interfaces>
<!-- Key types and contracts the executor needs. -->

The pool variable is already declared at module scope (line 155):
```typescript
const pool = createPool({ logger });
```

The app.listen block is inside initializeApp() (lines 3648-3653):
```typescript
// Only start server if not in test environment
if (process.env.NODE_ENV !== 'test') {
  app.listen(PORT, () => {
    logger.info(`Auth service started`, { port: PORT, environment: process.env.NODE_ENV || 'development' });
  });
}
```

The initializeApp function is called at module scope (lines 3656-3660):
```typescript
initializeApp().catch((error) => {
  logger.error('Failed to initialize application', { error });
  process.exit(1);
});
```

The logger is imported at module scope:
```typescript
import logger from './utils/logger';
```
</interfaces>

<current_code>
<!-- Exact code block to MODIFY in auth-service (lines 3648-3654) -->

```typescript
  // Only start server if not in test environment
  if (process.env.NODE_ENV !== 'test') {
    app.listen(PORT, () => {
      logger.info(`Auth service started`, { port: PORT, environment: process.env.NODE_ENV || 'development' });
    });
  }
}
```

This block must be replaced with the graceful shutdown implementation. The closing `}` belongs to the `initializeApp()` function.
</current_code>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add graceful shutdown handler to auth-service</name>
  <files>backend/auth-service/src/index.ts</files>
  <action>
Replace the `if (process.env.NODE_ENV !== 'test')` block inside `initializeApp()` (lines 3648-3654) with the graceful shutdown implementation.

**Replace this code (lines 3648-3653):**
```typescript
  // Only start server if not in test environment
  if (process.env.NODE_ENV !== 'test') {
    app.listen(PORT, () => {
      logger.info(`Auth service started`, { port: PORT, environment: process.env.NODE_ENV || 'development' });
    });
  }
```

**With this code:**
```typescript
  // Only start server if not in test environment
  if (process.env.NODE_ENV !== 'test') {
    let isShuttingDown = false;

    const server = app.listen(PORT, () => {
      logger.info('Auth service started', { port: PORT, environment: process.env.NODE_ENV || 'development' });
    });

    const gracefulShutdown = async (signal: string) => {
      if (isShuttingDown) {
        logger.warn(`Duplicate ${signal} received, shutdown already in progress`);
        return;
      }
      isShuttingDown = true;
      logger.info(`Received ${signal}, starting graceful shutdown...`);

      // Force exit after 10 seconds to prevent hung deployments
      const forceExitTimer = setTimeout(() => {
        logger.error('Graceful shutdown timed out after 10s, forcing exit');
        process.exit(1);
      }, 10000);
      forceExitTimer.unref(); // Don't keep process alive just for this timer

      // Stop accepting new HTTP requests, drain in-flight
      server.close(() => {
        logger.info('HTTP server closed');
      });

      // Close database pool (drains active clients)
      try {
        await pool.end();
        logger.info('Database pool closed');
      } catch (err) {
        logger.error('Error closing database pool', { error: (err as Error).message });
      }

      process.exit(0);
    };

    process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
    process.on('SIGINT', () => gracefulShutdown('SIGINT'));
  }
```

**Key points for the executor:**
1. The `const server = app.listen(...)` captures the http.Server reference that was previously discarded. This is REQUIRED for `server.close()`.
2. The `isShuttingDown` flag prevents double invocation of `pool.end()`, which throws `'Called end on pool more than once'` (pg-pool source line 452).
3. The `forceExitTimer.unref()` call is critical -- without it, the timer keeps the event loop alive and prevents natural termination.
4. Signal handlers are INSIDE the `if (process.env.NODE_ENV !== 'test')` block so they don't interfere with Jest test runners.
5. `pool` is a module-scope variable (line 155) and is accessible inside `initializeApp()`.
6. The shutdown order matters: stop HTTP first (server.close), then close pool. If pool closes before server drains, in-flight requests get "Cannot use a pool after calling end" errors.
  </action>
  <verify>
    <automated>cd "C:/Users/dasbl/AndroidStudioProjects/VLVT/backend/auth-service" && npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>Auth-service compiles. The `if (process.env.NODE_ENV !== 'test')` block now captures `server = app.listen(...)`, defines `gracefulShutdown()` with guard flag + server.close + pool.end + 10s force-exit, and registers SIGTERM/SIGINT handlers.</done>
</task>

<task type="auto">
  <name>Task 2: Verify auth-service tests pass with shutdown changes</name>
  <files>backend/auth-service/src/index.ts</files>
  <action>
Run the auth-service test suite to verify the shutdown handler addition doesn't break any existing tests.

```bash
cd backend/auth-service && npm test 2>&1 | tail -20
```

**Expected:** All existing tests pass. The shutdown handlers are inside `if (process.env.NODE_ENV !== 'test')`, so they should not execute during test runs.

**If tests fail:**
- If `pool.end is not a function` in test output: the mock may need updating. Check `backend/auth-service/tests/__mocks__/` or top-level mock setup.
- If `Cannot find module '@vlvt/shared'`: run `cd backend/shared && npm run build` first.
- If any test times out: check that no signal handler is leaking into test environment (the `NODE_ENV !== 'test'` guard should prevent this).

Also verify the shutdown code pattern by running these grep checks:
```bash
# Confirm server reference is captured
grep -n "const server = app.listen" backend/auth-service/src/index.ts

# Confirm guard flag exists
grep -n "isShuttingDown" backend/auth-service/src/index.ts

# Confirm pool.end is called
grep -n "pool.end()" backend/auth-service/src/index.ts

# Confirm force-exit timeout exists
grep -n "forceExitTimer" backend/auth-service/src/index.ts

# Confirm .unref() is called on timer
grep -n "\.unref()" backend/auth-service/src/index.ts
```
  </action>
  <verify>
    <automated>cd "C:/Users/dasbl/AndroidStudioProjects/VLVT/backend/auth-service" && npm test 2>&1 | tail -10</automated>
  </verify>
  <done>All auth-service tests pass. Grep checks confirm: server reference captured, guard flag present, pool.end() called, force-exit timer with .unref() present, SIGTERM/SIGINT handlers registered.</done>
</task>

</tasks>

<verification>
1. `grep -n "gracefulShutdown" backend/auth-service/src/index.ts` -- shows function definition and signal handler registrations
2. `grep -n "const server = app.listen" backend/auth-service/src/index.ts` -- shows server reference captured
3. `grep -n "isShuttingDown" backend/auth-service/src/index.ts` -- shows guard flag
4. `grep -n "pool.end()" backend/auth-service/src/index.ts` -- shows pool cleanup
5. `grep -n "forceExitTimer" backend/auth-service/src/index.ts` -- shows 10s timeout
6. `grep -n ".unref()" backend/auth-service/src/index.ts` -- shows timer won't keep process alive
7. Auth-service compiles: `cd backend/auth-service && npx tsc --noEmit`
8. Auth-service tests pass: `cd backend/auth-service && npm test`
</verification>

<success_criteria>
- Auth-service has a `gracefulShutdown()` function inside the `if (NODE_ENV !== 'test')` block
- `app.listen()` return value is captured as `const server`
- Guard flag (`isShuttingDown`) prevents double invocation
- Shutdown order: server.close() -> pool.end() -> process.exit(0)
- 10-second force-exit timer with `.unref()` prevents hung shutdowns
- SIGTERM and SIGINT both trigger gracefulShutdown
- All existing auth-service tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-backend-service-integration/09-01-SUMMARY.md`
</output>
