# Milestone v1.0: After Hours Mode

**Status:** SHIPPED 2026-01-24
**Phases:** 1-7
**Total Plans:** 28

## Overview

After Hours Mode is a premium, time-boxed feature for spontaneous connections. Users activate a session, set preferences, and get auto-matched with nearby users also in After Hours mode. Matches pop up as profile cards; users can instantly chat or decline. Ephemeral by default, with mutual save to convert to permanent match.

## Phases

### Phase 1: Foundation & Safety

**Goal**: Establish data layer and privacy utilities that must be correct from day one
**Depends on**: None
**Plans**: 3 plans

Plans:
- [x] 01-01: Database migration for After Hours tables and GDPR consent
- [x] 01-02: Location fuzzing utility for privacy protection
- [x] 01-03: After Hours authorization middleware (premium + verified + consent)

**Details:**
- Created 6 After Hours tables (profiles, preferences, sessions, declines, matches, messages)
- Server-side location fuzzing: 500m jitter + 3 decimal place rounding
- Triple-gated middleware: requirePremium + requireVerified + requireConsent

---

### Phase 2: Profile & Session Management

**Goal**: Users can create After Hours profiles, set preferences, and start/end sessions
**Depends on**: Phase 1
**Plans**: 3 plans

Plans:
- [x] 02-01: After Hours profile CRUD with photo upload
- [x] 02-02: After Hours preferences CRUD with smart defaults
- [x] 02-03: Session lifecycle with BullMQ expiry

**Details:**
- Separate After Hours profile storage (dedicated photo + description)
- Smart preference defaults inherited from main profile
- BullMQ delayed jobs for automatic session expiry

---

### Phase 3: Matching Engine

**Goal**: System automatically matches active users by proximity and preferences
**Depends on**: Phase 2
**Plans**: 4 plans

Plans:
- [x] 03-01: Schema additions and core matching query logic
- [x] 03-02: BullMQ matching scheduler (periodic + event-driven)
- [x] 03-03: Decline, current match, and nearby count endpoints
- [x] 03-04: Auto-decline timer and match expiry handling

**Details:**
- Haversine proximity calculation with LEAST/GREATEST wrapper for float precision
- SKIP LOCKED concurrency for race-free match creation
- 3-decline memory per user pair (resets after threshold)
- 5-minute auto-decline timer with re-matching

---

### Phase 4: Real-Time Chat

**Goal**: Matched users can chat instantly with ephemeral messages
**Depends on**: Phase 3
**Plans**: 4 plans

Plans:
- [x] 04-01: Redis pub/sub subscriber and After Hours Socket.IO handlers
- [x] 04-02: Ephemeral message handlers and HTTP history endpoint
- [x] 04-03: 30-day message retention cleanup and session expiry notifications
- [x] 04-04: Flutter socket events and chat service

**Details:**
- Redis pub/sub for cross-service match event delivery
- Socket.IO rooms per match for multi-device support
- 30-day server-side message retention for moderation compliance
- 2-minute warning before session expiry

---

### Phase 5: Save Mechanism & Conversion

**Goal**: Both users can "Save" to convert ephemeral connection to permanent match
**Depends on**: Phase 4
**Plans**: 3 plans

Plans:
- [x] 05-01: Backend save endpoint with atomic conversion and notifications
- [x] 05-02: Flutter save button and service integration
- [x] 05-03: Gap closure: Wire Socket.IO to After Hours router

**Details:**
- SELECT...FOR UPDATE locking for race-free save votes
- Atomic message copy from ephemeral to permanent table
- Real-time Socket.IO + FCM push notifications for save events

---

### Phase 6: Frontend Integration

**Goal**: Complete Flutter UI for After Hours Mode
**Depends on**: Phases 1-5
**Plans**: 6 plans

Plans:
- [x] 06-01: AfterHoursService state machine and tab navigation
- [x] 06-02: After Hours profile and preferences screens
- [x] 06-03: Session activation flow and timer widgets
- [x] 06-04: Match card overlay with swipe gestures
- [x] 06-05: Ephemeral chat screen and background location
- [x] 06-06: Gap closure: API integration, provider registration, foreground task

**Details:**
- 7-state session lifecycle (inactive, activating, searching, matched, chatting, expiring, expired)
- ChangeNotifierProxyProvider2 for multi-service dependencies
- Swipe gestures for match card accept/decline
- flutter_foreground_task for Android 14+ background location compliance

---

### Phase 7: Safety Systems & Polish

**Goal**: Production-ready safety features and operational polish
**Depends on**: Phase 6
**Plans**: 5 plans

Plans:
- [x] 07-01: Backend block and report endpoints for After Hours
- [x] 07-02: Device fingerprinting and photo perceptual hashing
- [x] 07-03: Session cleanup jobs (BullMQ)
- [x] 07-04: Frontend quick report flow with auto-exit
- [x] 07-05: Analytics events for After Hours funnel

**Details:**
- Permanent blocks apply bidirectionally (After Hours + main app)
- Device fingerprint storage for ban enforcement
- Photo perceptual hashing with 10-bit hamming threshold
- Quick report dialog with reason chips and auto-exit

---

## Milestone Summary

**Key Decisions:**

- VARCHAR(255) for user_id FKs matching existing users.id type
- Separate exact/fuzzed coordinates stored at session creation
- Redis pub/sub for match events (NOT Socket.IO in profile-service)
- LEAST/GREATEST wrapper for acos to prevent domain errors
- Batch message copy with generated IDs preserves chronological order
- 7-state enum for session lifecycle
- Reason prefix after_hours: for report source tracking

**Issues Resolved:**

- Floating point precision in Haversine causing NaN (LEAST/GREATEST wrapper)
- Race conditions in match creation (SKIP LOCKED + transaction)
- Socket.IO io variable undefined at registration (deferred registration)
- Reports table lacks source column (reason prefix pattern)

**Issues Deferred:**

- iOS background location limitations (documented, may need push workaround)
- Interests/tags system (defer to v1.1)
- Video verification for After Hours (defer to v1.1)

**Technical Debt Incurred:**

- None blocking (4 informational items in audit)

---

*For current project status, see .planning/PROJECT.md*
*Archived: 2026-01-24 as part of v1.0 milestone completion*
