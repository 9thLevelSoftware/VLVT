---
phase: 05-save-mechanism-conversion
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/chat-service/src/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Real-time Socket.IO events emitted when user saves After Hours match"
    - "Partner receives partner_saved event instantly"
    - "Both users receive match_saved event on mutual save"
  artifacts:
    - path: "backend/chat-service/src/index.ts"
      provides: "After Hours router with Socket.IO wired"
      contains: "createAfterHoursChatRouter(pool, io)"
  key_links:
    - from: "backend/chat-service/src/routes/after-hours-chat.ts"
      to: "Socket.IO server"
      via: "io parameter passed from index.ts"
      pattern: "createAfterHoursChatRouter\\(pool,\\s*io\\)"
---

<objective>
Fix Socket.IO wiring for After Hours save notifications

Purpose: The After Hours router was registered before Socket.IO initialization, causing the `io` parameter to be undefined. Save notifications silently fail because `if (io)` checks evaluate to false.

Output: Working real-time notifications when users save After Hours matches.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-save-mechanism-conversion/05-VERIFICATION.md

# Gap Analysis
The verification report identified a critical wiring issue:
- Router registered at line 1056: `createAfterHoursChatRouter(pool)` - no io parameter
- Socket.IO created at line 1547: `const io = initializeSocketIO(httpServer, pool)`
- Result: `io` is undefined in save endpoint, notifications never emit

# Fix Strategy
Move After Hours router registration AFTER line 1547 and pass `io` as second parameter.
The router factory already accepts optional `io?: SocketServer` - just needs to be wired.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move After Hours router registration after Socket.IO init</name>
  <files>backend/chat-service/src/index.ts</files>
  <action>
Relocate the After Hours chat router registration from line 1056 to AFTER the Socket.IO initialization at line 1547.

Current (line 1056):
```typescript
app.use(authMiddleware, generalLimiter, createAfterHoursChatRouter(pool));
```

Move to after line 1547 (after `const io = initializeSocketIO(httpServer, pool);`):
```typescript
// After Hours chat routes - registered after io init to enable real-time notifications
app.use(authMiddleware, generalLimiter, createAfterHoursChatRouter(pool, io));
```

Important:
- Remove the existing registration at line 1056
- Keep the same middleware chain (authMiddleware, generalLimiter)
- Add `io` as second parameter to `createAfterHoursChatRouter`
- Place after io initialization but before server.listen

This is a single-line move with parameter addition. No logic changes.
  </action>
  <verify>
1. `npm run build` in backend/chat-service succeeds (TypeScript compiles)
2. Grep confirms new location: `grep -n "createAfterHoursChatRouter(pool, io)" backend/chat-service/src/index.ts`
3. Grep confirms old location removed: `grep -n "createAfterHoursChatRouter(pool)" backend/chat-service/src/index.ts` returns only the new line with `io`
  </verify>
  <done>
After Hours router registered after Socket.IO initialization with `io` parameter passed. Real-time save notifications will now emit via Socket.IO.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd backend/chat-service && npm run build`
2. Pattern verification: grep for `createAfterHoursChatRouter(pool, io)` in index.ts
3. Verify io defined: The router registration now appears AFTER `initializeSocketIO` call
</verification>

<success_criteria>
- [ ] Build succeeds without TypeScript errors
- [ ] Router registration appears AFTER `const io = initializeSocketIO(httpServer, pool)`
- [ ] Router call includes `io` parameter: `createAfterHoursChatRouter(pool, io)`
- [ ] No duplicate router registrations exist
</success_criteria>

<output>
After completion, create `.planning/phases/05-save-mechanism-conversion/05-03-SUMMARY.md`
</output>
