---
phase: 08-shared-backend-utilities
plan: 02
type: execute
wave: 2
depends_on:
  - "08-01"
files_modified:
  - backend/auth-service/src/index.ts
  - backend/profile-service/src/index.ts
  - backend/chat-service/src/index.ts
autonomous: true
requirements:
  - RESIL-01
  - RESIL-02
  - RESIL-03

must_haves:
  truths:
    - "auth-service creates its pool via createPool() from @vlvt/shared instead of inline new Pool()"
    - "profile-service creates its pool via createPool() from @vlvt/shared instead of inline new Pool()"
    - "chat-service creates its pool via createPool() from @vlvt/shared instead of inline new Pool()"
    - "No service file contains inline pool configuration (connectionTimeoutMillis, idleTimeoutMillis, max, ssl) -- all comes from the shared factory"
    - "All existing service tests continue to pass"
  artifacts:
    - path: "backend/auth-service/src/index.ts"
      provides: "Pool created via createPool({ logger })"
      contains: "createPool"
    - path: "backend/profile-service/src/index.ts"
      provides: "Pool created via createPool({ logger })"
      contains: "createPool"
    - path: "backend/chat-service/src/index.ts"
      provides: "Pool created via createPool({ logger })"
      contains: "createPool"
  key_links:
    - from: "backend/auth-service/src/index.ts"
      to: "@vlvt/shared"
      via: "import { createPool }"
      pattern: "import.*createPool.*from.*@vlvt/shared"
    - from: "backend/profile-service/src/index.ts"
      to: "@vlvt/shared"
      via: "import { createPool }"
      pattern: "import.*createPool.*from.*@vlvt/shared"
    - from: "backend/chat-service/src/index.ts"
      to: "@vlvt/shared"
      via: "import { createPool }"
      pattern: "import.*createPool.*from.*@vlvt/shared"
---

<objective>
Replace all three services' inline pool configurations with a single `createPool()` import from `@vlvt/shared`.

Purpose: Complete the centralization of pool configuration (RESIL-03) by removing the duplicated ~30 lines of pool setup from each service and replacing with a 1-line factory call. This ensures all services automatically get the resilient 5s timeout (RESIL-02) and error handling (RESIL-01) from the shared factory.

Output: Three updated `index.ts` files, each using `createPool({ logger })` instead of inline `new Pool({...})` + event handlers.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-shared-backend-utilities/08-RESEARCH.md
@.planning/phases/08-shared-backend-utilities/08-01-SUMMARY.md

@backend/auth-service/src/index.ts
@backend/profile-service/src/index.ts
@backend/chat-service/src/index.ts

<interfaces>
<!-- From Plan 08-01 output (createPool factory) -->

From backend/shared/src/utils/db-pool.ts:
```typescript
export interface CreatePoolOptions {
  /** Override DATABASE_URL from env */
  connectionString?: string;
  /** Winston logger instance for pool events */
  logger?: winston.Logger;
  /** Override default pool config */
  poolConfig?: Partial<PoolConfig>;
}

export function createPool(options: CreatePoolOptions = {}): Pool;
```

Imported as:
```typescript
import { createPool } from '@vlvt/shared';
```
</interfaces>

<current_code>
<!-- Exact code blocks to REMOVE from each service (identical in all three) -->

REMOVE this import:
```typescript
import { Pool } from 'pg';
```

REMOVE the pool creation block (lines vary per service, but content is identical):
```typescript
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: parseInt(process.env.DATABASE_POOL_MAX || '20', 10),
  idleTimeoutMillis: parseInt(process.env.DATABASE_IDLE_TIMEOUT_MS || '30000', 10),
  connectionTimeoutMillis: parseInt(process.env.DATABASE_CONNECTION_TIMEOUT_MS || '2000', 10),
  ssl: process.env.DATABASE_URL?.includes('railway')
    ? { rejectUnauthorized: false }
    : false,
});
```

REMOVE the event handlers block:
```typescript
// Database connection event handlers
pool.on('connect', (client) => {
  logger.info('New database connection established');
});

pool.on('acquire', (client) => {
  logger.debug('Database client acquired from pool');
});

pool.on('remove', (client) => {
  logger.debug('Database client removed from pool');
});

pool.on('error', (err, client) => {
  logger.error('Unexpected database connection error', {
    error: err.message,
    stack: err.stack
  });
});
```

REPLACE with:
```typescript
import { createPool } from '@vlvt/shared';
// ...
const pool = createPool({ logger });
```
</current_code>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace inline pool config in all three services</name>
  <files>backend/auth-service/src/index.ts, backend/profile-service/src/index.ts, backend/chat-service/src/index.ts</files>
  <action>
For each of the three service files (`auth-service/src/index.ts`, `profile-service/src/index.ts`, `chat-service/src/index.ts`), make these exact changes:

**1. Update imports:**
- REMOVE: `import { Pool } from 'pg';`
- ADD: `import { createPool } from '@vlvt/shared';`
  - Place it with the other `@vlvt/shared` imports if they exist, or near the top imports section.
  - If the service already imports other things from `@vlvt/shared`, add `createPool` to that existing import statement.

**2. Replace pool creation:**
- REMOVE: The entire `const pool = new Pool({...});` block (including the SSL/security comments above it -- the 2-line security reference and SEC-01-DOCUMENTED comment).
- REMOVE: All four `pool.on(...)` event handler blocks (`connect`, `acquire`, `remove`, `error`).
- REPLACE with single line: `const pool = createPool({ logger });`
- Place the `const pool = createPool({ logger })` line where the old `new Pool()` call was. The variable name `pool` must stay the same since the rest of each service references it.

**3. Verify no other Pool imports remain:**
- `grep "from 'pg'" {service}/src/index.ts` should return nothing.
- The `pool` variable is still used throughout the service (passed to routes, middleware, etc.) -- do NOT change any of those references.

**Important:** Each service's `logger` import already exists (e.g., `import logger from './utils/logger'`). The `createPool({ logger })` call uses this existing service logger. Do not add a new logger import.

**4. Rebuild shared package if needed:**
- Run `cd backend/shared && npm run build` to ensure `dist/` is up to date before testing services.

**5. Build each service to verify TypeScript compiles:**
- `cd backend/auth-service && npx tsc --noEmit`
- `cd backend/profile-service && npx tsc --noEmit`
- `cd backend/chat-service && npx tsc --noEmit`

If any service has TypeScript errors after the change, fix them. Common issues:
- If `Pool` type is used elsewhere in the file (e.g., as a type annotation), add `import type { Pool } from 'pg'` back as a type-only import.
- If service doesn't already import from `@vlvt/shared`, add the import.
  </action>
  <verify>
    <automated>cd "C:/Users/dasbl/AndroidStudioProjects/VLVT" && for svc in auth-service profile-service chat-service; do echo "=== $svc ===" && cd "backend/$svc" && npx tsc --noEmit 2>&1 | tail -3 && cd "../.."; done</automated>
  </verify>
  <done>All three services import `createPool` from `@vlvt/shared`. No service contains inline `new Pool({...})` configuration. No service contains `pool.on('connect'|'acquire'|'remove'|'error')` handlers. All three services compile without TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Run all service test suites to verify no regressions</name>
  <files>backend/auth-service/src/index.ts, backend/profile-service/src/index.ts, backend/chat-service/src/index.ts</files>
  <action>
Run the test suite for each service to ensure the pool replacement doesn't break existing functionality.

**Step 1: Run shared package tests first (confirm Plan 01 still passes)**
```bash
cd backend/shared && npx jest --no-coverage 2>&1 | tail -10
```

**Step 2: Run each service's test suite**
```bash
cd backend/auth-service && npm test 2>&1 | tail -15
cd backend/profile-service && npm test 2>&1 | tail -15
cd backend/chat-service && npm test 2>&1 | tail -15
```

**Expected:** All tests pass. The existing `jest.mock('pg', ...)` pattern in service tests works because Jest replaces the `pg` module globally regardless of which package imports it (see 08-RESEARCH.md Pitfall 5).

**If tests fail:**
- If `Cannot find module '@vlvt/shared'` -- run `cd backend/shared && npm run build` first
- If `createPool is not a function` -- check that `backend/shared/src/index.ts` exports `createPool` and `dist/` is rebuilt
- If Pool mock not applied -- the existing `jest.mock('pg')` should still work; check that no test file explicitly mocks `@vlvt/shared` in a conflicting way
- If type errors in tests -- add `import type { Pool } from 'pg'` if tests reference the Pool type

**Step 3: Verify centralization is complete**
Run these grep commands to confirm no inline pool config remains:
```bash
grep -rn "new Pool(" backend/auth-service/src/ backend/profile-service/src/ backend/chat-service/src/
grep -rn "connectionTimeoutMillis" backend/auth-service/src/ backend/profile-service/src/ backend/chat-service/src/
grep -rn "idleTimeoutMillis" backend/auth-service/src/ backend/profile-service/src/ backend/chat-service/src/
```
All three grep commands should return NO results from service source files.
  </action>
  <verify>
    <automated>cd "C:/Users/dasbl/AndroidStudioProjects/VLVT" && echo "=== shared ===" && cd backend/shared && npx jest --no-coverage 2>&1 | tail -5 && cd ../.. && for svc in auth-service profile-service chat-service; do echo "=== $svc ===" && cd "backend/$svc" && npm test 2>&1 | tail -5 && cd "../.."; done</automated>
  </verify>
  <done>All test suites pass: shared package, auth-service, profile-service, chat-service. No inline pool configuration remains in any service. The centralization is complete.</done>
</task>

</tasks>

<verification>
1. `grep -rn "createPool" backend/auth-service/src/index.ts backend/profile-service/src/index.ts backend/chat-service/src/index.ts` -- all three show `createPool` import and usage
2. `grep -rn "new Pool(" backend/auth-service/src/index.ts backend/profile-service/src/index.ts backend/chat-service/src/index.ts` -- returns NOTHING (no inline pool config)
3. `grep -rn "pool.on(" backend/auth-service/src/index.ts backend/profile-service/src/index.ts backend/chat-service/src/index.ts` -- returns NOTHING (handlers moved to shared)
4. All service test suites pass
5. All services compile with `npx tsc --noEmit`
</verification>

<success_criteria>
- All three services use `createPool({ logger })` from @vlvt/shared
- No inline pool configuration (new Pool, connectionTimeoutMillis, pool.on) in any service
- All existing service tests pass without modification
- TypeScript compilation succeeds for all services
</success_criteria>

<output>
After completion, create `.planning/phases/08-shared-backend-utilities/08-02-SUMMARY.md`
</output>
