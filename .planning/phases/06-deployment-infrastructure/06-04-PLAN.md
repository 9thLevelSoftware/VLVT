---
phase: 06-deployment-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - docs/BACKUP_CONFIGURATION.md
autonomous: false

must_haves:
  truths:
    - "PostgreSQL database is backed up daily to R2"
    - "Backup service runs on Railway with cron schedule"
    - "30-day retention is enforced via R2 lifecycle rules"
  artifacts:
    - path: "docs/BACKUP_CONFIGURATION.md"
      provides: "Backup service configuration guide"
      contains: "postgres-s3-backups"
  key_links:
    - from: "Railway backup-service"
      to: "R2 vlvt-backups bucket"
      via: "S3-compatible API"
      pattern: "AWS_S3_ENDPOINT"

user_setup:
  - service: cloudflare-r2
    why: "Backup storage with 30-day retention"
    env_vars:
      - name: AWS_ACCESS_KEY_ID
        source: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens"
      - name: AWS_SECRET_ACCESS_KEY
        source: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens"
      - name: AWS_S3_BUCKET
        value: "vlvt-backups"
        source: "Create new bucket in R2 for backups"
      - name: AWS_S3_ENDPOINT
        source: "https://{ACCOUNT_ID}.r2.cloudflarestorage.com"
    dashboard_config:
      - task: "Create vlvt-backups bucket"
        location: "Cloudflare Dashboard -> R2 -> Create Bucket"
      - task: "Configure object lifecycle rule for 30-day retention"
        location: "Cloudflare Dashboard -> R2 -> vlvt-backups -> Settings -> Object Lifecycle"
  - service: railway
    why: "Deploy backup service with cron scheduling"
    dashboard_config:
      - task: "Deploy postgres-s3-backups template as new service"
        location: "Railway -> New -> Template -> postgres-s3-backups"
      - task: "Configure cron schedule: 0 3 * * *"
        location: "Railway -> backup-service -> Settings -> Cron Schedule"
---

<objective>
Configure automated PostgreSQL database backups to Cloudflare R2 using Railway's official backup template.

Purpose: DEP-01 requires daily backups to R2 with 30-day retention. This plan documents the Railway backup service configuration and guides user through setup.

Output: BACKUP_CONFIGURATION.md with complete setup guide, user-verified Railway backup service deployment
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-deployment-infrastructure/06-RESEARCH.md
@.planning/phases/06-deployment-infrastructure/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Backup Configuration Documentation</name>
  <files>docs/BACKUP_CONFIGURATION.md</files>
  <action>
Create comprehensive backup configuration documentation:

```markdown
# PostgreSQL Backup Configuration

## Overview

VLVT uses Railway's official `postgres-s3-backups` template for automated daily database backups to Cloudflare R2. Backups are compressed with gzip and retained for 30 days.

## Architecture

```
PostgreSQL (Railway) --> Backup Service (Railway Cron) --> R2 (Cloudflare)
                               |
                         Daily 3 AM UTC
```

**Components:**
- **Source:** PostgreSQL database on Railway
- **Backup Service:** Railway template running pg_dump on cron schedule
- **Storage:** Cloudflare R2 bucket (vlvt-backups)
- **Retention:** 30 days via R2 lifecycle rules

## Railway Backup Service

### Template
Deploy from: https://railway.app/template/postgres-s3-backups

Or search "postgres-s3-backups" in Railway templates.

### Environment Variables

| Variable | Value | Secret | Notes |
|----------|-------|--------|-------|
| AWS_ACCESS_KEY_ID | (R2 API token) | YES | From R2 API Tokens |
| AWS_SECRET_ACCESS_KEY | (R2 secret) | YES | From R2 API Tokens |
| AWS_S3_BUCKET | vlvt-backups | NO | Separate bucket for backups |
| AWS_S3_ENDPOINT | https://{ACCOUNT_ID}.r2.cloudflarestorage.com | NO | R2 endpoint URL |
| AWS_S3_REGION | auto | NO | R2 uses 'auto' |
| AWS_S3_FORCE_PATH_STYLE | true | NO | Required for R2 |
| BACKUP_DATABASE_URL | ${{Postgres.DATABASE_URL}} | YES | Railway reference syntax |
| BACKUP_CRON_SCHEDULE | 0 3 * * * | NO | Daily at 3 AM UTC |
| RUN_ON_STARTUP | false | NO | Prevent backup on every deploy |
| BACKUP_FILE_PREFIX | vlvt_backup_ | NO | Filename prefix |

### Cron Schedule

- **Schedule:** `0 3 * * *` (daily at 3 AM UTC)
- **Off-peak hours:** 3 AM UTC is ~7 PM PST / 10 PM EST
- **Minimum interval:** Railway cron minimum is 5 minutes

## Cloudflare R2 Configuration

### Bucket Setup

1. Create bucket named `vlvt-backups`
2. Configure object lifecycle for 30-day retention:
   - Go to bucket Settings -> Object Lifecycle
   - Add rule: "Delete objects older than 30 days"
   - Applies to: All objects (or prefix `vlvt_backup_`)

### API Credentials

Can reuse existing R2 credentials from profile-service if permissions allow, or create dedicated backup credentials:

1. Go to R2 -> Manage R2 API Tokens
2. Create API Token with:
   - Permissions: Object Read & Write
   - Bucket: vlvt-backups (specific bucket, not all)
   - TTL: No expiration (or long expiration with rotation)

### R2 Endpoint Format

Format: `https://{ACCOUNT_ID}.r2.cloudflarestorage.com`

Get Account ID from: Cloudflare Dashboard -> R2 (shown in URL or sidebar)

## Backup File Format

Files are stored as: `vlvt_backup_YYYY-MM-DD_HH-MM-SS.sql.gz`

Example: `vlvt_backup_2026-01-25_03-00-00.sql.gz`

## Monitoring

### Health Check

The backup service exposes a health endpoint. Configure uptime monitoring on:
`https://backup-service.railway.app/health`

### Success Verification

1. **R2 Console:** Check vlvt-backups bucket for new files after 3 AM UTC
2. **Railway Logs:** Check backup-service logs for completion messages
3. **File Size:** Verify backup file size is reasonable (not 0 bytes)

### Failure Alerts

Configure alerts for:
- Backup service unhealthy (uptime monitor)
- No new backup file in 25 hours (manual check or script)
- Backup file size anomaly (manual check)

## Security

- Backup files are compressed but NOT encrypted at rest beyond R2's default encryption
- Consider enabling R2 encryption if handling sensitive data exports
- Database credentials only accessible to backup service

## Cost Estimate

R2 pricing (as of 2026):
- Storage: $0.015/GB/month
- Class A operations (writes): $4.50 per million
- Class B operations (reads): $0.36 per million

Estimated for VLVT beta:
- Database ~100MB compressed = ~0.1GB
- 30 days retention = ~3GB storage = ~$0.05/month
- 30 backups/month = negligible operation cost

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| Backup fails with "Access Denied" | Wrong R2 credentials or bucket | Verify AWS_* env vars match R2 console |
| "Bucket not found" | Wrong endpoint or bucket name | Check AWS_S3_ENDPOINT format includes account ID |
| Empty backup file | pg_dump failed | Check BACKUP_DATABASE_URL is valid |
| Backup not running | Cron misconfigured | Verify BACKUP_CRON_SCHEDULE format |
| Version mismatch | pg_dump version | Template auto-detects; report issue if persists |
```
  </action>
  <verify>
- File exists: docs/BACKUP_CONFIGURATION.md
- Document includes Railway template reference
- Document includes R2 lifecycle configuration
- Document includes all required environment variables
  </verify>
  <done>Backup configuration comprehensively documented with setup guide and troubleshooting</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Backup configuration documentation. Now need to deploy the actual backup service on Railway and configure R2.</what-built>
  <how-to-verify>
**Step 1: Create R2 Backup Bucket**

1. Go to Cloudflare Dashboard -> R2
2. Click "Create Bucket"
3. Name: `vlvt-backups`
4. Location hint: Automatic (or closest to Railway region)
5. Create Bucket

**Step 2: Configure R2 Lifecycle Rule**

1. Click on `vlvt-backups` bucket
2. Go to Settings -> Object Lifecycle
3. Add Rule:
   - Description: "30-day retention"
   - Filter: All objects (or prefix `vlvt_backup_`)
   - Action: Delete
   - Days after upload: 30
4. Save

**Step 3: Get or Create R2 API Token**

1. Go to R2 -> Manage R2 API Tokens
2. Create API Token (or use existing):
   - Token name: "VLVT Backup Service"
   - Permissions: Object Read & Write
   - Specify bucket: vlvt-backups
3. Copy Access Key ID and Secret Access Key
4. Note your Account ID (from R2 dashboard URL or sidebar)

**Step 4: Deploy Railway Backup Service**

1. Go to Railway project
2. Click "New" -> "Template"
3. Search "postgres-s3-backups"
4. Deploy template (creates new service in your project)

**Step 5: Configure Backup Service Environment**

In Railway -> backup-service -> Variables, add:
- AWS_ACCESS_KEY_ID = (from Step 3)
- AWS_SECRET_ACCESS_KEY = (from Step 3)
- AWS_S3_BUCKET = vlvt-backups
- AWS_S3_ENDPOINT = https://{ACCOUNT_ID}.r2.cloudflarestorage.com
- AWS_S3_REGION = auto
- AWS_S3_FORCE_PATH_STYLE = true
- BACKUP_DATABASE_URL = ${{Postgres.DATABASE_URL}}
- BACKUP_CRON_SCHEDULE = 0 3 * * *
- RUN_ON_STARTUP = false
- BACKUP_FILE_PREFIX = vlvt_backup_

**Step 6: Configure Cron Schedule**

1. Go to Railway -> backup-service -> Settings
2. Find "Cron Schedule" section
3. Set: `0 3 * * *` (daily at 3 AM UTC)
4. Save

**Step 7: Verify Setup**

1. Check backup-service deployment succeeded
2. Optional: Temporarily change RUN_ON_STARTUP=true to trigger immediate backup
3. Check R2 bucket for backup file
4. Revert RUN_ON_STARTUP=false
  </how-to-verify>
  <resume-signal>Type "backup configured" when backup service is deployed and first backup verified, or "skip" to configure later</resume-signal>
</task>

</tasks>

<verification>
- [ ] BACKUP_CONFIGURATION.md created with complete setup guide
- [ ] R2 bucket created with 30-day lifecycle rule
- [ ] Railway backup service deployed with correct environment variables
- [ ] Cron schedule configured for daily 3 AM UTC
- [ ] At least one successful backup in R2 bucket
</verification>

<success_criteria>
DEP-01: PostgreSQL database is backed up daily to R2 with 30-day retention
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployment-infrastructure/06-04-SUMMARY.md`
</output>
