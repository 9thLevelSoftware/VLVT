---
phase: 06-deployment-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/ENVIRONMENT_VARIABLES.md
  - docs/SECRETS_MANAGEMENT.md
autonomous: true

must_haves:
  truths:
    - "All environment variables are documented with purpose, source, and secret classification"
    - "No secrets exist in source code (verified by grep for hardcoded patterns)"
    - "Cross-service variables are identified for Railway shared variable configuration"
  artifacts:
    - path: "docs/ENVIRONMENT_VARIABLES.md"
      provides: "Complete environment variable audit for all services"
      contains: "auth-service"
    - path: "docs/SECRETS_MANAGEMENT.md"
      provides: "Railway configuration guide for secrets"
      contains: "Railway shared variables"
  key_links:
    - from: "docs/ENVIRONMENT_VARIABLES.md"
      to: "Railway configuration"
      via: "Documents all required env vars"
      pattern: "SECRET|KEY|TOKEN"
---

<objective>
Complete environment variable audit and secrets management documentation for all backend services.

Purpose: DEP-02 requires documented environment variables; DEP-03 requires no secrets in source code. This plan audits all services and creates comprehensive documentation for production configuration.

Output: Two documentation files - ENVIRONMENT_VARIABLES.md (complete audit) and SECRETS_MANAGEMENT.md (Railway-specific configuration guide)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-deployment-infrastructure/06-RESEARCH.md
@backend/auth-service/.env.example
@backend/profile-service/.env.example
@backend/chat-service/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Environment Variable Audit Document</name>
  <files>docs/ENVIRONMENT_VARIABLES.md</files>
  <action>
Create comprehensive environment variable documentation by:

1. Scan all .env.example files and source code for process.env references
2. Create table format with columns: Variable | Service | Required | Secret | Description | Source
3. Organize by service (auth-service, profile-service, chat-service, backup-service NEW)
4. Mark variables as:
   - SECRET (yes/no) - determines if needs Railway sealed variable
   - Required (yes/no/conditional)
   - Source - where to get the value (Railway dashboard, Firebase console, etc.)

Include sections:
- Overview (purpose of document)
- Cross-Service Variables (JWT_SECRET, DATABASE_URL, SENTRY_DSN)
- Service-Specific Variables (organized by service)
- New Variables for Phase 6 (backup service, email, Apple web flow)
- Environment Differences (dev vs staging vs production)

Verify no hardcoded secrets by grepping for patterns:
- Strings that look like API keys (40+ char alphanumeric)
- Strings with "sk_" or "pk_" prefixes (Stripe-style)
- Strings matching JWT patterns

Cross-reference with RESEARCH.md environment audit preview for completeness.
  </action>
  <verify>
- docs/ENVIRONMENT_VARIABLES.md exists
- Document covers all 3 existing services + backup-service
- All variables from .env.example files are documented
- Grep for hardcoded secrets returns no results: `grep -rE "(sk_live|pk_live|AKIA[A-Z0-9]{16})" backend/*/src/`
  </verify>
  <done>Every environment variable is documented with service, required status, secret classification, and source</done>
</task>

<task type="auto">
  <name>Task 2: Secrets Management Guide</name>
  <files>docs/SECRETS_MANAGEMENT.md</files>
  <action>
Create Railway-specific secrets management documentation:

1. **Railway Shared Variables** - List variables that must be identical across services:
   - JWT_SECRET (CRITICAL - must match auth/profile/chat)
   - DATABASE_URL (Railway reference syntax: ${{Postgres.DATABASE_URL}})
   - SENTRY_DSN (all services)

2. **Railway Sealed Variables** - Explain how to mark sensitive values:
   - When to use sealed variables (API keys, tokens)
   - How to configure in Railway dashboard

3. **Service-Specific Secrets** - Document per-service:
   - auth-service: KYCAID_API_TOKEN, KYCAID_ENCRYPTION_KEY, Apple keys (DEP-06)
   - profile-service: R2 credentials, AWS credentials
   - chat-service: GOOGLE_APPLICATION_CREDENTIALS
   - backup-service: R2 credentials (can reuse profile-service)

4. **Rotation Procedures**:
   - JWT_SECRET rotation (coordinate across services, invalidates all sessions)
   - Apple client secret rotation (6-month expiry, see DEP-06)
   - API key rotation (KYCAID, R2, AWS)

5. **Verification Checklist**:
   - No .env files committed (check .gitignore)
   - No secrets in source code
   - All secrets in Railway environment variables
  </action>
  <verify>
- docs/SECRETS_MANAGEMENT.md exists
- Document includes Railway shared variable configuration
- Document includes rotation procedures for time-limited secrets
- .gitignore includes .env pattern: `grep "\.env" .gitignore`
  </verify>
  <done>Secrets management documented with Railway configuration guide and rotation procedures</done>
</task>

</tasks>

<verification>
- [ ] ENVIRONMENT_VARIABLES.md comprehensive (all services, all variables)
- [ ] SECRETS_MANAGEMENT.md complete (Railway config, rotation)
- [ ] No hardcoded secrets found in source code scan
- [ ] .gitignore properly excludes .env files
</verification>

<success_criteria>
DEP-02: All environment variables documented with classification
DEP-03: No secrets in source code verified, Railway configuration documented
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployment-infrastructure/06-01-SUMMARY.md`
</output>
