---
phase: 06-deployment-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/auth-service/src/index.ts
  - backend/auth-service/.env.example
  - docs/runbooks/apple-secret-rotation.md
autonomous: false

must_haves:
  truths:
    - "Android users can sign in with Apple via web flow"
    - "Apple Services ID is configured (separate from App ID)"
    - "Client secret rotation procedure is documented"
  artifacts:
    - path: "backend/auth-service/src/index.ts"
      provides: "Apple web flow callback endpoint"
      contains: "/auth/apple/web"
    - path: "docs/runbooks/apple-secret-rotation.md"
      provides: "6-month rotation procedure"
      contains: "client secret"
  key_links:
    - from: "backend/auth-service/src/index.ts"
      to: "appleSignin.getClientSecret"
      via: "Client secret generation"
      pattern: "getClientSecret"

user_setup:
  - service: apple-developer
    why: "Apple Sign-In web flow requires Services ID (distinct from App ID)"
    env_vars:
      - name: APPLE_TEAM_ID
        source: "Apple Developer Portal -> Membership -> Team ID"
      - name: APPLE_SERVICES_ID
        source: "Apple Developer Portal -> Identifiers -> Services IDs"
      - name: APPLE_KEY_ID
        source: "Apple Developer Portal -> Keys -> Key ID"
      - name: APPLE_PRIVATE_KEY
        source: "Apple Developer Portal -> Keys -> Download .p8 file content"
      - name: APPLE_REDIRECT_URI
        value: "https://auth-service.railway.app/auth/apple/callback"
        source: "Railway auth-service URL + /auth/apple/callback"
    dashboard_config:
      - task: "Create Services ID for web flow"
        location: "Apple Developer Portal -> Identifiers -> Register Services ID"
      - task: "Configure Sign in with Apple for Services ID"
        location: "Apple Developer Portal -> Identifiers -> [Services ID] -> Configure"
      - task: "Create/download private key (.p8)"
        location: "Apple Developer Portal -> Keys -> Create Key"
---

<objective>
Add Apple Sign-In web flow endpoint for Android users and document client secret rotation procedure.

Purpose: DEP-06 requires Apple Sign-In support on Android via web flow. The existing /auth/apple endpoint handles iOS native flow; this adds /auth/apple/web for Android's web-based flow using authorization code exchange.

Output: New /auth/apple/web endpoint, updated .env.example with Apple web flow variables, rotation runbook
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-deployment-infrastructure/06-RESEARCH.md
@backend/auth-service/src/index.ts
@backend/auth-service/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Apple Web Flow Endpoint</name>
  <files>backend/auth-service/src/index.ts</files>
  <action>
Add new endpoint /auth/apple/web for Android web flow:

1. Add after existing /auth/apple endpoint (around line 560)
2. This endpoint handles the POST callback from Apple's web-based authorization

```typescript
// Apple Sign-In web flow (for Android via web)
app.post('/auth/apple/web', authLimiter, async (req: Request, res: Response) => {
  try {
    const { code, state } = req.body;

    if (!code) {
      return res.status(400).json({ success: false, error: 'Authorization code is required' });
    }

    // Validate required environment variables
    if (!process.env.APPLE_SERVICES_ID || !process.env.APPLE_TEAM_ID ||
        !process.env.APPLE_KEY_ID || !process.env.APPLE_PRIVATE_KEY ||
        !process.env.APPLE_REDIRECT_URI) {
      logger.error('Apple web flow environment variables not configured');
      return res.status(503).json({ success: false, error: 'Apple Sign-In web flow not configured' });
    }

    // Generate client secret using apple-signin-auth
    const clientSecret = appleSignin.getClientSecret({
      clientID: process.env.APPLE_SERVICES_ID,
      teamID: process.env.APPLE_TEAM_ID,
      privateKey: process.env.APPLE_PRIVATE_KEY,
      keyIdentifier: process.env.APPLE_KEY_ID,
      expAfter: 15777000, // 6 months in seconds (maximum allowed)
    });

    // Exchange authorization code for tokens
    const tokenResponse = await appleSignin.getAuthorizationToken(code, {
      clientID: process.env.APPLE_SERVICES_ID,
      clientSecret,
      redirectUri: process.env.APPLE_REDIRECT_URI,
    });

    if (!tokenResponse.id_token) {
      return res.status(401).json({ success: false, error: 'Failed to get identity token from Apple' });
    }

    // Verify the id_token - note: web flow uses Services ID as audience
    const appleIdTokenClaims = await appleSignin.verifyIdToken(tokenResponse.id_token, {
      audience: process.env.APPLE_SERVICES_ID,
    });

    if (!appleIdTokenClaims || !appleIdTokenClaims.sub) {
      return res.status(401).json({ success: false, error: 'Invalid identity token claims' });
    }

    const providerId = `apple_${appleIdTokenClaims.sub}`;
    const email = appleIdTokenClaims.email?.toLowerCase() || `user_${appleIdTokenClaims.sub}@apple.example.com`;
    const provider = 'apple';

    // Check if this Apple account is already linked (reuse existing logic)
    const existingCredential = await pool.query(
      `SELECT ac.user_id FROM auth_credentials ac WHERE ac.provider = $1 AND ac.provider_id = $2`,
      [provider, providerId]
    );

    let userId: string;

    if (existingCredential.rows.length > 0) {
      userId = existingCredential.rows[0].user_id;
      await pool.query('UPDATE users SET updated_at = NOW() WHERE id = $1', [userId]);
    } else {
      // Check for existing user with same email (account linking)
      const existingEmail = await pool.query(
        'SELECT user_id FROM auth_credentials WHERE email = $1',
        [email]
      );

      const client = await pool.connect();
      try {
        await client.query('BEGIN');

        if (existingEmail.rows.length > 0) {
          userId = existingEmail.rows[0].user_id;
          await client.query(
            `INSERT INTO auth_credentials (user_id, provider, provider_id, email, email_verified)
             VALUES ($1, $2, $3, $4, true)
             ON CONFLICT (provider, provider_id) DO UPDATE SET updated_at = NOW()`,
            [userId, provider, providerId, email]
          );
        } else {
          userId = providerId;
          await client.query(
            `INSERT INTO users (id, provider, email) VALUES ($1, $2, $3)
             ON CONFLICT (id) DO UPDATE SET updated_at = NOW(), email = $3`,
            [userId, provider, email]
          );
          await client.query(
            `INSERT INTO auth_credentials (user_id, provider, provider_id, email, email_verified)
             VALUES ($1, $2, $3, $4, true)
             ON CONFLICT (provider, provider_id) DO UPDATE SET updated_at = NOW()`,
            [userId, provider, providerId, email]
          );
        }

        await client.query('COMMIT');
      } catch (error) {
        await client.query('ROLLBACK');
        throw error;
      } finally {
        client.release();
      }
    }

    // Generate tokens (same as native flow)
    const accessToken = jwt.sign({ userId }, process.env.JWT_SECRET!, { expiresIn: '15m' });
    const refreshToken = jwt.sign({ userId, type: 'refresh' }, process.env.JWT_SECRET!, { expiresIn: '7d' });

    // Store refresh token
    await pool.query(
      `INSERT INTO refresh_tokens (user_id, token, expires_at)
       VALUES ($1, $2, NOW() + INTERVAL '7 days')`,
      [userId, refreshToken]
    );

    logger.info('Apple web sign-in successful', { userId, email });
    res.json({ success: true, accessToken, refreshToken, userId });
  } catch (error) {
    logger.error('Apple web sign-in error', { error });
    res.status(401).json({ success: false, error: 'Apple authentication failed' });
  }
});
```

Key differences from native flow:
- Uses authorization code (not identity token directly)
- Requires client secret generation
- Uses Services ID (not App ID) as audience
- No nonce validation (handled in authorization request)
  </action>
  <verify>
- grep "/auth/apple/web" backend/auth-service/src/index.ts returns result
- grep "getClientSecret" backend/auth-service/src/index.ts returns result
- grep "APPLE_SERVICES_ID" backend/auth-service/src/index.ts returns result
  </verify>
  <done>Apple web flow endpoint exists with client secret generation and token exchange</done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example and Create Rotation Runbook</name>
  <files>backend/auth-service/.env.example, docs/runbooks/apple-secret-rotation.md</files>
  <action>
**Part A: Update .env.example**

Add Apple web flow configuration after existing Apple configuration:

```
# Apple Sign-In Web Flow Configuration (REQUIRED for Android)
# This is SEPARATE from APPLE_CLIENT_ID which is for iOS native flow
# Get from Apple Developer Portal -> Identifiers -> Services IDs
# APPLE_SERVICES_ID=vip.getvlvt.web

# Apple Developer Team ID (10 characters)
# Get from Apple Developer Portal -> Membership
# APPLE_TEAM_ID=XXXXXXXXXX

# Apple Sign-In Key ID
# Get from Apple Developer Portal -> Keys
# APPLE_KEY_ID=XXXXXXXXXX

# Apple Private Key (contents of .p8 file, NOT the file path)
# Get from Apple Developer Portal -> Keys -> Download
# Store as a single line with \n for newlines, or use Railway's multiline support
# APPLE_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nMIGT...

# Callback URL for Apple web flow (must match Apple Developer Portal configuration)
# APPLE_REDIRECT_URI=https://auth-service.railway.app/auth/apple/callback
```

**Part B: Create rotation runbook**

Create docs/runbooks/ directory if needed, then create apple-secret-rotation.md:

```markdown
# Apple Client Secret Rotation Runbook

## Overview

Apple Sign-In web flow requires a client secret JWT that **expires every 6 months maximum**. This runbook documents the rotation procedure.

## Schedule

| Event | Action |
|-------|--------|
| Initial setup | Generate client secret, set calendar reminder |
| 5.5 months | Generate new client secret, update Railway |
| 6 months | Old secret expires (service disruption if not rotated) |

**Calendar reminder:** Set for 5.5 months after each rotation.

## Prerequisites

- Access to Apple Developer Portal (Account Holder or Admin role)
- Access to Railway dashboard
- Private key (.p8 file) - stored securely

## Rotation Steps

### 1. Verify Current Status

Check current secret expiration (if logged):
- Railway auth-service logs: Look for "Apple web sign-in" entries
- If failing with "invalid_client", secret has expired

### 2. Generate New Client Secret

The client secret is generated at runtime by the auth-service using:
- APPLE_TEAM_ID
- APPLE_SERVICES_ID
- APPLE_KEY_ID
- APPLE_PRIVATE_KEY

**If the private key hasn't changed**, no action needed - the server generates a fresh JWT on each request with 6-month expiry.

**If you need a new private key:**

1. Go to Apple Developer Portal -> Keys
2. Click + to create new key
3. Enable "Sign in with Apple"
4. Download the .p8 file (only downloadable once!)
5. Copy the Key ID

### 3. Update Railway Environment

1. Go to Railway -> auth-service -> Variables
2. Update APPLE_KEY_ID with new Key ID
3. Update APPLE_PRIVATE_KEY with new key contents:
   - Open .p8 file in text editor
   - Copy entire content including BEGIN/END lines
   - Paste into Railway (supports multiline)
4. Save changes (triggers redeploy)

### 4. Verify Rotation

1. Wait for deploy to complete
2. Test Apple Sign-In on Android device
3. Check Railway logs for successful authentication

### 5. Post-Rotation

1. Set calendar reminder for 5.5 months from now
2. Store .p8 file in secure location (password manager, encrypted drive)
3. Consider revoking old key after verifying new key works

## Troubleshooting

| Error | Cause | Fix |
|-------|-------|-----|
| invalid_client | Client secret invalid/expired | Check APPLE_PRIVATE_KEY is correct |
| invalid_grant | Authorization code expired | User needs to re-authenticate |
| Service unavailable | Missing env vars | Check all APPLE_* variables set |

## Emergency Recovery

If Apple Sign-In is broken:

1. **Short-term:** Users can sign in with Google or email/password
2. **Diagnosis:** Check Railway logs for specific error
3. **If key is compromised:** Revoke key in Apple Developer Portal immediately
```
  </action>
  <verify>
- grep "APPLE_SERVICES_ID" backend/auth-service/.env.example returns result
- grep "APPLE_TEAM_ID" backend/auth-service/.env.example returns result
- File exists: docs/runbooks/apple-secret-rotation.md
  </verify>
  <done>Apple web flow configuration documented and rotation runbook created</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Apple Sign-In web flow endpoint (/auth/apple/web) and rotation documentation. This enables Android users to sign in with Apple.</what-built>
  <how-to-verify>
**Apple Developer Portal Configuration:**

1. **Create Services ID** (if not exists):
   - Go to: https://developer.apple.com/account/resources/identifiers/list/serviceId
   - Click + to register new identifier
   - Select "Services IDs" and Continue
   - Description: "VLVT Web Sign In"
   - Identifier: vip.getvlvt.web (must be unique)
   - Register

2. **Configure Sign in with Apple for Services ID**:
   - Click on the Services ID you created
   - Check "Sign in with Apple"
   - Click Configure
   - Primary App ID: Select your main VLVT App ID
   - Domains: getvlvt.vip (your production domain)
   - Return URLs: https://auth-service.railway.app/auth/apple/callback
   - Save and Continue

3. **Get or Create Sign-In Key**:
   - Go to: https://developer.apple.com/account/resources/authkeys/list
   - If no key exists, create one with "Sign in with Apple" enabled
   - Note the Key ID (10 characters)
   - Download .p8 file if creating new (can only download once!)

4. **Note Your Team ID**:
   - Go to: https://developer.apple.com/account/#!/membership
   - Copy Team ID (10 characters)

5. **Configure Railway**:
   - Go to Railway -> auth-service -> Variables
   - Add: APPLE_SERVICES_ID=vip.getvlvt.web (your Services ID identifier)
   - Add: APPLE_TEAM_ID=XXXXXXXXXX (your Team ID)
   - Add: APPLE_KEY_ID=XXXXXXXXXX (your Key ID)
   - Add: APPLE_PRIVATE_KEY=(paste entire .p8 file contents)
   - Add: APPLE_REDIRECT_URI=https://auth-service.railway.app/auth/apple/callback

6. **Test** (after deploy):
   - On Android device, try "Sign in with Apple"
   - Should open web view, authenticate, and return to app
  </how-to-verify>
  <resume-signal>Type "apple configured" when Apple Developer and Railway are configured, or "skip" to configure later</resume-signal>
</task>

</tasks>

<verification>
- [ ] /auth/apple/web endpoint added to auth-service
- [ ] Environment variables documented in .env.example
- [ ] Rotation runbook exists at docs/runbooks/apple-secret-rotation.md
- [ ] User has configured Apple Developer Portal and Railway (or explicitly skipped)
</verification>

<success_criteria>
DEP-06: Apple Sign-In web flow endpoint exists and is documented. Android users can sign in with Apple when configuration is complete.
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployment-infrastructure/06-03-SUMMARY.md`
</output>
