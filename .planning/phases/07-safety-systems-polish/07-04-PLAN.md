---
phase: 07-safety-systems-polish
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/lib/services/after_hours_safety_service.dart
  - frontend/lib/widgets/quick_report_dialog.dart
  - frontend/lib/screens/after_hours_chat_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can tap report button to open quick report dialog"
    - "Report dialog shows reason selection and optional details"
    - "Submitting report auto-exits the chat and returns to After Hours tab"
    - "User can block from chat screen (separate from report)"
  artifacts:
    - path: "frontend/lib/services/after_hours_safety_service.dart"
      provides: "API client for After Hours block and report"
      exports: ["AfterHoursSafetyService"]
    - path: "frontend/lib/widgets/quick_report_dialog.dart"
      provides: "One-tap report modal with reason chips"
      contains: "QuickReportDialog"
    - path: "frontend/lib/screens/after_hours_chat_screen.dart"
      provides: "Report and block buttons in app bar"
      contains: "showQuickReportDialog"
  key_links:
    - from: "after_hours_chat_screen.dart"
      to: "quick_report_dialog.dart"
      via: "showDialog"
      pattern: "QuickReportDialog"
    - from: "after_hours_chat_screen.dart"
      to: "after_hours_safety_service.dart"
      via: "Provider.of or context.read"
      pattern: "AfterHoursSafetyService"
---

<objective>
Add frontend quick report flow with one-tap report + auto-exit behavior.

Purpose: Users need fast, low-friction safety mechanisms. Report -> auto-block -> auto-exit chat. User never has to interact with reported user again.

Output: Safety service for API calls, quick report dialog widget, wiring into chat screen.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-safety-systems-polish/07-RESEARCH.md

# Existing patterns
@frontend/lib/services/safety_service.dart (existing safety patterns)
@frontend/lib/screens/after_hours_chat_screen.dart (where to add buttons)
@frontend/lib/config/app_config.dart (service URLs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create After Hours Safety Service</name>
  <files>frontend/lib/services/after_hours_safety_service.dart</files>
  <action>
Create a new service following existing safety_service.dart patterns:

```dart
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import '../config/app_config.dart';
import 'auth_service.dart';
import 'analytics_service.dart';

/// Safety service for After Hours mode - block and report endpoints
class AfterHoursSafetyService extends ChangeNotifier {
  final AuthService _authService;

  AfterHoursSafetyService(this._authService);

  String get baseUrl => AppConfig.chatServiceUrl;

  Map<String, String> _getAuthHeaders() {
    final token = _authService.token;
    return {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer $token',
    };
  }

  /// Block user from After Hours match (permanent block)
  /// Returns true on success, throws on error
  Future<bool> blockUser(String matchId, {String? reason}) async {
    try {
      final response = await http.post(
        Uri.parse('$baseUrl/after-hours/matches/$matchId/block'),
        headers: _getAuthHeaders(),
        body: json.encode({
          if (reason != null) 'reason': reason,
        }),
      );

      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        if (data['success'] == true) {
          await AnalyticsService.logUserBlocked(matchId);
          return true;
        }
      }
      throw Exception('Failed to block user: ${response.statusCode}');
    } catch (e) {
      debugPrint('Error blocking After Hours user: $e');
      rethrow;
    }
  }

  /// Report user from After Hours match (auto-blocks and declines)
  /// Returns true on success, throws on error
  Future<bool> reportUser({
    required String matchId,
    required String reason,
    String? details,
  }) async {
    try {
      final response = await http.post(
        Uri.parse('$baseUrl/after-hours/matches/$matchId/report'),
        headers: _getAuthHeaders(),
        body: json.encode({
          'reason': reason,
          if (details != null && details.isNotEmpty) 'details': details,
        }),
      );

      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        if (data['success'] == true) {
          await AnalyticsService.logUserReported(matchId, reason);
          return true;
        }
      }
      throw Exception('Failed to report user: ${response.statusCode}');
    } catch (e) {
      debugPrint('Error reporting After Hours user: $e');
      rethrow;
    }
  }
}
```

Report reason enum values: 'inappropriate', 'harassment', 'spam', 'underage', 'other'
  </action>
  <verify>`cd frontend && flutter analyze` passes</verify>
  <done>Service file exists with blockUser and reportUser methods</done>
</task>

<task type="auto">
  <name>Task 2: Create Quick Report Dialog</name>
  <files>frontend/lib/widgets/quick_report_dialog.dart</files>
  <action>
Create a modal dialog for quick reporting:

```dart
import 'package:flutter/material.dart';

/// Reason enum matching backend
enum ReportReason {
  inappropriate('inappropriate', 'Inappropriate Content'),
  harassment('harassment', 'Harassment'),
  spam('spam', 'Spam'),
  underage('underage', 'Underage User'),
  other('other', 'Other');

  final String value;
  final String label;
  const ReportReason(this.value, this.label);
}

/// One-tap report dialog for After Hours
class QuickReportDialog extends StatefulWidget {
  final String matchId;
  final Function(String reason, String? details) onReport;

  const QuickReportDialog({
    super.key,
    required this.matchId,
    required this.onReport,
  });

  @override
  State<QuickReportDialog> createState() => _QuickReportDialogState();
}

class _QuickReportDialogState extends State<QuickReportDialog> {
  ReportReason? _selectedReason;
  final _detailsController = TextEditingController();
  bool _isSubmitting = false;

  @override
  void dispose() {
    _detailsController.dispose();
    super.dispose();
  }

  Future<void> _submit() async {
    if (_selectedReason == null) return;

    setState(() => _isSubmitting = true);

    try {
      await widget.onReport(
        _selectedReason!.value,
        _detailsController.text.isEmpty ? null : _detailsController.text,
      );
      if (mounted) Navigator.of(context).pop(true);
    } catch (e) {
      setState(() => _isSubmitting = false);
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to submit report: $e')),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('Report User'),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              'Select a reason for reporting:',
              style: TextStyle(fontWeight: FontWeight.w500),
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: ReportReason.values.map((reason) {
                final isSelected = _selectedReason == reason;
                return ChoiceChip(
                  label: Text(reason.label),
                  selected: isSelected,
                  onSelected: (selected) {
                    setState(() => _selectedReason = selected ? reason : null);
                  },
                );
              }).toList(),
            ),
            const SizedBox(height: 16),
            TextField(
              controller: _detailsController,
              decoration: const InputDecoration(
                labelText: 'Additional details (optional)',
                hintText: 'Describe what happened...',
                border: OutlineInputBorder(),
              ),
              maxLines: 3,
              maxLength: 500,
            ),
            const SizedBox(height: 8),
            const Text(
              'This will block the user and end the chat.',
              style: TextStyle(
                color: Colors.grey,
                fontSize: 12,
              ),
            ),
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: _isSubmitting ? null : () => Navigator.of(context).pop(false),
          child: const Text('Cancel'),
        ),
        ElevatedButton(
          onPressed: _isSubmitting || _selectedReason == null ? null : _submit,
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.red,
            foregroundColor: Colors.white,
          ),
          child: _isSubmitting
              ? const SizedBox(
                  width: 20,
                  height: 20,
                  child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white),
                )
              : const Text('Report & Exit'),
        ),
      ],
    );
  }
}

/// Helper function to show the report dialog
Future<bool?> showQuickReportDialog(
  BuildContext context, {
  required String matchId,
  required Function(String reason, String? details) onReport,
}) {
  return showDialog<bool>(
    context: context,
    barrierDismissible: false,
    builder: (context) => QuickReportDialog(
      matchId: matchId,
      onReport: onReport,
    ),
  );
}
```

Dialog features:
- Reason selection via chips (required)
- Optional details text field
- "Report & Exit" button disabled until reason selected
- Loading state during submission
- Auto-closes on success
  </action>
  <verify>`cd frontend && flutter analyze` passes</verify>
  <done>Quick report dialog exists with chip selection and submit handling</done>
</task>

<task type="auto">
  <name>Task 3: Wire Report and Block to Chat Screen</name>
  <files>frontend/lib/screens/after_hours_chat_screen.dart</files>
  <action>
Modify the existing After Hours chat screen to add safety buttons:

1. Add import at top:
```dart
import '../services/after_hours_safety_service.dart';
import '../widgets/quick_report_dialog.dart';
```

2. In the AppBar actions (or overflow menu), add:
```dart
PopupMenuButton<String>(
  icon: const Icon(Icons.more_vert),
  onSelected: (value) async {
    if (value == 'report') {
      await _handleReport();
    } else if (value == 'block') {
      await _handleBlock();
    }
  },
  itemBuilder: (context) => [
    const PopupMenuItem(
      value: 'report',
      child: Row(
        children: [
          Icon(Icons.flag, color: Colors.red),
          SizedBox(width: 8),
          Text('Report User'),
        ],
      ),
    ),
    const PopupMenuItem(
      value: 'block',
      child: Row(
        children: [
          Icon(Icons.block, color: Colors.orange),
          SizedBox(width: 8),
          Text('Block User'),
        ],
      ),
    ),
  ],
),
```

3. Add handler methods to the state class:
```dart
Future<void> _handleReport() async {
  final safetyService = context.read<AfterHoursSafetyService>();
  final matchId = widget.match.id; // Get match ID from widget props

  final reported = await showQuickReportDialog(
    context,
    matchId: matchId,
    onReport: (reason, details) async {
      await safetyService.reportUser(
        matchId: matchId,
        reason: reason,
        details: details,
      );
    },
  );

  if (reported == true && mounted) {
    // Exit chat and return to After Hours tab
    Navigator.of(context).pop();
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('User reported and blocked')),
    );
  }
}

Future<void> _handleBlock() async {
  final confirmed = await showDialog<bool>(
    context: context,
    builder: (context) => AlertDialog(
      title: const Text('Block User?'),
      content: const Text(
        'This will permanently block this user. You won\'t see them again in After Hours or the main app.',
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(false),
          child: const Text('Cancel'),
        ),
        ElevatedButton(
          onPressed: () => Navigator.of(context).pop(true),
          style: ElevatedButton.styleFrom(backgroundColor: Colors.orange),
          child: const Text('Block'),
        ),
      ],
    ),
  );

  if (confirmed == true) {
    try {
      final safetyService = context.read<AfterHoursSafetyService>();
      await safetyService.blockUser(widget.match.id);
      if (mounted) {
        Navigator.of(context).pop();
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('User blocked')),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to block user: $e')),
        );
      }
    }
  }
}
```

4. Register AfterHoursSafetyService in provider tree (provider_tree.dart):
```dart
ChangeNotifierProxyProvider<AuthService, AfterHoursSafetyService>(
  create: (_) => AfterHoursSafetyService(AuthService()),
  update: (_, auth, prev) => prev ?? AfterHoursSafetyService(auth),
),
```
  </action>
  <verify>
    `cd frontend && flutter analyze` passes
    Report/block buttons visible in chat screen app bar menu
  </verify>
  <done>
    Chat screen has report and block buttons in overflow menu
    Report shows dialog, submits, and exits chat
    Block shows confirmation, submits, and exits chat
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter analyze` passes with no errors
2. AfterHoursSafetyService registered in provider tree
3. Quick report dialog shows reason chips
4. Report flow: tap -> dialog -> submit -> exit chat
5. Block flow: tap -> confirm -> submit -> exit chat
</verification>

<success_criteria>
- AfterHoursSafetyService has blockUser and reportUser methods
- QuickReportDialog shows reason selection chips
- Chat screen has overflow menu with Report and Block options
- Report auto-exits chat after submission
- Provider tree includes AfterHoursSafetyService
</success_criteria>

<output>
After completion, create `.planning/phases/07-safety-systems-polish/07-04-SUMMARY.md`
</output>
