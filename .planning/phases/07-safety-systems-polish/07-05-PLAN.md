---
phase: 07-safety-systems-polish
plan: 05
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - frontend/lib/services/analytics_service.dart
  - frontend/lib/services/after_hours_service.dart
  - frontend/lib/screens/after_hours_tab_screen.dart
  - frontend/lib/screens/after_hours_chat_screen.dart
autonomous: true

must_haves:
  truths:
    - "Product team can measure After Hours session activation rate"
    - "Product team can track match acceptance vs decline conversion"
    - "Product team can analyze chat engagement metrics"
    - "Product team can measure permanent match save conversion"
  artifacts:
    - path: "frontend/lib/services/analytics_service.dart"
      provides: "After Hours analytics event methods"
      contains: "logAfterHoursSessionStarted"
  key_links:
    - from: "after_hours_service.dart"
      to: "analytics_service.dart"
      via: "AnalyticsService.logAfterHours* calls"
      pattern: "AnalyticsService\\.logAfterHours"
    - from: "after_hours_chat_screen.dart"
      to: "analytics_service.dart"
      via: "AnalyticsService.logAfterHoursChatStarted"
      pattern: "logAfterHoursChatStarted"
---

<objective>
Add analytics events for the After Hours funnel: session start, match received, chat started, match saved.

Purpose: Track user journey through After Hours mode for product insights. Understand conversion rates at each step.

Output: New analytics methods in AnalyticsService, instrumentation in After Hours screens/services.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-safety-systems-polish/07-RESEARCH.md

# Existing patterns
@frontend/lib/services/analytics_service.dart (existing analytics patterns)
@frontend/lib/services/after_hours_service.dart (where to instrument)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add After Hours Analytics Methods</name>
  <files>frontend/lib/services/analytics_service.dart</files>
  <action>
Add a new section to AnalyticsService for After Hours events:

```dart
// ============================================================
// AFTER HOURS EVENTS
// ============================================================

/// Log when user starts an After Hours session
static Future<void> logAfterHoursSessionStarted({
  required int durationMinutes,
}) async {
  try {
    await _analytics.logEvent(
      name: 'after_hours_session_started',
      parameters: {
        'duration_minutes': durationMinutes,
      },
    );
    debugPrint('Analytics: After Hours session started ($durationMinutes min)');
  } catch (e) {
    debugPrint('Analytics error logging AH session start: $e');
  }
}

/// Log when user receives an After Hours match
static Future<void> logAfterHoursMatchReceived({
  required String matchId,
}) async {
  try {
    await _analytics.logEvent(
      name: 'after_hours_match_received',
      parameters: {
        'match_id': matchId,
      },
    );
    debugPrint('Analytics: After Hours match received ($matchId)');
  } catch (e) {
    debugPrint('Analytics error logging AH match received: $e');
  }
}

/// Log when user accepts match and enters chat
static Future<void> logAfterHoursChatStarted({
  required String matchId,
}) async {
  try {
    await _analytics.logEvent(
      name: 'after_hours_chat_started',
      parameters: {
        'match_id': matchId,
      },
    );
    debugPrint('Analytics: After Hours chat started ($matchId)');
  } catch (e) {
    debugPrint('Analytics error logging AH chat start: $e');
  }
}

/// Log when mutual save converts to permanent match
static Future<void> logAfterHoursMatchSaved({
  required String matchId,
}) async {
  try {
    await _analytics.logEvent(
      name: 'after_hours_match_saved',
      parameters: {
        'match_id': matchId,
      },
    );
    debugPrint('Analytics: After Hours match saved ($matchId)');
  } catch (e) {
    debugPrint('Analytics error logging AH match saved: $e');
  }
}

/// Log when user declines an After Hours match
static Future<void> logAfterHoursMatchDeclined({
  required String matchId,
}) async {
  try {
    await _analytics.logEvent(
      name: 'after_hours_match_declined',
      parameters: {
        'match_id': matchId,
      },
    );
    debugPrint('Analytics: After Hours match declined ($matchId)');
  } catch (e) {
    debugPrint('Analytics error logging AH match declined: $e');
  }
}

/// Log when After Hours session ends (naturally or early)
static Future<void> logAfterHoursSessionEnded({
  required int durationMinutes,
  required String endReason, // 'expired', 'manual', 'error'
}) async {
  try {
    await _analytics.logEvent(
      name: 'after_hours_session_ended',
      parameters: {
        'duration_minutes': durationMinutes,
        'end_reason': endReason,
      },
    );
    debugPrint('Analytics: After Hours session ended ($endReason)');
  } catch (e) {
    debugPrint('Analytics error logging AH session end: $e');
  }
}
```

Follow the existing error handling and debugPrint patterns exactly.
  </action>
  <verify>`cd frontend && flutter analyze` passes</verify>
  <done>Six new After Hours analytics methods added to AnalyticsService</done>
</task>

<task type="auto">
  <name>Task 2: Instrument After Hours Service</name>
  <files>frontend/lib/services/after_hours_service.dart</files>
  <action>
Add analytics calls to AfterHoursService at key moments:

1. In the session start method (after successful API call):
```dart
// After successful session start
await AnalyticsService.logAfterHoursSessionStarted(
  durationMinutes: durationMinutes,
);
```

2. In the match received socket handler (when new match comes in):
```dart
// In _handleNewMatch or similar
await AnalyticsService.logAfterHoursMatchReceived(
  matchId: match.id,
);
```

3. In the match accepted handler (when user accepts and enters chat):
```dart
// After accepting match (not declining)
await AnalyticsService.logAfterHoursChatStarted(
  matchId: matchId,
);
```

4. In the mutual save handler (when both users have saved):
```dart
// In match saved event handler
await AnalyticsService.logAfterHoursMatchSaved(
  matchId: matchId,
);
```

5. In the decline match method:
```dart
// After successful decline API call
await AnalyticsService.logAfterHoursMatchDeclined(
  matchId: matchId,
);
```

6. In session end handler (both manual and expired):
```dart
// When session ends
await AnalyticsService.logAfterHoursSessionEnded(
  durationMinutes: elapsedMinutes,
  endReason: isManual ? 'manual' : 'expired',
);
```

Import at top:
```dart
import 'analytics_service.dart';
```

Use fire-and-forget pattern (don't await analytics calls in critical paths, or catch and ignore errors).
  </action>
  <verify>`cd frontend && flutter analyze` passes</verify>
  <done>Analytics calls added to session start, match received, chat start, save, decline, session end</done>
</task>

<task type="auto">
  <name>Task 3: Instrument Device Fingerprint Collection</name>
  <files>
    frontend/lib/services/after_hours_service.dart
    frontend/lib/services/device_fingerprint_service.dart
  </files>
  <action>
**Prerequisite:** Plan 07-02 added backend support for deviceFingerprint in session start endpoint (profile-service/src/routes/after-hours.ts). This task wires the Flutter client to send fingerprints.

1. Create device fingerprint service (if not exists):

```dart
// frontend/lib/services/device_fingerprint_service.dart
import 'dart:io';
import 'package:device_info_plus/device_info_plus.dart';
import 'package:flutter/foundation.dart';

/// Collects device fingerprint for ban enforcement
class DeviceFingerprintService {
  static final DeviceInfoPlugin _deviceInfo = DeviceInfoPlugin();

  /// Collect device fingerprint for session start
  /// Returns map with deviceId, deviceModel, platform
  static Future<Map<String, String?>> collectFingerprint() async {
    try {
      Map<String, String?> fingerprint = {};

      if (Platform.isIOS) {
        final iosInfo = await _deviceInfo.iosInfo;
        fingerprint['deviceId'] = iosInfo.identifierForVendor;
        fingerprint['deviceModel'] = iosInfo.model;
        fingerprint['platform'] = 'ios';
      } else if (Platform.isAndroid) {
        final androidInfo = await _deviceInfo.androidInfo;
        fingerprint['deviceId'] = androidInfo.id;
        fingerprint['deviceModel'] = androidInfo.model;
        fingerprint['platform'] = 'android';
      }

      return fingerprint;
    } catch (e) {
      debugPrint('Error collecting device fingerprint: $e');
      return {};
    }
  }
}
```

2. Modify AfterHoursService session start to include fingerprint:

In the startSession method, before or during the API call:
```dart
// Collect device fingerprint (non-blocking)
final fingerprint = await DeviceFingerprintService.collectFingerprint();

// Include in session start request body
final response = await http.post(
  Uri.parse('$baseUrl/api/after-hours/session/start'),
  headers: _getAuthHeaders(),
  body: json.encode({
    'durationMinutes': durationMinutes,
    'location': {
      'lat': lat,
      'lng': lng,
    },
    'deviceFingerprint': fingerprint, // Add this
  }),
);
```

Note: device_info_plus is already a project dependency (used in existing feedback flow).
  </action>
  <verify>`cd frontend && flutter analyze` passes</verify>
  <done>Device fingerprint collected and sent with session start request</done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter analyze` passes with no errors
2. AnalyticsService has 6 new After Hours methods
3. Session start logs after_hours_session_started
4. Match received logs after_hours_match_received
5. Chat start logs after_hours_chat_started
6. Mutual save logs after_hours_match_saved
7. Device fingerprint sent with session start
</verification>

<success_criteria>
- All 6 After Hours analytics events defined in AnalyticsService
- Session start instrumented with duration
- Match received instrumented with matchId
- Chat start instrumented with matchId
- Mutual save instrumented with matchId
- Device fingerprint collected and sent to backend
</success_criteria>

<output>
After completion, create `.planning/phases/07-safety-systems-polish/07-05-SUMMARY.md`
</output>
