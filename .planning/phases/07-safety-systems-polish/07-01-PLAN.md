---
phase: 07-safety-systems-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/chat-service/src/routes/after-hours-chat.ts
  - backend/chat-service/src/services/after-hours-safety-service.ts
autonomous: true

must_haves:
  truths:
    - "User can block another user from After Hours chat"
    - "User can report another user from After Hours chat"
    - "Report auto-blocks and auto-declines the match"
    - "Existing blocks from main app are respected (already implemented in matching)"
  artifacts:
    - path: "backend/chat-service/src/routes/after-hours-chat.ts"
      provides: "Block and report endpoints for After Hours"
      contains: "/after-hours/matches/:matchId/block"
    - path: "backend/chat-service/src/services/after-hours-safety-service.ts"
      provides: "Business logic for After Hours safety operations"
      exports: ["blockAfterHoursUser", "reportAfterHoursUser"]
  key_links:
    - from: "backend/chat-service/src/routes/after-hours-chat.ts"
      to: "after-hours-safety-service.ts"
      via: "function imports"
      pattern: "import.*after-hours-safety-service"
    - from: "after-hours-safety-service.ts"
      to: "blocks table"
      via: "INSERT INTO blocks"
      pattern: "INSERT INTO blocks"
---

<objective>
Add After Hours block and quick report endpoints to chat-service.

Purpose: Users need safety mechanisms within After Hours mode - ability to block permanently and report bad actors with one tap. Reports should auto-block and auto-decline the match.

Output: Two new endpoints in after-hours-chat.ts, one new service file for safety logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-safety-systems-polish/07-RESEARCH.md

# Existing patterns
@backend/chat-service/src/routes/after-hours-chat.ts
@backend/chat-service/src/index.ts (lines 796-958 for existing block/report endpoints)
@frontend/lib/services/safety_service.dart (Flutter patterns for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create After Hours Safety Service</name>
  <files>backend/chat-service/src/services/after-hours-safety-service.ts</files>
  <action>
Create a new service file with two exported functions:

1. `blockAfterHoursUser(pool, userId, blockedUserId, matchId, reason?)`:
   - Insert into `blocks` table (same as main app - permanent block)
   - Update `after_hours_matches` to set `declined_by = userId, declined_at = NOW()` for the match
   - Return success with blockId
   - Use existing UUID pattern with uuidv4()

2. `reportAfterHoursUser(pool, userId, reportedUserId, matchId, reason, details?)`:
   - Insert into `reports` table with source: 'after_hours'
   - Call blockAfterHoursUser() to auto-block (fire-and-forget pattern from research)
   - Auto-decline the match
   - Return success with reportId

Reason enum for reports: 'inappropriate', 'harassment', 'spam', 'underage', 'other'

Follow existing logger patterns from chat-service.
Do NOT block response on block/report processing - use fire-and-forget with error logging.
  </action>
  <verify>TypeScript compiles: `cd backend/chat-service && npm run build`</verify>
  <done>Service file exists with both functions exported and compiling</done>
</task>

<task type="auto">
  <name>Task 2: Add Block and Report Endpoints</name>
  <files>backend/chat-service/src/routes/after-hours-chat.ts</files>
  <action>
Add two new endpoints to the existing after-hours-chat router:

1. `POST /after-hours/matches/:matchId/block`
   - Validate matchId is UUID
   - Verify user is part of the match (user_id_1 or user_id_2)
   - Extract blockedUserId (the other user in the match)
   - Call blockAfterHoursUser()
   - Return 200 { success: true, message: "User blocked" }
   - Body accepts optional `reason: string`

2. `POST /after-hours/matches/:matchId/report`
   - Validate matchId is UUID
   - Verify user is part of the match
   - Extract reportedUserId (the other user)
   - Validate reason from body (enum: inappropriate, harassment, spam, underage, other)
   - Call reportAfterHoursUser()
   - Return 200 { success: true, message: "Report submitted" }
   - Body: `{ reason: string, details?: string }`

Both endpoints should:
- Use existing authMiddleware pattern (already applied to router)
- Return 403 if user not part of match
- Return 400 for invalid matchId or missing reason
- Log all operations with existing logger patterns
  </action>
  <verify>
    `cd backend/chat-service && npm run build` succeeds
    Manually verify endpoints appear in compiled output
  </verify>
  <done>Both endpoints defined, TypeScript compiles, patterns match existing codebase</done>
</task>

<task type="auto">
  <name>Task 3: Verify Block Sync Already Works</name>
  <files>N/A (verification only)</files>
  <action>
Confirm that block synchronization from main app to After Hours is already implemented:

1. Read `backend/profile-service/src/services/matching-engine.ts`
2. Verify the block exclusion query exists in findMatchCandidate():
   ```sql
   AND a.user_id NOT IN (
     SELECT blocked_user_id FROM blocks WHERE user_id = $1
     UNION
     SELECT user_id FROM blocks WHERE blocked_user_id = $1
   )
   ```
3. Document in summary that block sync is already complete - no additional work needed

This is a verification task, not implementation. If the query is missing, flag as gap.
  </action>
  <verify>Block exclusion SQL pattern found in matching-engine.ts</verify>
  <done>Block sync verified as already implemented, documented in summary</done>
</task>

</tasks>

<verification>
1. `cd backend/chat-service && npm run build` - TypeScript compiles without errors
2. New service file exists at expected path
3. Block/report endpoints return expected response structure
4. Block exclusion confirmed in matching engine
</verification>

<success_criteria>
- POST /after-hours/matches/{matchId}/block endpoint exists and compiles
- POST /after-hours/matches/{matchId}/report endpoint exists and compiles
- Report auto-blocks the reported user
- after-hours-safety-service.ts exports both functions
- No runtime errors on build
</success_criteria>

<output>
After completion, create `.planning/phases/07-safety-systems-polish/07-01-SUMMARY.md`
</output>
