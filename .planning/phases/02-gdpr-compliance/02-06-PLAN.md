---
phase: 02-gdpr-compliance
plan: 06
type: execute
wave: 4
depends_on: ["02-04", "02-05"]
files_modified:
  - frontend/lib/services/auth_service.dart
  - frontend/lib/screens/safety_settings_screen.dart
autonomous: false

must_haves:
  truths:
    - "Users can request data export from Settings"
    - "Export downloads as JSON file to device"
    - "Users see clear feedback during export process"
  artifacts:
    - path: "frontend/lib/services/auth_service.dart"
      provides: "Data export API method"
      contains: "requestDataExport"
    - path: "frontend/lib/screens/safety_settings_screen.dart"
      provides: "Data export UI in Settings"
      contains: "Export My Data"
  key_links:
    - from: "frontend/lib/screens/safety_settings_screen.dart"
      to: "AuthService.requestDataExport"
      via: "Button onPressed"
      pattern: "requestDataExport"
---

<objective>
Add data export UI to Settings for GDPR Right to Access

Purpose: Complete GDPR-03 by providing users with a UI to request their data export. The export downloads as a JSON file that users can save to their device.

Output: Export button in Safety Settings, AuthService method for export request, download handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gdpr-compliance/02-RESEARCH.md
@.planning/phases/02-gdpr-compliance/02-05-SUMMARY.md

# Existing patterns
@frontend/lib/services/auth_service.dart
@frontend/lib/screens/safety_settings_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data export method to AuthService</name>
  <files>frontend/lib/services/auth_service.dart</files>
  <action>
Add a method to AuthService for requesting data export:

```dart
import 'dart:io';
import 'package:path_provider/path_provider.dart';

/// Request data export (GDPR Article 15)
/// Returns the file path if successful, null if failed
Future<String?> requestDataExport() async {
  if (_token == null) return null;

  try {
    final response = await http.get(
      Uri.parse('${AppConfig.authServiceUrl}/auth/data-export'),
      headers: {'Authorization': 'Bearer $_token'},
    );

    if (response.statusCode == 200) {
      // Save to downloads directory
      final directory = await getApplicationDocumentsDirectory();
      final fileName = 'vlvt-data-export-${DateTime.now().toIso8601String().split('T')[0]}.json';
      final file = File('${directory.path}/$fileName');
      await file.writeAsString(response.body);

      debugPrint('Data export saved to: ${file.path}');
      return file.path;
    } else if (response.statusCode == 429) {
      debugPrint('Export rate limited');
      return null; // Rate limited
    } else {
      debugPrint('Export failed: ${response.statusCode}');
      return null;
    }
  } catch (e) {
    debugPrint('Error requesting data export: $e');
    return null;
  }
}
```

Add the path_provider import at the top. This package should already be in pubspec.yaml (commonly used in Flutter apps). If not, add it:

```bash
cd frontend && flutter pub add path_provider
```
  </action>
  <verify>Run `flutter analyze frontend` and confirm no errors in auth_service.dart</verify>
  <done>AuthService has requestDataExport() method that downloads JSON to device</done>
</task>

<task type="auto">
  <name>Task 2: Add data export UI to Safety Settings</name>
  <files>frontend/lib/screens/safety_settings_screen.dart</files>
  <action>
Add a "Your Data" section in SafetySettingsScreen before the "Delete Account" section.

Add imports at top:
```dart
import 'package:share_plus/share_plus.dart'; // For sharing the file
```

Add this section after "Privacy & Legal" and before "Delete Account":

```dart
const Divider(),
Padding(
  padding: const EdgeInsets.all(16.0),
  child: Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    children: [
      const Text(
        'Your Data',
        style: TextStyle(
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ),
      ),
      const SizedBox(height: 8),
      Text(
        'Download a copy of all your personal data. This includes your profile, matches, messages, and preferences.',
        style: TextStyle(
          fontSize: 14,
          color: VlvtColors.textMuted,
        ),
      ),
      const SizedBox(height: 16),
      VlvtButton.secondary(
        label: _isExporting ? 'Exporting...' : 'Export My Data',
        onPressed: _isExporting ? null : _handleDataExport,
        icon: Icons.download,
      ),
    ],
  ),
),
```

Add state variable and handler method to _SafetySettingsScreenState:

```dart
bool _isExporting = false;

Future<void> _handleDataExport() async {
  setState(() => _isExporting = true);

  try {
    final authService = context.read<AuthService>();
    final filePath = await authService.requestDataExport();

    if (!mounted) return;

    if (filePath != null) {
      // Show success dialog with share option
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: const Text('Export Complete'),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(
                'Your data has been exported successfully.',
              ),
              const SizedBox(height: 8),
              Text(
                'File saved to:\n$filePath',
                style: TextStyle(
                  fontSize: 12,
                  color: VlvtColors.textMuted,
                ),
              ),
            ],
          ),
          actions: [
            VlvtButton.text(
              label: 'Close',
              onPressed: () => Navigator.of(context).pop(),
            ),
            VlvtButton.primary(
              label: 'Share',
              onPressed: () async {
                Navigator.of(context).pop();
                await Share.shareXFiles([XFile(filePath)]);
              },
            ),
          ],
        ),
      );
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Failed to export data. You may have reached the hourly limit. Please try again later.'),
          backgroundColor: VlvtColors.crimson,
        ),
      );
    }
  } catch (e) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Export error: $e'),
          backgroundColor: VlvtColors.crimson,
        ),
      );
    }
  } finally {
    if (mounted) {
      setState(() => _isExporting = false);
    }
  }
}
```

Add share_plus dependency if not present:
```bash
cd frontend && flutter pub add share_plus
```
  </action>
  <verify>Run `flutter analyze frontend` and confirm no errors in safety_settings_screen.dart</verify>
  <done>Safety Settings has "Export My Data" button with share functionality</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete GDPR compliance infrastructure:
1. Privacy policy accessible from Settings
2. Special category data disclosure in privacy policy
3. Data retention documentation
4. R2 photo cleanup in account deletion
5. Granular consent management (backend + frontend)
6. Data export endpoint + UI
  </what-built>
  <how-to-verify>
1. Open app and go to Profile > Safety & Privacy
2. Verify these items appear:
   - Privacy Policy link (should open legal document viewer)
   - Terms of Service link
   - Privacy Preferences link (should open consent toggles)
   - Export My Data button
   - Delete Account button (existing)

3. Test Privacy Preferences:
   - Open and see 4 consent toggles
   - Toggle one on/off and verify it persists after closing

4. Test Data Export:
   - Tap "Export My Data"
   - Wait for export to complete
   - Verify JSON file can be shared/opened

5. Read updated privacy policy Section 12:
   - Should mention "sexual orientation"
   - Should mention "Article 9"
   - Should reference After Hours mode
  </how-to-verify>
  <resume-signal>Type "verified" if all GDPR features work correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `flutter analyze frontend` - no errors
2. `cd backend/auth-service && npm run build` - no errors
3. Export button visible in Safety Settings
4. Export downloads JSON file
5. Share option works
</verification>

<success_criteria>
- Data export method in AuthService
- Export My Data button in Safety Settings
- Export shows progress feedback
- Successful export shows share dialog
- Rate limit error handled gracefully
- No Flutter analyze errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-gdpr-compliance/02-06-SUMMARY.md`
</output>
