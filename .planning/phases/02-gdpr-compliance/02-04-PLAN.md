---
phase: 02-gdpr-compliance
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - frontend/lib/services/auth_service.dart
  - frontend/lib/screens/consent_settings_screen.dart
  - frontend/lib/screens/safety_settings_screen.dart
autonomous: true

must_haves:
  truths:
    - "Users can view their current consent status for all purposes"
    - "Users can grant and withdraw consent per purpose from Settings"
    - "Consent UI is accessible from Safety & Privacy settings"
  artifacts:
    - path: "frontend/lib/services/auth_service.dart"
      provides: "Consent API methods"
      contains: "getConsents"
    - path: "frontend/lib/screens/consent_settings_screen.dart"
      provides: "Consent management UI"
      contains: "ConsentSettingsScreen"
    - path: "frontend/lib/screens/safety_settings_screen.dart"
      provides: "Link to consent settings"
      contains: "ConsentSettingsScreen"
  key_links:
    - from: "frontend/lib/screens/consent_settings_screen.dart"
      to: "AuthService"
      via: "Provider.read"
      pattern: "context.read.*AuthService"
---

<objective>
Build frontend consent management UI

Purpose: Complete GDPR-02 and GDPR-05 by providing users with a UI to view and manage their consent preferences. Users must be able to see what they've consented to and withdraw consent without deleting their account.

Output: AuthService methods for consent API, ConsentSettingsScreen with toggle switches, navigation from Safety Settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gdpr-compliance/02-RESEARCH.md
@.planning/phases/02-gdpr-compliance/02-03-SUMMARY.md

# Existing patterns
@frontend/lib/services/auth_service.dart
@frontend/lib/screens/safety_settings_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add consent API methods to AuthService</name>
  <files>frontend/lib/services/auth_service.dart</files>
  <action>
Add three methods to AuthService for consent management:

```dart
/// Consent data model
class ConsentStatus {
  final String purpose;
  final bool granted;
  final DateTime? grantedAt;
  final DateTime? withdrawnAt;
  final String? consentVersion;
  final bool needsRenewal;

  ConsentStatus({
    required this.purpose,
    required this.granted,
    this.grantedAt,
    this.withdrawnAt,
    this.consentVersion,
    this.needsRenewal = false,
  });

  factory ConsentStatus.fromJson(Map<String, dynamic> json) {
    return ConsentStatus(
      purpose: json['purpose'] as String,
      granted: json['granted'] as bool,
      grantedAt: json['grantedAt'] != null ? DateTime.parse(json['grantedAt']) : null,
      withdrawnAt: json['withdrawnAt'] != null ? DateTime.parse(json['withdrawnAt']) : null,
      consentVersion: json['consentVersion'] as String?,
      needsRenewal: json['needsRenewal'] as bool? ?? false,
    );
  }

  String get displayName {
    switch (purpose) {
      case 'location_discovery':
        return 'Location-Based Discovery';
      case 'marketing':
        return 'Marketing Communications';
      case 'analytics':
        return 'Analytics & Improvements';
      case 'after_hours':
        return 'After Hours Mode';
      default:
        return purpose;
    }
  }

  String get description {
    switch (purpose) {
      case 'location_discovery':
        return 'Allow VLVT to use your location to show you nearby profiles.';
      case 'marketing':
        return 'Receive promotional emails and notifications about new features.';
      case 'analytics':
        return 'Help us improve VLVT by sharing anonymous usage data.';
      case 'after_hours':
        return 'Enable After Hours mode for late-night matching. This may reveal information about your dating preferences.';
      default:
        return '';
    }
  }
}

/// Get all consent statuses for current user
Future<List<ConsentStatus>> getConsents() async {
  if (_token == null) return [];

  try {
    final response = await http.get(
      Uri.parse('${AppConfig.authServiceUrl}/auth/consents'),
      headers: {'Authorization': 'Bearer $_token'},
    );

    if (response.statusCode == 200) {
      final data = jsonDecode(response.body);
      final List<dynamic> consents = data['consents'];
      return consents.map((c) => ConsentStatus.fromJson(c)).toList();
    }
    debugPrint('Failed to fetch consents: ${response.statusCode}');
    return [];
  } catch (e) {
    debugPrint('Error fetching consents: $e');
    return [];
  }
}

/// Grant consent for a specific purpose
Future<bool> grantConsent(String purpose) async {
  if (_token == null) return false;

  try {
    final response = await http.post(
      Uri.parse('${AppConfig.authServiceUrl}/auth/consents'),
      headers: {
        'Authorization': 'Bearer $_token',
        'Content-Type': 'application/json',
      },
      body: jsonEncode({'purpose': purpose}),
    );

    return response.statusCode == 200;
  } catch (e) {
    debugPrint('Error granting consent: $e');
    return false;
  }
}

/// Withdraw consent for a specific purpose
Future<bool> withdrawConsent(String purpose) async {
  if (_token == null) return false;

  try {
    final response = await http.delete(
      Uri.parse('${AppConfig.authServiceUrl}/auth/consents/$purpose'),
      headers: {'Authorization': 'Bearer $_token'},
    );

    return response.statusCode == 200;
  } catch (e) {
    debugPrint('Error withdrawing consent: $e');
    return false;
  }
}
```

Add the ConsentStatus class either at the top of the file (after imports) or in a separate models file if preferred. The http and jsonDecode imports should already exist in AuthService.
  </action>
  <verify>Run `flutter analyze frontend` and confirm no errors in auth_service.dart</verify>
  <done>AuthService has getConsents(), grantConsent(), and withdrawConsent() methods</done>
</task>

<task type="auto">
  <name>Task 2: Create ConsentSettingsScreen</name>
  <files>frontend/lib/screens/consent_settings_screen.dart</files>
  <action>
Create a new screen for managing consent preferences:

```dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../services/auth_service.dart';
import '../theme/vlvt_colors.dart';
import '../widgets/vlvt_button.dart';

class ConsentSettingsScreen extends StatefulWidget {
  const ConsentSettingsScreen({super.key});

  @override
  State<ConsentSettingsScreen> createState() => _ConsentSettingsScreenState();
}

class _ConsentSettingsScreenState extends State<ConsentSettingsScreen> {
  List<ConsentStatus> _consents = [];
  bool _isLoading = true;
  Map<String, bool> _pendingChanges = {};

  @override
  void initState() {
    super.initState();
    _loadConsents();
  }

  Future<void> _loadConsents() async {
    setState(() => _isLoading = true);

    try {
      final authService = context.read<AuthService>();
      final consents = await authService.getConsents();
      setState(() {
        _consents = consents;
        _isLoading = false;
      });
    } catch (e) {
      setState(() => _isLoading = false);
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to load consent settings: $e')),
        );
      }
    }
  }

  Future<void> _handleConsentChange(ConsentStatus consent, bool value) async {
    // Optimistic update
    setState(() {
      _pendingChanges[consent.purpose] = value;
    });

    final authService = context.read<AuthService>();
    bool success;

    if (value) {
      success = await authService.grantConsent(consent.purpose);
    } else {
      // Show confirmation for withdrawing consent
      final confirmed = await _showWithdrawConfirmation(consent);
      if (!confirmed) {
        setState(() => _pendingChanges.remove(consent.purpose));
        return;
      }
      success = await authService.withdrawConsent(consent.purpose);
    }

    if (success) {
      await _loadConsents();
    } else {
      // Revert optimistic update
      setState(() => _pendingChanges.remove(consent.purpose));
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Failed to update consent')),
        );
      }
    }
  }

  Future<bool> _showWithdrawConfirmation(ConsentStatus consent) async {
    return await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Withdraw Consent?'),
        content: Text(
          'You are about to withdraw consent for "${consent.displayName}".\n\n'
          'This may affect your ability to use certain features.',
        ),
        actions: [
          VlvtButton.text(
            label: 'Cancel',
            onPressed: () => Navigator.of(context).pop(false),
          ),
          VlvtButton.primary(
            label: 'Withdraw',
            onPressed: () => Navigator.of(context).pop(true),
          ),
        ],
      ),
    ) ?? false;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Privacy Preferences'),
      ),
      body: _isLoading
          ? const Center(child: CircularProgressIndicator())
          : ListView(
              children: [
                Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text(
                        'Manage Your Data',
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Control how VLVT uses your data. You can withdraw consent at any time without affecting your account.',
                        style: TextStyle(
                          fontSize: 14,
                          color: VlvtColors.textMuted,
                        ),
                      ),
                    ],
                  ),
                ),
                const Divider(),
                ..._consents.map((consent) => _buildConsentTile(consent)),
                const Divider(),
                Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Text(
                    'These settings help us provide a better experience while respecting your privacy. '
                    'Some features may require certain consents to function properly.',
                    style: TextStyle(
                      fontSize: 12,
                      color: VlvtColors.textMuted,
                    ),
                  ),
                ),
              ],
            ),
    );
  }

  Widget _buildConsentTile(ConsentStatus consent) {
    final isGranted = _pendingChanges[consent.purpose] ?? consent.granted;

    return SwitchListTile(
      title: Row(
        children: [
          Text(consent.displayName),
          if (consent.needsRenewal) ...[
            const SizedBox(width: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
              decoration: BoxDecoration(
                color: VlvtColors.warning,
                borderRadius: BorderRadius.circular(4),
              ),
              child: const Text(
                'Update Required',
                style: TextStyle(fontSize: 10, color: Colors.white),
              ),
            ),
          ],
        ],
      ),
      subtitle: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(consent.description),
          if (consent.grantedAt != null && consent.granted)
            Padding(
              padding: const EdgeInsets.only(top: 4),
              child: Text(
                'Granted on ${_formatDate(consent.grantedAt!)}',
                style: TextStyle(
                  fontSize: 11,
                  color: VlvtColors.textMuted,
                ),
              ),
            ),
        ],
      ),
      value: isGranted,
      onChanged: (value) => _handleConsentChange(consent, value),
      activeColor: VlvtColors.primary,
    );
  }

  String _formatDate(DateTime date) {
    return '${date.month}/${date.day}/${date.year}';
  }
}
```
  </action>
  <verify>Run `flutter analyze frontend` and confirm no errors in consent_settings_screen.dart</verify>
  <done>ConsentSettingsScreen displays all consent purposes with toggle switches</done>
</task>

<task type="auto">
  <name>Task 3: Add consent settings link to Safety Settings</name>
  <files>frontend/lib/screens/safety_settings_screen.dart</files>
  <action>
Add a link to ConsentSettingsScreen in the SafetySettingsScreen.

Import the new screen at the top:
```dart
import 'consent_settings_screen.dart';
```

Add a new ListTile in the "Privacy & Legal" section (added in 02-01) for "Privacy Preferences":

```dart
ListTile(
  leading: const Icon(Icons.privacy_tip_outlined),
  title: const Text('Privacy Preferences'),
  subtitle: const Text('Manage your data and consent settings'),
  trailing: const Icon(Icons.chevron_right),
  onTap: () {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const ConsentSettingsScreen(),
      ),
    );
  },
),
```

Place this ListTile after the Privacy Policy link and before Terms of Service.
  </action>
  <verify>Run `flutter analyze frontend` and confirm no errors in safety_settings_screen.dart</verify>
  <done>Safety Settings screen has link to Privacy Preferences (ConsentSettingsScreen)</done>
</task>

</tasks>

<verification>
1. `flutter analyze frontend` - no errors
2. ConsentSettingsScreen exists and displays consent toggles
3. AuthService has getConsents(), grantConsent(), withdrawConsent()
4. Safety Settings has link to Privacy Preferences
</verification>

<success_criteria>
- AuthService has methods for consent management
- ConsentSettingsScreen shows all 4 consent purposes
- Each consent has toggle switch that calls API
- Withdrawing consent shows confirmation dialog
- Privacy Preferences accessible from Safety Settings
- No Flutter analyze errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-gdpr-compliance/02-04-SUMMARY.md`
</output>
