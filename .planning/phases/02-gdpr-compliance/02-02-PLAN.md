---
phase: 02-gdpr-compliance
plan: 02
type: execute
wave: 2
depends_on: []
files_modified:
  - backend/auth-service/src/index.ts
  - backend/auth-service/package.json
  - backend/profile-service/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Account deletion removes all user photos from R2 storage"
    - "R2 deletion happens before database deletion to prevent orphaned photos"
    - "Photo deletion failures are logged but do not block account deletion"
  artifacts:
    - path: "backend/auth-service/src/index.ts"
      provides: "R2 photo cleanup in account deletion"
      contains: "deleteUserPhotos"
    - path: "backend/auth-service/package.json"
      provides: "Axios dependency for profile-service call"
      contains: "axios"
    - path: "backend/profile-service/src/index.ts"
      provides: "Internal photo cleanup endpoint"
      contains: "/api/internal/cleanup-photos"
  key_links:
    - from: "backend/auth-service/src/index.ts"
      to: "profile-service"
      via: "HTTP call to get photo keys"
      pattern: "profiles.*photos|axios"
---

<objective>
Complete R2 photo deletion in account deletion endpoint

Purpose: Close critical GDPR-04 gap. Currently, the account deletion endpoint deletes database records via CASCADE but leaves photos orphaned in R2 storage. This violates Right to Erasure (Article 17).

Output: Account deletion endpoint fetches user's photo keys from profiles table and calls profile-service's deleteUserPhotos utility (or makes direct R2 calls) before database deletion.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gdpr-compliance/02-RESEARCH.md

# Existing files
@backend/auth-service/src/index.ts
@backend/profile-service/src/utils/r2-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HTTP client dependency to auth-service</name>
  <files>backend/auth-service/package.json</files>
  <action>
Add axios as a dependency to auth-service for making internal service calls:

```bash
cd backend/auth-service && npm install axios
```

Axios is preferred over fetch for:
- Better error handling
- Automatic JSON parsing
- Request/response interceptors (future use)
  </action>
  <verify>Run `cd backend/auth-service && npm ls axios` shows axios installed</verify>
  <done>axios is listed in auth-service package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Integrate R2 photo cleanup into account deletion</name>
  <files>backend/auth-service/src/index.ts</files>
  <action>
Modify the DELETE /auth/account endpoint to clean up R2 photos before database deletion.

Import axios at the top:
```typescript
import axios from 'axios';
```

Inside the endpoint, BEFORE the BEGIN transaction:

1. Query the profiles table to get the user's photo keys:
```typescript
const photosResult = await pool.query(
  'SELECT photos FROM profiles WHERE user_id = $1',
  [userId]
);
const photoKeys: string[] = photosResult.rows[0]?.photos || [];
```

2. If photos exist, call profile-service to delete them:
```typescript
if (photoKeys.length > 0) {
  const profileServiceUrl = process.env.PROFILE_SERVICE_URL || 'http://localhost:3002';
  try {
    // Call profile-service internal endpoint to delete photos
    // This endpoint already exists and handles R2 deletion
    await axios.post(
      `${profileServiceUrl}/api/internal/cleanup-photos`,
      { userId, photoKeys },
      {
        headers: { 'X-Internal-Service': 'auth-service' },
        timeout: 30000 // 30 second timeout for R2 operations
      }
    );
    logger.info('R2 photos deleted for account deletion', { userId, photoCount: photoKeys.length });
  } catch (photoError) {
    // Log but don't block account deletion - photos are secondary to user data rights
    logger.warn('Failed to delete R2 photos during account deletion', {
      userId,
      error: (photoError as Error).message,
      photoCount: photoKeys.length
    });
  }
}
```

IMPORTANT: Photo deletion must happen BEFORE the database transaction because:
- Once user is deleted, we lose the photo keys
- R2 failure should not block Right to Erasure

Add PROFILE_SERVICE_URL to the env vars documentation comment at top of file.
  </action>
  <verify>
Read backend/auth-service/src/index.ts and confirm:
1. axios import exists
2. DELETE /auth/account queries profiles table for photos
3. Calls profile-service cleanup endpoint before BEGIN
4. Has try-catch that logs but doesn't block on failure
  </verify>
  <done>Account deletion endpoint fetches photo keys and calls R2 cleanup before database deletion</done>
</task>

<task type="auto">
  <name>Task 3: Create internal photo cleanup endpoint in profile-service</name>
  <files>backend/profile-service/src/index.ts</files>
  <action>
Add an internal-only endpoint for photo cleanup that auth-service can call.

Add this endpoint BEFORE the existing routes (after middleware setup):

```typescript
// ===== INTERNAL ENDPOINTS =====
// These are called by other services, not directly by clients

/**
 * Internal endpoint for cleaning up user photos during account deletion
 * Called by auth-service DELETE /auth/account
 * NOT rate limited (internal only)
 */
app.post('/api/internal/cleanup-photos', async (req: Request, res: Response) => {
  // Verify internal service header
  const internalHeader = req.headers['x-internal-service'];
  if (internalHeader !== 'auth-service') {
    logger.warn('Unauthorized internal endpoint access attempt', {
      header: internalHeader,
      ip: req.ip
    });
    return res.status(403).json({ success: false, error: 'Internal endpoint only' });
  }

  const { userId, photoKeys } = req.body;

  if (!userId || !Array.isArray(photoKeys)) {
    return res.status(400).json({ success: false, error: 'Invalid request body' });
  }

  try {
    const result = await deleteUserPhotos(userId, photoKeys);
    logger.info('Internal photo cleanup completed', { userId, ...result });
    res.json({ success: true, ...result });
  } catch (error) {
    logger.error('Internal photo cleanup failed', { userId, error });
    res.status(500).json({ success: false, error: 'Photo cleanup failed' });
  }
});
```

Security considerations:
- Only accepts X-Internal-Service: auth-service header
- No JWT auth (service-to-service call)
- Logs unauthorized access attempts
- Returns result counts for audit trail
  </action>
  <verify>
Read backend/profile-service/src/index.ts and confirm:
1. /api/internal/cleanup-photos endpoint exists
2. Validates X-Internal-Service header
3. Calls deleteUserPhotos utility
4. Returns success with deleted/failed counts
  </verify>
  <done>Profile-service has internal endpoint for photo cleanup that auth-service can call</done>
</task>

</tasks>

<verification>
1. `cd backend/auth-service && npm ls axios` - axios installed
2. Read auth-service/src/index.ts - DELETE /auth/account calls photo cleanup
3. Read profile-service/src/index.ts - internal cleanup endpoint exists
4. `cd backend/auth-service && npm run build` - TypeScript compiles without errors
5. `cd backend/profile-service && npm run build` - TypeScript compiles without errors
</verification>

<success_criteria>
- axios dependency in auth-service package.json
- DELETE /auth/account fetches photo keys from profiles table
- DELETE /auth/account calls profile-service cleanup before database deletion
- profile-service has /api/internal/cleanup-photos endpoint
- Both services compile without TypeScript errors
- Photo deletion failures logged but don't block account deletion
</success_criteria>

<output>
After completion, create `.planning/phases/02-gdpr-compliance/02-02-SUMMARY.md`
</output>
