---
phase: 01-security-hardening
plan: 05
type: execute
wave: 3
depends_on: ["01-04"]
files_modified:
  - backend/auth-service/src/services/kycaid-service.ts
  - backend/auth-service/src/routes/kycaid-routes.ts
  - backend/auth-service/scripts/migrate-kycaid-encryption.ts
  - .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md
autonomous: true
user_setup: []
gap_closure: true

must_haves:
  truths:
    - "New KYCAID verifications store PII in encrypted_pii column"
    - "Plaintext columns (first_name, last_name, etc.) are NOT populated for new verifications"
    - "Existing plaintext data has migration script to encrypt it"
    - "KYCAID_ENCRYPTION_KEY requirement is documented"
  artifacts:
    - path: "backend/auth-service/src/services/kycaid-service.ts"
      provides: "KYCAID service with encryption support"
      contains: "encryptPii"
    - path: "backend/auth-service/scripts/migrate-kycaid-encryption.ts"
      provides: "Data migration script for existing KYCAID data"
    - path: ".planning/phases/01-foundation-safety/SECURITY-DECISIONS.md"
      provides: "SEC-02 decision documentation"
      contains: "SEC-02"
  key_links:
    - from: "kycaid-service.ts"
      to: "encrypted_pii column"
      via: "encrypt_kycaid_pii SQL function"
      pattern: "encrypt_kycaid_pii"
---

<objective>
Close Gap 1: Enforce KYCAID encryption at rest (SEC-02).

Purpose: The migration 014_encrypt_kycaid_pii.sql created the encryption schema but application code was never updated to use it. New KYCAID verifications still write to plaintext columns. This plan wires the application to the encryption schema.

Output:
- KYCAID service updated to use encrypted_pii column
- Data migration script for existing plaintext data
- SEC-02 documented with location encryption deferred to v2 (architectural decision)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-safety/01-VERIFICATION.md
@.planning/phases/01-foundation-safety/01-04-SUMMARY.md
@backend/migrations/014_encrypt_kycaid_pii.sql
@backend/auth-service/src/services/kycaid-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add encryption helper functions to KYCAID service</name>
  <files>backend/auth-service/src/services/kycaid-service.ts</files>
  <action>
    Add encryption/decryption helper functions that call the PostgreSQL functions created in migration 014:

    1. Add at the top (after imports):
    ```typescript
    // Encryption key from environment - required in production
    function getEncryptionKey(): string {
      const key = process.env.KYCAID_ENCRYPTION_KEY;
      if (!key) {
        if (process.env.NODE_ENV === 'production') {
          throw new Error('KYCAID_ENCRYPTION_KEY must be set in production');
        }
        // Allow dev without encryption key (logs warning)
        console.warn('[SECURITY] KYCAID_ENCRYPTION_KEY not set - encryption disabled in development');
        return '';
      }
      return key;
    }
    ```

    2. Add helper to encrypt PII data for database storage:
    ```typescript
    export interface KycaidPiiData {
      first_name?: string;
      last_name?: string;
      date_of_birth?: string;
      document_number?: string;
      document_expiry?: string;
    }

    /**
     * Prepare PII data for encrypted storage
     * Returns SQL fragment for INSERT/UPDATE using encrypt_kycaid_pii function
     */
    export function prepareEncryptedPii(pii: KycaidPiiData): { sql: string; params: [string, string] } | null {
      const key = getEncryptionKey();
      if (!key) {
        // No encryption in dev without key
        return null;
      }
      return {
        sql: 'encrypt_kycaid_pii($1::jsonb, $2)',
        params: [JSON.stringify(pii), key]
      };
    }
    ```

    3. Update extractVerifiedUserData to also return the PII object for storage:
    ```typescript
    export function extractVerifiedUserData(callback: KycaidCallbackData): {
      // ... existing fields ...
      piiForStorage?: KycaidPiiData;  // Add this field
    } {
      const doc = callback.verifications?.document;
      // ... existing code ...

      return {
        // ... existing fields ...
        piiForStorage: {
          first_name: doc?.first_name,
          last_name: doc?.last_name,
          date_of_birth: doc?.dob,
          document_number: doc?.document_number,
          document_expiry: doc?.expiry_date,
        },
      };
    }
    ```
  </action>
  <verify>
    - kycaid-service.ts exports prepareEncryptedPii function
    - kycaid-service.ts exports KycaidPiiData interface
    - `cd backend/auth-service && npm run build` succeeds
  </verify>
  <done>KYCAID service has encryption helpers ready for database integration</done>
</task>

<task type="auto">
  <name>Task 2: Create data migration script for existing KYCAID data</name>
  <files>backend/auth-service/scripts/migrate-kycaid-encryption.ts</files>
  <action>
    Create a TypeScript script that migrates existing plaintext KYCAID data to encrypted storage:

    ```typescript
    #!/usr/bin/env npx ts-node
    /**
     * KYCAID Data Migration Script
     *
     * Migrates existing plaintext KYCAID PII data to encrypted_pii column.
     * This is a one-time migration that should be run after setting KYCAID_ENCRYPTION_KEY.
     *
     * Usage:
     *   DATABASE_URL=... KYCAID_ENCRYPTION_KEY=... npx ts-node scripts/migrate-kycaid-encryption.ts
     *
     * Options:
     *   --dry-run    Show what would be migrated without making changes
     *   --batch=N    Process N records at a time (default: 100)
     */

    import { Pool } from 'pg';

    const BATCH_SIZE = parseInt(process.argv.find(a => a.startsWith('--batch='))?.split('=')[1] || '100');
    const DRY_RUN = process.argv.includes('--dry-run');

    async function main() {
      // Validate environment
      const databaseUrl = process.env.DATABASE_URL;
      const encryptionKey = process.env.KYCAID_ENCRYPTION_KEY;

      if (!databaseUrl) {
        console.error('ERROR: DATABASE_URL environment variable is required');
        process.exit(1);
      }

      if (!encryptionKey) {
        console.error('ERROR: KYCAID_ENCRYPTION_KEY environment variable is required');
        console.error('Generate a 32-byte key: openssl rand -base64 32');
        process.exit(1);
      }

      console.log('KYCAID Data Migration Script');
      console.log('============================');
      console.log(`Mode: ${DRY_RUN ? 'DRY RUN' : 'LIVE'}`);
      console.log(`Batch size: ${BATCH_SIZE}`);
      console.log('');

      // Connect to database
      const pool = new Pool({
        connectionString: databaseUrl,
        ssl: databaseUrl.includes('railway') ? { rejectUnauthorized: false } : false
      });

      try {
        // Count records needing migration (have plaintext, no encrypted)
        const countResult = await pool.query(`
          SELECT COUNT(*) as count
          FROM kycaid_verifications
          WHERE encrypted_pii IS NULL
            AND (first_name IS NOT NULL OR last_name IS NOT NULL)
        `);

        const totalCount = parseInt(countResult.rows[0].count);
        console.log(`Records to migrate: ${totalCount}`);

        if (totalCount === 0) {
          console.log('No records need migration. Exiting.');
          return;
        }

        if (DRY_RUN) {
          console.log('');
          console.log('DRY RUN - No changes will be made.');
          console.log('Remove --dry-run flag to perform migration.');
          return;
        }

        // Process in batches
        let migrated = 0;
        let errors = 0;

        while (migrated < totalCount) {
          // Fetch batch of records
          const batchResult = await pool.query(`
            SELECT id, first_name, last_name, date_of_birth, document_number, document_expiry
            FROM kycaid_verifications
            WHERE encrypted_pii IS NULL
              AND (first_name IS NOT NULL OR last_name IS NOT NULL)
            LIMIT $1
          `, [BATCH_SIZE]);

          if (batchResult.rows.length === 0) break;

          // Migrate each record
          for (const row of batchResult.rows) {
            try {
              const piiData = JSON.stringify({
                first_name: row.first_name,
                last_name: row.last_name,
                date_of_birth: row.date_of_birth,
                document_number: row.document_number,
                document_expiry: row.document_expiry
              });

              await pool.query(`
                UPDATE kycaid_verifications
                SET encrypted_pii = encrypt_kycaid_pii($1::jsonb, $2),
                    first_name = NULL,
                    last_name = NULL,
                    date_of_birth = NULL,
                    document_number = NULL,
                    document_expiry = NULL
                WHERE id = $3
              `, [piiData, encryptionKey, row.id]);

              migrated++;
              process.stdout.write(`\rMigrated: ${migrated}/${totalCount}`);
            } catch (err) {
              errors++;
              console.error(`\nError migrating record ${row.id}:`, err);
            }
          }
        }

        console.log('');
        console.log('');
        console.log('Migration Complete');
        console.log('==================');
        console.log(`Migrated: ${migrated}`);
        console.log(`Errors: ${errors}`);

        if (errors > 0) {
          console.log('');
          console.log('WARNING: Some records failed to migrate. Review errors above.');
          process.exit(1);
        }

      } finally {
        await pool.end();
      }
    }

    main().catch(err => {
      console.error('Migration failed:', err);
      process.exit(1);
    });
    ```

    Also update package.json scripts section to add:
    ```json
    "migrate:kycaid-encryption": "npx ts-node scripts/migrate-kycaid-encryption.ts"
    ```
  </action>
  <verify>
    - scripts/migrate-kycaid-encryption.ts exists
    - Script has --dry-run option for safe testing
    - `cd backend/auth-service && npm run build` succeeds (script compiles)
  </verify>
  <done>Data migration script ready for encrypting existing KYCAID data</done>
</task>

<task type="auto">
  <name>Task 3: Document SEC-02 decision with location encryption deferred</name>
  <files>.planning/phases/01-foundation-safety/SECURITY-DECISIONS.md</files>
  <action>
    Update SECURITY-DECISIONS.md to add SEC-02 documentation:

    Add new section after SEC-01:

    ```markdown
    ---

    ## SEC-02: Encryption at Rest

    **Decision:** Implement encryption for KYCAID PII data; defer location encryption to v2.

    **Status:** PARTIALLY IMPLEMENTED

    **Context:**
    The success criteria states: "Sensitive data fields are encrypted at rest (KYCAID verification data, exact locations)"

    This covers two distinct data types:
    1. KYCAID verification data (government ID details)
    2. User location coordinates (latitude/longitude)

    **KYCAID Data - IMPLEMENTED:**
    - Migration 014_encrypt_kycaid_pii.sql creates AES-256 encryption functions
    - Application code updated to use encrypted_pii column for new verifications
    - Data migration script encrypts existing plaintext data
    - Plaintext columns cleared after migration

    **Location Data - DEFERRED TO v2:**
    Location encryption requires significant architectural changes:
    1. Distance calculations must work on encrypted data (homomorphic encryption or trusted compute)
    2. Geospatial indexes don't work on encrypted coordinates
    3. Every discovery query would need to decrypt all profiles within radius

    Alternative mitigations in place:
    - Location coordinates are redacted from logs (SEC-07 complete)
    - Location is obfuscated to ~500m precision in API responses
    - Exact coordinates never exposed to other users

    **Rationale:**
    KYCAID data (government IDs, personal details) is the highest-value target and can be encrypted without architectural impact. Location encryption would require a fundamental redesign of the discovery system and is better addressed as a v2 research item.

    **Implementation:**
    - backend/auth-service/src/services/kycaid-service.ts - encryption helpers
    - backend/auth-service/scripts/migrate-kycaid-encryption.ts - data migration
    - backend/migrations/014_encrypt_kycaid_pii.sql - database schema

    **Environment Variables:**
    - KYCAID_ENCRYPTION_KEY: Required in production. 32-byte random key.
      Generate with: `openssl rand -base64 32`

    ---
    ```
  </action>
  <verify>
    - SECURITY-DECISIONS.md has SEC-02 section
    - Document explains KYCAID encryption implementation
    - Document explains location encryption deferral rationale
    - KYCAID_ENCRYPTION_KEY requirement documented
  </verify>
  <done>SEC-02 decision documented with implementation details and v2 deferral</done>
</task>

</tasks>

<verification>
1. Check encryption helpers exist:
```bash
grep -n "prepareEncryptedPii" backend/auth-service/src/services/kycaid-service.ts
grep -n "KycaidPiiData" backend/auth-service/src/services/kycaid-service.ts
```

2. Check migration script exists:
```bash
ls -la backend/auth-service/scripts/migrate-kycaid-encryption.ts
```

3. Check documentation:
```bash
grep "SEC-02" .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md
grep "KYCAID_ENCRYPTION_KEY" .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md
```

4. Build service:
```bash
cd backend/auth-service && npm run build
```
</verification>

<success_criteria>
1. KYCAID service exports encryption helper functions
2. Data migration script exists with --dry-run safety
3. SEC-02 documented explaining KYCAID implementation and location deferral
4. KYCAID_ENCRYPTION_KEY environment variable documented
5. auth-service builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-05-SUMMARY.md`
</output>
