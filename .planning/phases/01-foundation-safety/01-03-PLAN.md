---
phase: 01-security-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/chat-service/package.json
  - backend/chat-service/package-lock.json
  - backend/chat-service/src/socket/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "socket.io-redis package is removed from chat-service"
    - "@socket.io/redis-adapter package is installed"
    - "Socket.IO server initializes successfully with new adapter (or without adapter if Redis unavailable)"
  artifacts:
    - path: "backend/chat-service/package.json"
      provides: "Updated Socket.IO adapter dependency"
      contains: "@socket.io/redis-adapter"
    - path: "backend/chat-service/src/socket/index.ts"
      provides: "Socket.IO initialization with modern adapter"
  key_links:
    - from: "backend/chat-service/src/socket/index.ts"
      to: "@socket.io/redis-adapter"
      via: "createAdapter import"
      pattern: "createAdapter"
---

<objective>
Migrate from deprecated socket.io-redis to @socket.io/redis-adapter (SEC-09).

Purpose: The socket.io-redis package (v6.1.1) is deprecated and no longer maintained. The modern @socket.io/redis-adapter provides the same functionality with active maintenance and security updates. This migration is backward-compatible at the protocol level.

Output: chat-service using @socket.io/redis-adapter with the same Redis pub/sub functionality for Socket.IO horizontal scaling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-safety/01-RESEARCH.md
@backend/chat-service/src/socket/index.ts
@backend/chat-service/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace socket.io-redis with @socket.io/redis-adapter</name>
  <files>backend/chat-service/package.json, backend/chat-service/package-lock.json</files>
  <action>
    1. Navigate to backend/chat-service

    2. Remove the deprecated package:
       `npm uninstall socket.io-redis`

    3. Install the modern adapter:
       `npm install @socket.io/redis-adapter@^8.3.0`

    4. Note: The chat-service already has `ioredis` installed (used in after-hours-handler.ts and message-cleanup-job.ts), so no additional Redis client is needed.

    5. Verify package.json no longer contains socket.io-redis and does contain @socket.io/redis-adapter.
  </action>
  <verify>
    - `package.json` does NOT contain "socket.io-redis"
    - `package.json` contains "@socket.io/redis-adapter"
    - `npm ls @socket.io/redis-adapter` shows it installed
  </verify>
  <done>Deprecated package removed, modern adapter installed</done>
</task>

<task type="auto">
  <name>Task 2: Update Socket.IO initialization to use new adapter</name>
  <files>backend/chat-service/src/socket/index.ts</files>
  <action>
    Update backend/chat-service/src/socket/index.ts to optionally use the Redis adapter when REDIS_URL is available.

    Add the following imports at the top of the file:
    ```typescript
    import { createAdapter } from '@socket.io/redis-adapter';
    import IORedis from 'ioredis';
    ```

    Inside the `initializeSocketIO` function, AFTER creating the Socket.IO server (`const io = new SocketServer(...)`) but BEFORE the logging statement, add:

    ```typescript
    // Configure Redis adapter for horizontal scaling (optional)
    // If Redis is unavailable, Socket.IO works in single-instance mode
    const redisUrl = process.env.REDIS_URL;
    if (redisUrl) {
      try {
        const pubClient = new IORedis(redisUrl);
        const subClient = pubClient.duplicate();

        // Wait for both clients to connect
        await Promise.all([
          new Promise<void>((resolve, reject) => {
            pubClient.once('ready', resolve);
            pubClient.once('error', reject);
          }),
          new Promise<void>((resolve, reject) => {
            subClient.once('ready', resolve);
            subClient.once('error', reject);
          }),
        ]);

        io.adapter(createAdapter(pubClient, subClient));
        logger.info('Socket.IO Redis adapter configured for horizontal scaling');
      } catch (error) {
        logger.warn('Failed to configure Redis adapter, running in single-instance mode', {
          error: error instanceof Error ? error.message : 'Unknown error',
        });
      }
    } else {
      logger.info('REDIS_URL not set, Socket.IO running in single-instance mode');
    }
    ```

    Note: The function signature may need to change to `async` if it isn't already. Check the calling code in index.ts to ensure it awaits the result.

    IMPORTANT: The existing `initializeAfterHoursRedisSubscriber` call uses a separate Redis connection for pub/sub messages about matches - that is DIFFERENT from the Socket.IO adapter. Both can coexist and serve different purposes:
    - Socket.IO adapter: For broadcasting Socket.IO events across multiple server instances
    - After Hours subscriber: For receiving match events from profile-service via Redis pub/sub
  </action>
  <verify>
    - File imports `createAdapter` from '@socket.io/redis-adapter'
    - File imports `IORedis` from 'ioredis'
    - Redis adapter setup is conditional on REDIS_URL
    - File compiles: `npm run build`
  </verify>
  <done>Socket.IO initialization updated with modern Redis adapter</done>
</task>

<task type="auto">
  <name>Task 3: Update main index.ts if needed and verify</name>
  <files>backend/chat-service/src/index.ts, backend/chat-service/src/socket/index.ts</files>
  <action>
    1. Check if initializeSocketIO is called with await in index.ts. If not, the function becoming async could cause issues.

    2. Look at how initializeSocketIO is called in backend/chat-service/src/index.ts. If it's NOT awaited:
       - Wrap the Socket.IO setup in an async IIFE, OR
       - Make the adapter setup fire-and-forget with .catch() error handling

    3. Build the service: `npm run build`

    4. Run tests: `npm test`

    5. Test startup manually (optional - kill after confirming):
       - Without REDIS_URL: Service should start, log "running in single-instance mode"
       - With REDIS_URL: Service should start, log "Redis adapter configured" (requires Redis)
  </action>
  <verify>
    - `npm run build` succeeds without TypeScript errors
    - `npm test` passes
    - Service starts without crashing when REDIS_URL is not set
  </verify>
  <done>Socket.IO adapter migration complete and verified</done>
</task>

</tasks>

<verification>
1. Package verification:
```bash
cd backend/chat-service
grep "socket.io-redis" package.json  # Should return nothing
grep "@socket.io/redis-adapter" package.json  # Should find it
```

2. Code verification:
```bash
grep "createAdapter" backend/chat-service/src/socket/index.ts
```

3. Build verification:
```bash
cd backend/chat-service && npm run build && npm test
```
</verification>

<success_criteria>
1. socket.io-redis is completely removed from package.json and package-lock.json
2. @socket.io/redis-adapter is installed at version ^8.3.0
3. Socket.IO initialization conditionally uses Redis adapter when REDIS_URL is set
4. Service builds without TypeScript errors
5. All tests pass
6. Service starts successfully without Redis (graceful degradation)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-03-SUMMARY.md`
</output>
