---
phase: 01-foundation-safety
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/shared/src/middleware/after-hours-auth.ts
  - backend/shared/src/middleware/index.ts
autonomous: true

must_haves:
  truths:
    - "Non-premium users receive 403 with PREMIUM_REQUIRED code"
    - "Non-verified users receive 403 with VERIFICATION_REQUIRED code"
    - "Users without After Hours consent receive 403 with CONSENT_REQUIRED code"
    - "Database errors result in 500 (fail closed, not fail open)"
    - "All checks run server-side, not bypassable by client"
  artifacts:
    - path: "backend/shared/src/middleware/after-hours-auth.ts"
      provides: "After Hours authorization middleware"
      exports: ["createAfterHoursAuthMiddleware", "AfterHoursAuthOptions"]
      min_lines: 60
  key_links:
    - from: "after-hours-auth.ts"
      to: "user_subscriptions table"
      via: "SQL query for premium status"
      pattern: "SELECT.*FROM user_subscriptions"
    - from: "after-hours-auth.ts"
      to: "users.id_verified column"
      via: "SQL query for verification status"
      pattern: "SELECT.*id_verified.*FROM users"
    - from: "after-hours-auth.ts"
      to: "users.after_hours_consent column"
      via: "SQL query for consent status"
      pattern: "SELECT.*after_hours_consent.*FROM users"
---

<objective>
Create authorization middleware that gates After Hours endpoints behind premium subscription, ID verification, and GDPR consent.

Purpose: Security-critical middleware that MUST fail closed. All three conditions (premium, verified, consented) must be true for access. This middleware will be applied to all After Hours API routes.

Output: `after-hours-auth.ts` middleware factory following existing `subscription-middleware.ts` patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-safety/01-RESEARCH.md

# Existing middleware patterns (MUST follow these conventions)
@backend/shared/subscription-middleware.ts
@backend/shared/src/middleware/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create After Hours auth middleware</name>
  <files>backend/shared/src/middleware/after-hours-auth.ts</files>
  <action>
Create `after-hours-auth.ts` following the factory pattern from `subscription-middleware.ts`.

**Interface:**
```typescript
export interface AfterHoursAuthOptions {
  pool: Pool;
  logger?: Logger;  // Optional, defaults to shared logger
}
```

**Factory function:** `createAfterHoursAuthMiddleware(options: AfterHoursAuthOptions)`

Returns Express middleware that performs THREE checks in sequence:

**Check 1: Premium subscription (FAIL CLOSED)**
```sql
SELECT is_active, expires_at FROM user_subscriptions
WHERE user_id = $1 AND is_active = true
AND (expires_at IS NULL OR expires_at > NOW())
ORDER BY expires_at DESC NULLS FIRST
LIMIT 1
```
- If no rows: Return 403 with `{ success: false, error: 'Premium subscription required...', code: 'PREMIUM_REQUIRED', upgrade: true }`

**Check 2: ID verification (FAIL CLOSED)**
```sql
SELECT id_verified FROM users WHERE id = $1
```
- If `id_verified` is false/null: Return 403 with `{ success: false, error: 'ID verification required...', code: 'VERIFICATION_REQUIRED', requiresVerification: true }`

**Check 3: GDPR consent for After Hours location (FAIL CLOSED)**
```sql
SELECT after_hours_consent FROM users WHERE id = $1
```
- If `after_hours_consent` is false/null: Return 403 with `{ success: false, error: 'Location sharing consent required...', code: 'CONSENT_REQUIRED', requiresConsent: true }`

**Error handling:**
- Catch all database errors
- Log error with `logger.error('After Hours auth middleware error', { error, userId })`
- Return 500 with `{ success: false, error: 'Unable to verify After Hours access', code: 'AUTH_ERROR' }`
- NEVER call `next()` on error (fail closed)

**Logging:**
- Log info on each denial: `'After Hours access denied: no active subscription'`, `'...not verified'`, `'...no location consent'`
- Include `{ userId }` in all log calls

**TypeScript:**
- Import `Request, Response, NextFunction` from 'express'
- Import `Pool` from 'pg'
- Expect `req.user.userId` to be set by upstream auth middleware
- Return type: `(req: Request, res: Response, next: NextFunction) => Promise<void>`
  </action>
  <verify>
```bash
cd backend/shared && cat src/middleware/after-hours-auth.ts | head -100
```
Verify middleware exists with all three checks and proper error responses.
  </verify>
  <done>
Middleware file exists with:
- Factory pattern matching existing conventions
- Premium check with proper query
- Verification check
- Consent check
- Fail-closed error handling
- Proper TypeScript types
- Informative error responses with codes
  </done>
</task>

<task type="auto">
  <name>Task 2: Export middleware from shared index</name>
  <files>backend/shared/src/middleware/index.ts</files>
  <action>
Check if `backend/shared/src/middleware/index.ts` exists. If it does, add export for the new middleware:

```typescript
export { createAfterHoursAuthMiddleware, AfterHoursAuthOptions } from './after-hours-auth';
```

If the index file doesn't exist, create it with exports for the new middleware.

This allows consuming services to import via:
```typescript
import { createAfterHoursAuthMiddleware } from '@vlvt/shared/middleware';
```
  </action>
  <verify>
```bash
cd backend/shared && cat src/middleware/index.ts
```
Verify export statement exists for `createAfterHoursAuthMiddleware`.
  </verify>
  <done>
Middleware is exported from shared package index for clean imports.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for After Hours auth middleware</name>
  <files>backend/shared/tests/middleware/after-hours-auth.test.ts</files>
  <action>
Create test file for the After Hours auth middleware.

**Test setup:**
- Mock `pg.Pool` with jest
- Mock `Request`, `Response`, `NextFunction`
- Create test user IDs

**Test cases:**

1. **Premium + Verified + Consented = ALLOWED**
   - Mock: subscription active, id_verified true, after_hours_consent true
   - Expect: `next()` called, no response sent

2. **No subscription = DENIED with PREMIUM_REQUIRED**
   - Mock: no subscription rows returned
   - Expect: 403 response with code 'PREMIUM_REQUIRED', upgrade: true

3. **Expired subscription = DENIED with PREMIUM_REQUIRED**
   - Mock: subscription exists but expires_at < NOW
   - Expect: 403 response with code 'PREMIUM_REQUIRED'

4. **Not verified = DENIED with VERIFICATION_REQUIRED**
   - Mock: subscription active, id_verified false
   - Expect: 403 response with code 'VERIFICATION_REQUIRED', requiresVerification: true

5. **No consent = DENIED with CONSENT_REQUIRED**
   - Mock: subscription active, id_verified true, after_hours_consent false
   - Expect: 403 response with code 'CONSENT_REQUIRED', requiresConsent: true

6. **Database error = DENIED with AUTH_ERROR (fail closed)**
   - Mock: pool.query throws error
   - Expect: 500 response with code 'AUTH_ERROR'
   - Expect: `next()` NOT called

7. **No user in request = DENIED with AUTH_REQUIRED**
   - Mock: req.user undefined
   - Expect: 401 response with code 'AUTH_REQUIRED'

Follow existing test patterns in the codebase.
  </action>
  <verify>
```bash
cd backend/shared && npm test -- --testPathPattern="after-hours-auth" --passWithNoTests
```
Tests should pass. If test infrastructure doesn't exist, verify test file syntax.
  </verify>
  <done>
Test file exists covering:
- Happy path (all conditions met)
- Each denial condition individually
- Fail-closed on database errors
- Missing user handling
  </done>
</task>

</tasks>

<verification>
1. Middleware file exists at `backend/shared/src/middleware/after-hours-auth.ts`
2. Middleware performs all three checks (premium, verified, consent)
3. Middleware fails closed on any error
4. Middleware is exported from index
5. Tests cover all conditions and pass
</verification>

<success_criteria>
- [ ] `after-hours-auth.ts` exists with factory pattern
- [ ] Checks premium subscription status
- [ ] Checks ID verification status
- [ ] Checks After Hours consent status
- [ ] Returns appropriate error codes for each failure
- [ ] Fails closed on database errors (500, not bypass)
- [ ] Exported from middleware index
- [ ] Tests exist and pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-03-SUMMARY.md`
</output>
