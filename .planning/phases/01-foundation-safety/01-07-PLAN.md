---
phase: 01-security-hardening
plan: 07
type: execute
wave: 3
depends_on: ["01-04"]
files_modified:
  - backend/auth-service/migrate.js
  - backend/seed-data/run-seed.js
  - backend/migrations/run_migration.js
  - backend/migrations/run_012.js
autonomous: true
user_setup: []
gap_closure: true

must_haves:
  truths:
    - "All utility scripts with rejectUnauthorized: false have SECURITY NOTE comments"
    - "Documentation standard matches main services (01-04)"
    - "SEC-01 TLS documentation is consistent across codebase"
  artifacts:
    - path: "backend/auth-service/migrate.js"
      provides: "Migration script with TLS documentation"
      contains: "SECURITY NOTE"
    - path: "backend/seed-data/run-seed.js"
      provides: "Seed script with TLS documentation"
      contains: "SECURITY NOTE"
    - path: "backend/migrations/run_migration.js"
      provides: "Migration runner with TLS documentation"
      contains: "SECURITY NOTE"
    - path: "backend/migrations/run_012.js"
      provides: "Single migration script with TLS documentation"
      contains: "SECURITY NOTE"
  key_links:
    - from: "Utility scripts"
      to: "PostgreSQL"
      via: "ssl config"
      pattern: "rejectUnauthorized.*SECURITY NOTE"
---

<objective>
Close Gap 3: Add TLS documentation to utility scripts (SEC-01 completion).

Purpose: Main services have comprehensive SECURITY NOTE comments explaining the Railway TLS limitation. Utility scripts (migrate.js, run-seed.js, run_migration.js, run_012.js) use the same TLS bypass but lack documentation. This creates an inconsistent security documentation standard.

Output: All utility scripts with rejectUnauthorized: false have SECURITY NOTE comments matching the standard established in 01-04.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-safety/01-VERIFICATION.md
@.planning/phases/01-foundation-safety/01-04-SUMMARY.md
@.planning/phases/01-foundation-safety/SECURITY-DECISIONS.md
@backend/auth-service/migrate.js
@backend/seed-data/run-seed.js
@backend/migrations/run_migration.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SECURITY NOTE to auth-service/migrate.js</name>
  <files>backend/auth-service/migrate.js</files>
  <action>
    Add SECURITY NOTE comment before the Client creation (around line 46).

    Find:
    ```javascript
    // Create database client
    const client = new Client({
      connectionString: process.env.DATABASE_URL,
      ssl: process.env.DATABASE_URL.includes('railway.app') ? { rejectUnauthorized: false } : false
    });
    ```

    Replace with:
    ```javascript
    // Create database client
    //
    // SECURITY NOTE: TLS Configuration for Railway PostgreSQL
    // =========================================================
    // Railway uses self-signed certificates for PostgreSQL connections.
    // - rejectUnauthorized: false is REQUIRED for Railway connections
    // - Connections ARE encrypted with TLS (data in transit is protected)
    // - Certificate validation cannot be performed (Railway limitation)
    //
    // This is a utility script for migrations, not a production service.
    // See: .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md (SEC-01)
    const client = new Client({
      connectionString: process.env.DATABASE_URL,
      ssl: process.env.DATABASE_URL.includes('railway.app') ? { rejectUnauthorized: false } : false
    });
    ```
  </action>
  <verify>
    - migrate.js contains "SECURITY NOTE"
    - migrate.js references SECURITY-DECISIONS.md
  </verify>
  <done>auth-service/migrate.js has TLS security documentation</done>
</task>

<task type="auto">
  <name>Task 2: Add SECURITY NOTE to seed-data/run-seed.js</name>
  <files>backend/seed-data/run-seed.js</files>
  <action>
    Add SECURITY NOTE comment before the Pool creation (around line 13).

    Find:
    ```javascript
    const pool = new Pool({
      connectionString: DATABASE_URL,
      ssl: { rejectUnauthorized: false }
    });
    ```

    Replace with:
    ```javascript
    // SECURITY NOTE: TLS Configuration for Railway PostgreSQL
    // =========================================================
    // Railway uses self-signed certificates for PostgreSQL connections.
    // - rejectUnauthorized: false is REQUIRED for Railway connections
    // - Connections ARE encrypted with TLS (data in transit is protected)
    // - Certificate validation cannot be performed (Railway limitation)
    //
    // This is a utility script for seeding test data, not a production service.
    // See: .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md (SEC-01)
    const pool = new Pool({
      connectionString: DATABASE_URL,
      ssl: DATABASE_URL.includes('railway') ? { rejectUnauthorized: false } : false
    });
    ```

    Note: Also update the ssl config to be conditional on Railway (consistent with other scripts).
  </action>
  <verify>
    - run-seed.js contains "SECURITY NOTE"
    - run-seed.js has conditional Railway detection
    - run-seed.js references SECURITY-DECISIONS.md
  </verify>
  <done>seed-data/run-seed.js has TLS security documentation</done>
</task>

<task type="auto">
  <name>Task 3: Add SECURITY NOTE to migrations/run_migration.js and run_012.js</name>
  <files>backend/migrations/run_migration.js, backend/migrations/run_012.js</files>
  <action>
    Add SECURITY NOTE comment to both migration runner scripts.

    For run_migration.js (around line 57):
    Find:
    ```javascript
    // Create database client
    const client = new Client({
      connectionString: process.env.DATABASE_URL,
      ssl: process.env.DATABASE_URL.includes('railway.app') ? { rejectUnauthorized: false } : false
    });
    ```

    Replace with:
    ```javascript
    // Create database client
    //
    // SECURITY NOTE: TLS Configuration for Railway PostgreSQL
    // =========================================================
    // Railway uses self-signed certificates for PostgreSQL connections.
    // - rejectUnauthorized: false is REQUIRED for Railway connections
    // - Connections ARE encrypted with TLS (data in transit is protected)
    // - Certificate validation cannot be performed (Railway limitation)
    //
    // This is a utility script for migrations, not a production service.
    // See: .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md (SEC-01)
    const client = new Client({
      connectionString: process.env.DATABASE_URL,
      ssl: process.env.DATABASE_URL.includes('railway.app') ? { rejectUnauthorized: false } : false
    });
    ```

    For run_012.js (around line 13):
    Find:
    ```javascript
    const client = new Client({
      connectionString: process.env.DATABASE_URL,
      ssl: process.env.DATABASE_URL.includes('railway') ? { rejectUnauthorized: false } : false
    });
    ```

    Replace with:
    ```javascript
    // SECURITY NOTE: TLS Configuration for Railway PostgreSQL
    // See: .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md (SEC-01)
    // rejectUnauthorized: false is REQUIRED - Railway uses self-signed certificates.
    // Connections ARE encrypted with TLS; only certificate validation is bypassed.
    const client = new Client({
      connectionString: process.env.DATABASE_URL,
      ssl: process.env.DATABASE_URL.includes('railway') ? { rejectUnauthorized: false } : false
    });
    ```

    Note: run_012.js gets a shorter comment since it's a single-purpose script.
  </action>
  <verify>
    - run_migration.js contains "SECURITY NOTE"
    - run_012.js contains "SECURITY NOTE"
    - Both reference SECURITY-DECISIONS.md
  </verify>
  <done>migrations/run_migration.js and run_012.js have TLS security documentation</done>
</task>

</tasks>

<verification>
1. Check all scripts have SECURITY NOTE:
```bash
grep -l "SECURITY NOTE" backend/auth-service/migrate.js backend/seed-data/run-seed.js backend/migrations/run_migration.js backend/migrations/run_012.js
```

2. Check all scripts reference documentation:
```bash
grep "SECURITY-DECISIONS.md" backend/auth-service/migrate.js backend/seed-data/run-seed.js backend/migrations/run_migration.js backend/migrations/run_012.js
```

3. Verify scripts still work (syntax check):
```bash
node --check backend/auth-service/migrate.js
node --check backend/seed-data/run-seed.js
node --check backend/migrations/run_migration.js
node --check backend/migrations/run_012.js
```
</verification>

<success_criteria>
1. All 4 utility scripts have SECURITY NOTE comments
2. All comments reference SECURITY-DECISIONS.md
3. Documentation standard matches main services from 01-04
4. Scripts pass Node.js syntax check
5. SEC-01 TLS documentation is now complete across entire codebase
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-07-SUMMARY.md`
</output>
