---
phase: 01-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/auth-service/package.json
  - backend/auth-service/package-lock.json
  - backend/profile-service/package.json
  - backend/profile-service/package-lock.json
  - backend/chat-service/package.json
  - backend/chat-service/package-lock.json
  - backend/shared/package.json
  - backend/shared/package-lock.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "npm audit shows no critical or high severity vulnerabilities in any service"
    - "All services start without errors after dependency updates"
    - "Existing tests pass after dependency updates"
  artifacts:
    - path: "backend/auth-service/package.json"
      provides: "Updated dependencies"
    - path: "backend/profile-service/package.json"
      provides: "Updated dependencies"
    - path: "backend/chat-service/package.json"
      provides: "Updated dependencies"
    - path: "backend/shared/package.json"
      provides: "Updated dependencies"
  key_links:
    - from: "package.json"
      to: "package-lock.json"
      via: "npm install regenerates lockfile"
      pattern: "version.*changed"
---

<objective>
Fix dependency vulnerabilities across all backend services (SEC-03).

Purpose: npm audit currently shows moderate vulnerabilities including @sentry/node header leak and body-parser DoS. Critical/high vulnerabilities must be resolved before beta launch to prevent known exploits.

Output: All four backend packages (auth-service, profile-service, chat-service, shared) with updated dependencies and passing npm audit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-safety/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix dependencies in shared package</name>
  <files>backend/shared/package.json, backend/shared/package-lock.json</files>
  <action>
    1. Navigate to backend/shared
    2. Run `npm audit` to get current vulnerability status
    3. Run `npm audit fix` to apply automatic fixes
    4. If any vulnerabilities remain, run `npm audit fix --force` only if the breaking changes are acceptable (check with `npm audit fix --force --dry-run` first)
    5. Run `npm install` to ensure lockfile is consistent
    6. Run `npm test` to verify tests still pass

    Note: The shared package is a dependency for other services, so fixing it first ensures downstream services get the fixes.
  </action>
  <verify>
    - `npm audit` shows 0 critical, 0 high vulnerabilities
    - `npm test` passes
  </verify>
  <done>shared package has no critical/high vulnerabilities and tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix dependencies in all services</name>
  <files>backend/auth-service/package.json, backend/auth-service/package-lock.json, backend/profile-service/package.json, backend/profile-service/package-lock.json, backend/chat-service/package.json, backend/chat-service/package-lock.json</files>
  <action>
    For each service (auth-service, profile-service, chat-service):

    1. Navigate to the service directory
    2. Run `npm audit` to capture current state
    3. Run `npm audit fix` to apply automatic fixes
    4. Check if @sentry/node is below v10.27.0 - if so, run `npm install @sentry/node@latest` to fix the header leak vulnerability (GHSA-6465-jgvq-jhgp)
    5. Check if body-parser vulnerability exists - it should be fixed transitively through express
    6. Run `npm test` to verify tests still pass
    7. Verify the service starts correctly with `npm run build && npm start` (kill after confirming startup)

    Important: Do NOT use `npm audit fix --force` unless absolutely necessary - it can introduce breaking changes. Instead, manually upgrade specific packages.
  </action>
  <verify>
    For each service:
    - `npm audit` shows 0 critical, 0 high vulnerabilities
    - `npm test` passes
    - `npm run build` succeeds
  </verify>
  <done>All three services have no critical/high vulnerabilities and tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end service health</name>
  <files>None (verification only)</files>
  <action>
    1. From backend root, run all service tests in sequence:
       - `cd backend/shared && npm test`
       - `cd backend/auth-service && npm test`
       - `cd backend/profile-service && npm test`
       - `cd backend/chat-service && npm test`

    2. Generate final audit report for documentation:
       - Create a summary of before/after vulnerability counts
       - Note any moderate/low vulnerabilities that remain (acceptable for beta)

    3. If any tests fail, investigate and fix the issue - likely due to API changes in updated packages.
  </action>
  <verify>
    - All test suites pass
    - `npm audit` in each service shows 0 critical, 0 high
  </verify>
  <done>All services verified with passing tests and clean audits</done>
</task>

</tasks>

<verification>
Run in each service directory:
```bash
npm audit 2>&1 | grep -E "(critical|high|moderate|low|found 0)"
npm test
```

Expected: No critical or high vulnerabilities in any service.
</verification>

<success_criteria>
1. `npm audit` shows 0 critical and 0 high vulnerabilities across all 4 packages
2. All existing tests pass in each service
3. Services build successfully without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-01-SUMMARY.md`
</output>
