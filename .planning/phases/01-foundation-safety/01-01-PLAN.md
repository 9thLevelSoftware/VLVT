---
phase: 01-foundation-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/migrations/021_add_after_hours_tables.sql
autonomous: true

must_haves:
  truths:
    - "After Hours tables exist in database schema"
    - "GDPR consent columns exist on users table"
    - "All foreign keys cascade on user deletion"
    - "Indexes exist for active session and match lookups"
  artifacts:
    - path: "backend/migrations/021_add_after_hours_tables.sql"
      provides: "After Hours schema migration"
      contains: "CREATE TABLE IF NOT EXISTS after_hours_profiles"
  key_links:
    - from: "after_hours_profiles.user_id"
      to: "users.id"
      via: "FOREIGN KEY with ON DELETE CASCADE"
    - from: "after_hours_sessions.user_id"
      to: "users.id"
      via: "FOREIGN KEY with ON DELETE CASCADE"
---

<objective>
Create database migration for After Hours Mode tables and GDPR consent tracking.

Purpose: Establish the data layer foundation that all subsequent After Hours features depend on. This must be correct from day one - schema changes after launch are costly.

Output: Single migration file `021_add_after_hours_tables.sql` containing all After Hours tables and consent columns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-safety/01-RESEARCH.md

# Existing schema patterns
@backend/migrations/020_token_rotation.sql
@backend/migrations/005_add_subscriptions_table.sql
@backend/migrations/011_add_kycaid_verification.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create After Hours database migration</name>
  <files>backend/migrations/021_add_after_hours_tables.sql</files>
  <action>
Create migration file following existing conventions (see 020_token_rotation.sql for format).

Include these tables with proper comments:

1. **after_hours_profiles** - Separate profile for After Hours (user_id PK, photo_url, description, timestamps)

2. **after_hours_preferences** - Matching preferences (user_id PK, seeking_gender, max_distance_km, interests array, timestamps)

3. **after_hours_sessions** - Timed sessions with location (UUID PK, user_id FK, started_at, expires_at, ended_at, latitude/longitude for exact location, fuzzed_latitude/fuzzed_longitude for display)
   - Add unique partial index for one active session per user: `WHERE ended_at IS NULL`
   - Add index on expires_at for cleanup jobs
   - Add index on fuzzed_lat/lng for proximity queries

4. **after_hours_declines** - Session-scoped declines (UUID PK, session_id FK, user_id FK, declined_user_id FK, created_at)
   - Unique constraint on (session_id, user_id, declined_user_id)
   - CASCADE delete on session_id so declines auto-clear

5. **after_hours_matches** - Ephemeral matches (UUID PK, session_id FK, user_id_1 FK, user_id_2 FK, created_at, expires_at, user1_save_vote, user2_save_vote, converted_to_match_id nullable FK to matches)

6. **after_hours_messages** - Ephemeral messages (UUID PK, match_id FK, sender_id FK, text, created_at)

7. **GDPR consent columns on users table**:
   - `after_hours_consent BOOLEAN DEFAULT FALSE`
   - `after_hours_consent_at TIMESTAMP WITH TIME ZONE`

Follow these patterns from existing migrations:
- Use `gen_random_uuid()` for UUID primary keys
- Use `VARCHAR(255)` for user_id foreign keys
- Use `TIMESTAMP WITH TIME ZONE` for all timestamps
- Use `DECIMAL(10, 8)` for latitude, `DECIMAL(11, 8)` for longitude
- Add `COMMENT ON TABLE` and `COMMENT ON COLUMN` for documentation
- Use `IF NOT EXISTS` for all CREATE statements
- Use `IF NOT EXISTS` for all ADD COLUMN statements
  </action>
  <verify>
Run syntax validation:
```bash
cd backend/migrations && cat 021_add_after_hours_tables.sql | head -100
```
Verify file exists and follows SQL syntax conventions.
  </verify>
  <done>
Migration file exists with all 6 After Hours tables, 2 GDPR consent columns, proper indexes, foreign key cascades, and documentation comments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate migration against existing schema</name>
  <files>backend/migrations/021_add_after_hours_tables.sql</files>
  <action>
Review the created migration for:

1. **Foreign key references** - Ensure all user_id references use `VARCHAR(255)` matching users.id type
2. **Table name conflicts** - Grep existing migrations for any `after_hours` prefix (should find none)
3. **Index naming** - Use `idx_tablename_column` pattern consistently
4. **Cascade behavior** - All user_id FKs should have `ON DELETE CASCADE`
5. **Comment completeness** - Every table and key column should have a comment

If any issues found, update the migration file.
  </action>
  <verify>
```bash
cd backend/migrations && grep -l "after_hours" *.sql
```
Should only return `021_add_after_hours_tables.sql`.

```bash
cd backend/migrations && grep "ON DELETE CASCADE" 021_add_after_hours_tables.sql | wc -l
```
Should return at least 8 (one for each FK to users and one for each FK to after_hours_sessions).
  </verify>
  <done>
Migration passes validation: no naming conflicts, all FKs cascade, all tables documented.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists at `backend/migrations/021_add_after_hours_tables.sql`
2. File contains CREATE TABLE statements for all 6 After Hours tables
3. File contains ALTER TABLE for GDPR consent columns
4. All foreign keys have ON DELETE CASCADE
5. Appropriate indexes exist for query patterns (active sessions, matches lookup)
6. COMMENT statements document purpose of tables and key columns
</verification>

<success_criteria>
- [ ] `021_add_after_hours_tables.sql` exists and is valid SQL
- [ ] Contains `after_hours_profiles`, `after_hours_preferences`, `after_hours_sessions`, `after_hours_declines`, `after_hours_matches`, `after_hours_messages` tables
- [ ] Contains `after_hours_consent` and `after_hours_consent_at` columns on users table
- [ ] All FKs cascade on delete
- [ ] Unique partial index enforces one active session per user
- [ ] Tables follow existing migration conventions
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-01-SUMMARY.md`
</output>
