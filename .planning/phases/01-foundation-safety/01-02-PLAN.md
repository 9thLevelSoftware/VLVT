---
phase: 01-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/shared/src/utils/logger.ts
  - backend/shared/dist/utils/logger.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Location data (latitude, longitude, coordinates) is redacted from logs"
    - "Message content (text, body, content) is redacted from logs"
    - "Existing email redaction continues to work"
  artifacts:
    - path: "backend/shared/src/utils/logger.ts"
      provides: "PII-redacting logger with location/message fields"
      contains: "latitude"
  key_links:
    - from: "backend/shared/src/utils/logger.ts"
      to: "all services"
      via: "@vlvt/shared import"
      pattern: "SENSITIVE_FIELDS"
---

<objective>
Add location and message content fields to PII redaction in shared logger (SEC-07).

Purpose: The logger currently redacts tokens, passwords, and emails, but location data (latitude, longitude) and chat message content could leak to logs. Dating app users' exact locations and private messages must never appear in logs.

Output: Updated shared logger that redacts location coordinates and message text in addition to existing PII fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-safety/01-RESEARCH.md
@backend/shared/src/utils/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SENSITIVE_FIELDS with location and message fields</name>
  <files>backend/shared/src/utils/logger.ts</files>
  <action>
    Update the SENSITIVE_FIELDS array in backend/shared/src/utils/logger.ts to include:

    Location fields to add:
    - 'latitude', 'longitude', 'lat', 'lng', 'location'
    - 'coordinates', 'coords', 'geoLocation', 'geo_location'
    - 'exactLatitude', 'exactLongitude', 'exact_latitude', 'exact_longitude'

    Message content fields to add:
    - 'text', 'messageText', 'message_text'
    - 'content', 'messageContent', 'message_content'
    - 'body', 'messageBody', 'message_body'
    - 'chatMessage', 'chat_message'

    Add these to the existing SENSITIVE_FIELDS array after the current entries.

    Also add a comment block explaining the three categories:
    - Authentication/Secrets (existing)
    - Location PII (new)
    - Message Content (new)
  </action>
  <verify>
    - SENSITIVE_FIELDS array contains 'latitude', 'longitude', 'text', 'content'
    - File compiles without TypeScript errors: `cd backend/shared && npm run build`
  </verify>
  <done>SENSITIVE_FIELDS extended with location and message fields</done>
</task>

<task type="auto">
  <name>Task 2: Test PII redaction works for new fields</name>
  <files>backend/shared/src/utils/logger.ts</files>
  <action>
    Create a quick manual verification by adding a temporary test in the logger file or running a test:

    1. Build the shared package: `cd backend/shared && npm run build`

    2. Create a simple test script or modify existing logger tests to verify:
       - Log object with `latitude: 40.7128` -> should show `latitude: '[REDACTED]'`
       - Log object with `text: 'Hello world'` -> should show `text: '[REDACTED]'`
       - Log object with nested `location: { lat: 40.7, lng: -74.0 }` -> should redact both

    3. Run existing logger tests if they exist: `npm test -- --testPathPattern=logger`

    4. Verify the redaction works for case variations (the current implementation uses toLowerCase matching):
       - 'Latitude', 'LATITUDE', 'latitude' should all be redacted

    If no logger tests exist, the visual verification of redaction in step 2 is sufficient.
  </action>
  <verify>
    - `npm run build` succeeds in backend/shared
    - Any existing logger tests pass
    - Manual log output shows [REDACTED] for latitude/longitude/text fields
  </verify>
  <done>PII redaction verified for location and message content fields</done>
</task>

<task type="auto">
  <name>Task 3: Rebuild dependent services</name>
  <files>backend/auth-service, backend/profile-service, backend/chat-service</files>
  <action>
    Since the shared logger is imported by all services, rebuild each service to pick up the changes:

    1. Rebuild shared: `cd backend/shared && npm run build`

    2. Rebuild each service (they use the compiled @vlvt/shared):
       - `cd backend/auth-service && npm run build`
       - `cd backend/profile-service && npm run build`
       - `cd backend/chat-service && npm run build`

    3. Run tests in each service to ensure nothing broke:
       - `cd backend/auth-service && npm test`
       - `cd backend/profile-service && npm test`
       - `cd backend/chat-service && npm test`

    Note: Services may need `npm install` first if the shared package version changed.
  </action>
  <verify>
    - All services build without errors
    - All service tests pass
  </verify>
  <done>All services rebuilt with updated logger and tests passing</done>
</task>

</tasks>

<verification>
1. Check logger source has new fields:
```bash
grep -E "latitude|longitude|text|content" backend/shared/src/utils/logger.ts
```

2. Verify builds:
```bash
cd backend/shared && npm run build
cd backend/auth-service && npm run build
```

3. Run service tests:
```bash
cd backend/auth-service && npm test
```
</verification>

<success_criteria>
1. SENSITIVE_FIELDS includes location fields (latitude, longitude, lat, lng, location, coordinates)
2. SENSITIVE_FIELDS includes message fields (text, content, body, messageText)
3. All services build without TypeScript errors
4. All service tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-02-SUMMARY.md`
</output>
