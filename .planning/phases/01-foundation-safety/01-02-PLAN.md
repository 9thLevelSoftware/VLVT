---
phase: 01-foundation-safety
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/profile-service/src/utils/location-fuzzer.ts
autonomous: true

must_haves:
  truths:
    - "Coordinates can be fuzzed within configurable radius"
    - "Fuzzed coordinates are rounded to 3 decimal places"
    - "Random jitter prevents trilateration attacks"
    - "Input validation rejects invalid coordinates"
  artifacts:
    - path: "backend/profile-service/src/utils/location-fuzzer.ts"
      provides: "Location fuzzing utility for After Hours"
      exports: ["fuzzLocationForAfterHours", "FuzzedCoordinates"]
      min_lines: 40
  key_links:
    - from: "location-fuzzer.ts"
      to: "After Hours session creation"
      via: "Will be imported by session endpoints in Phase 2"
---

<objective>
Create server-side location fuzzing utility for After Hours Mode privacy protection.

Purpose: Prevent trilateration attacks by adding random jitter to coordinates before rounding. This utility must exist before any location-sharing endpoints are built.

Output: `location-fuzzer.ts` utility that applies random offset + rounding to hide exact user locations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-safety/01-RESEARCH.md

# Existing geo utility pattern
@backend/profile-service/src/utils/geo-redact.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create location fuzzing utility</name>
  <files>backend/profile-service/src/utils/location-fuzzer.ts</files>
  <action>
Create `location-fuzzer.ts` in the same directory as existing `geo-redact.ts`.

Implement `fuzzLocationForAfterHours()` function:

```typescript
/**
 * Location Fuzzing for After Hours Mode
 *
 * Privacy-preserving location obfuscation to prevent trilateration attacks.
 *
 * Algorithm:
 * 1. Add random offset within specified radius (default 500m)
 * 2. Round to 3 decimal places (~111m precision)
 *
 * Result: True location hidden within ~611m maximum radius
 *
 * @see https://privacypatterns.org/patterns/Location-granularity
 */
```

Requirements:
1. **Interface:** Export `FuzzedCoordinates` type with `latitude` and `longitude` numbers
2. **Function signature:** `fuzzLocationForAfterHours(latitude: number, longitude: number, fuzzRadiusKm?: number): FuzzedCoordinates`
3. **Default radius:** 0.5 km (500 meters)
4. **Random angle:** Use `Math.random() * 2 * Math.PI` for uniform direction
5. **Random distance:** Use `Math.sqrt(Math.random()) * fuzzRadiusKm` for uniform distribution within circle (sqrt is critical!)
6. **Coordinate conversion:**
   - 1 degree latitude = ~111.32 km
   - 1 degree longitude = ~111.32 * cos(latitude in radians) km
7. **Rounding:** Round to 3 decimal places: `Math.round(value * 1000) / 1000`
8. **Input validation:** Throw Error for latitude outside [-90, 90] or longitude outside [-180, 180]
9. **Edge clamping:** Clamp result to valid ranges after fuzzing (handles edge cases near poles/meridian)

Also re-export existing `redactCoordinates` from geo-redact.ts for backward compatibility.
  </action>
  <verify>
```bash
cd backend/profile-service && cat src/utils/location-fuzzer.ts | head -80
```
Verify function exists with proper TypeScript types and documentation.
  </verify>
  <done>
`location-fuzzer.ts` exists with:
- Exported `FuzzedCoordinates` interface
- Exported `fuzzLocationForAfterHours` function
- Default 500m fuzz radius
- sqrt-based random distance for uniform distribution
- Input validation for coordinate ranges
- Proper JSDoc documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for location fuzzer</name>
  <files>backend/profile-service/tests/utils/location-fuzzer.test.ts</files>
  <action>
Create test file for the location fuzzer utility.

Test cases:

1. **Basic fuzzing works** - Input coordinates return different output (with high probability)
2. **Output precision** - Result has at most 3 decimal places
3. **Fuzz radius respected** - Run 100 iterations, verify all results within expected max distance (~611m from original)
4. **Invalid latitude rejected** - Throws for latitude > 90 or < -90
5. **Invalid longitude rejected** - Throws for longitude > 180 or < -180
6. **Edge case: near poles** - Coordinates near +/- 90 latitude don't overflow
7. **Edge case: near meridian** - Coordinates near +/- 180 longitude don't overflow
8. **Custom fuzz radius** - Passing fuzzRadiusKm=1.0 results in larger spread
9. **Zero fuzz radius** - Passing fuzzRadiusKm=0 returns rounded but not jittered coordinates

Use Jest (already in project). Follow existing test patterns in the backend.

Helper function needed for tests:
```typescript
function haversineDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
  // Calculate distance in km between two points
}
```
  </action>
  <verify>
```bash
cd backend/profile-service && npm test -- --testPathPattern="location-fuzzer" --passWithNoTests
```
Tests should pass. If test command fails due to setup issues, verify test file syntax is correct.
  </verify>
  <done>
Test file exists with comprehensive coverage:
- Basic functionality tests
- Precision validation
- Boundary validation (max distance)
- Error cases for invalid input
- Edge cases for geographic extremes
  </done>
</task>

</tasks>

<verification>
1. `location-fuzzer.ts` exists with exported function and type
2. Function applies random jitter before rounding (not just rounding alone)
3. Tests cover happy path, edge cases, and error cases
4. Tests pass with `npm test`
</verification>

<success_criteria>
- [ ] `backend/profile-service/src/utils/location-fuzzer.ts` exists
- [ ] Exports `FuzzedCoordinates` interface
- [ ] Exports `fuzzLocationForAfterHours` function
- [ ] Uses sqrt-based random distance (uniform circle distribution)
- [ ] Rounds to 3 decimal places
- [ ] Validates input coordinates
- [ ] Test file exists and passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-02-SUMMARY.md`
</output>
