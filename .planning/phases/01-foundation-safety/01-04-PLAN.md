---
phase: 01-security-hardening
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - backend/auth-service/src/index.ts
  - backend/profile-service/src/index.ts
  - backend/chat-service/src/index.ts
  - backend/shared/src/middleware/request-signing.ts
  - .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "TLS configuration has security documentation comments in all services"
    - "Request signing secret validation logs warning if using dev secret in non-production"
    - "Security decisions are documented with rationale"
  artifacts:
    - path: "backend/auth-service/src/index.ts"
      provides: "Database SSL config with security comments"
      contains: "SECURITY NOTE"
    - path: ".planning/phases/01-foundation-safety/SECURITY-DECISIONS.md"
      provides: "Security decisions documentation"
  key_links:
    - from: "backend/*/src/index.ts"
      to: "PostgreSQL"
      via: "ssl config"
      pattern: "rejectUnauthorized"
---

<objective>
Document TLS limitations and verify secrets handling (SEC-01, SEC-06).

Purpose: Railway PostgreSQL uses self-signed certificates that prevent full TLS validation. This is a known limitation that must be documented. Additionally, the DEFAULT_DEV_SECRET in request-signing.ts is correctly guarded but should log a warning in development to remind developers to set proper secrets.

Output: Security decision documentation and improved security comments in code explaining the TLS limitation and secrets handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-safety/01-RESEARCH.md
@.planning/phases/01-foundation-safety/01-01-SUMMARY.md
@.planning/phases/01-foundation-safety/01-02-SUMMARY.md
@.planning/phases/01-foundation-safety/01-03-SUMMARY.md
@backend/auth-service/src/index.ts
@backend/shared/src/middleware/request-signing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add security documentation comments to database connections</name>
  <files>backend/auth-service/src/index.ts, backend/profile-service/src/index.ts, backend/chat-service/src/index.ts</files>
  <action>
    For each service (auth-service, profile-service, chat-service), find the PostgreSQL Pool configuration and add or enhance the security documentation comment.

    The auth-service already has a partial comment. Enhance all three to match this format:

    ```typescript
    // Initialize PostgreSQL connection pool
    //
    // SECURITY NOTE: TLS Configuration for Railway PostgreSQL
    // =========================================================
    // Railway uses self-signed certificates for PostgreSQL connections and does not
    // provide a CA bundle for validation. This means:
    //
    // 1. rejectUnauthorized: false is REQUIRED for Railway connections
    // 2. Connections ARE encrypted with TLS (data in transit is protected)
    // 3. Certificate validation cannot be performed (no MITM detection)
    //
    // Mitigations:
    // - DATABASE_URL uses sslmode=require (enforces TLS, even without cert validation)
    // - Railway internal networking used where possible (private network)
    // - Railway handles certificate rotation automatically
    //
    // When Railway provides a CA bundle, update to:
    //   ssl: { rejectUnauthorized: true, ca: fs.readFileSync('railway-ca.crt') }
    //
    // Reference: https://station.railway.com/questions/postgre-sql-ssl-connection-self-signed-33f0d3b6
    // Decision: SEC-01-DOCUMENTED in .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md
    const pool = new Pool({
      connectionString: process.env.DATABASE_URL,
      ssl: process.env.DATABASE_URL?.includes('railway')
        ? { rejectUnauthorized: false }
        : false,
      // ... rest of config
    });
    ```

    Ensure this comment block appears directly above the Pool initialization in ALL three services.
  </action>
  <verify>
    - All three services have "SECURITY NOTE: TLS Configuration" comment
    - Comment includes mitigations and reference link
    - `npm run build` succeeds in all services
  </verify>
  <done>TLS limitation documented in all service database configurations</done>
</task>

<task type="auto">
  <name>Task 2: Add development warning for request signing secret</name>
  <files>backend/shared/src/middleware/request-signing.ts</files>
  <action>
    The request-signing.ts file already has proper guards:
    - DEFAULT_DEV_SECRET is only used when REQUEST_SIGNING_SECRET is not set
    - Production throws an error if REQUEST_SIGNING_SECRET is missing

    Enhance the `getSigningSecret()` function to log a warning when using the dev secret:

    ```typescript
    export function getSigningSecret(): string {
      const secret = process.env.REQUEST_SIGNING_SECRET;
      if (!secret) {
        if (process.env.NODE_ENV === 'production') {
          throw new Error('REQUEST_SIGNING_SECRET must be set in production');
        }
        // Log warning to remind developers to set proper secret
        // This is safe for development but should never appear in production logs
        console.warn(
          '[SECURITY] Using DEFAULT_DEV_SECRET for request signing. ' +
          'Set REQUEST_SIGNING_SECRET environment variable for production security.'
        );
        return DEFAULT_DEV_SECRET;
      }
      return secret;
    }
    ```

    Also add a comment at the DEFAULT_DEV_SECRET constant:

    ```typescript
    // Default development secret - NEVER used in production (throws error)
    // This constant is intentionally visible to remind developers that:
    // 1. It exists ONLY for local development convenience
    // 2. Production MUST set REQUEST_SIGNING_SECRET (enforced with throw)
    // 3. The warning log helps catch misconfiguration during staging
    const DEFAULT_DEV_SECRET = 'vlvt-dev-signing-secret-DO-NOT-USE-IN-PRODUCTION';
    ```
  </action>
  <verify>
    - getSigningSecret logs warning when using dev secret
    - DEFAULT_DEV_SECRET has explanatory comment
    - `cd backend/shared && npm run build` succeeds
    - `npm test` passes
  </verify>
  <done>Request signing secret handling documented and warning added</done>
</task>

<task type="auto">
  <name>Task 3: Create security decisions documentation</name>
  <files>.planning/phases/01-foundation-safety/SECURITY-DECISIONS.md</files>
  <action>
    Create a security decisions document that captures the Phase 1 security decisions and their rationale:

    ```markdown
    # Security Decisions: Phase 1 - Security Hardening

    This document captures security decisions made during Phase 1 and their rationale.

    ## SEC-01: TLS Certificate Validation

    **Decision:** Accept `rejectUnauthorized: false` for Railway PostgreSQL connections.

    **Status:** DOCUMENTED (not a vulnerability, a platform limitation)

    **Context:**
    Railway PostgreSQL uses self-signed certificates for TLS connections. They do not provide a CA bundle for certificate validation. This is a known limitation documented in their help station.

    **Rationale:**
    1. Connections ARE encrypted with TLS - data in transit is protected
    2. The limitation is MITM detection, not encryption
    3. Railway internal networking provides additional isolation
    4. Enforcing `rejectUnauthorized: true` would break all database connections

    **Mitigations:**
    - DATABASE_URL includes `sslmode=require` to enforce TLS
    - Security comment added to all services documenting the limitation
    - When Railway provides CA bundle, update is straightforward

    **Reference:** https://station.railway.com/questions/postgre-sql-ssl-connection-self-signed-33f0d3b6

    ---

    ## SEC-06: Hardcoded Secrets Audit

    **Decision:** DEFAULT_DEV_SECRET in request-signing.ts is acceptable with current guards.

    **Status:** VERIFIED SAFE

    **Context:**
    The DEFAULT_DEV_SECRET exists for local development convenience. It is only used when:
    1. REQUEST_SIGNING_SECRET environment variable is NOT set, AND
    2. NODE_ENV is NOT 'production'

    If NODE_ENV is 'production' and the secret is missing, the application throws an error and refuses to start.

    **Rationale:**
    - Production throws error if secret missing (fail-closed)
    - Development convenience without security risk
    - Warning log added to remind developers to set proper secret

    **Implementation:**
    - Line 32: DEFAULT_DEV_SECRET definition with comment
    - Line 194-200: getSigningSecret() with production check and throw

    ---

    ## SEC-07: PII Logging

    **Decision:** Extended SENSITIVE_FIELDS to include location and message content.

    **Status:** IMPLEMENTED

    **Fields Added:**
    - Location: latitude, longitude, lat, lng, location, coordinates, coords, geoLocation
    - Messages: text, content, body, messageText, messageContent, chatMessage

    **Rationale:**
    - Dating app users' exact locations are highly sensitive
    - Private messages must never appear in logs
    - Existing email redaction pattern extended to cover these fields

    ---

    ## SEC-09: Socket.IO Adapter Migration

    **Decision:** Migrate from socket.io-redis (deprecated) to @socket.io/redis-adapter.

    **Status:** IMPLEMENTED

    **Rationale:**
    - socket.io-redis is deprecated and no longer maintained
    - @socket.io/redis-adapter is the official replacement
    - Protocol-compatible migration (no breaking changes)
    - Graceful degradation when Redis unavailable

    ---

    *Document created: Phase 1 Security Hardening*
    *Last updated: [execution date]*
    ```
  </action>
  <verify>
    - SECURITY-DECISIONS.md exists in phase directory
    - Document covers SEC-01, SEC-06, SEC-07, SEC-09
    - Each decision has status, rationale, and mitigations where applicable
  </verify>
  <done>Security decisions documented with rationale and references</done>
</task>

</tasks>

<verification>
1. Check TLS comments exist:
```bash
grep -l "SECURITY NOTE: TLS Configuration" backend/*/src/index.ts
```

2. Check request-signing warning:
```bash
grep "SECURITY.*DEFAULT_DEV_SECRET" backend/shared/src/middleware/request-signing.ts
```

3. Check documentation:
```bash
cat .planning/phases/01-foundation-safety/SECURITY-DECISIONS.md
```

4. Build all services:
```bash
cd backend/auth-service && npm run build
cd backend/profile-service && npm run build
cd backend/chat-service && npm run build
```
</verification>

<success_criteria>
1. All three services have comprehensive TLS security comments
2. Request signing logs warning when using dev secret in non-production
3. SECURITY-DECISIONS.md documents SEC-01, SEC-06, SEC-07, SEC-09
4. All services build without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety/01-04-SUMMARY.md`
</output>
