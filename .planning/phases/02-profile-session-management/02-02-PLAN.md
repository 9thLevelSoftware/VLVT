---
phase: 02-profile-session-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/profile-service/src/routes/after-hours.ts
  - backend/profile-service/src/middleware/after-hours-validation.ts
  - backend/migrations/022_add_after_hours_preferences_columns.sql
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can create After Hours preferences with seeking gender"
    - "User can view their After Hours preferences"
    - "User can update After Hours preferences"
    - "Smart defaults applied from main profile on first creation"
    - "Preferences validate seeking gender, distance, age range, orientation"
  artifacts:
    - path: "backend/profile-service/src/middleware/after-hours-validation.ts"
      provides: "Preferences validation chains"
      exports: ["validatePreferences", "validatePreferencesUpdate"]
    - path: "backend/profile-service/src/routes/after-hours.ts"
      provides: "Preferences endpoints added to router"
      contains: "'/preferences'"
    - path: "backend/migrations/022_add_after_hours_preferences_columns.sql"
      provides: "Schema migration for preferences columns"
      contains: "ALTER TABLE after_hours_preferences"
  key_links:
    - from: "backend/profile-service/src/routes/after-hours.ts"
      to: "after_hours_preferences table"
      via: "INSERT/UPDATE queries"
      pattern: "after_hours_preferences"
---

<objective>
Create After Hours preferences CRUD endpoints

Purpose: Users need to configure their After Hours matching preferences (seeking gender, distance, age range, sexual orientation) separately from main app preferences. This plan establishes the preferences management APIs.

Output:
- `/api/after-hours/preferences` POST/GET/PATCH endpoints
- Validation middleware for preferences data
- Smart defaults logic that inherits from main profile on first creation
- Database migration for new preference columns
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profile-session-management/02-CONTEXT.md
@.planning/phases/02-profile-session-management/02-RESEARCH.md
@.planning/phases/02-profile-session-management/02-01-SUMMARY.md

@backend/profile-service/src/routes/after-hours.ts
@backend/profile-service/src/middleware/after-hours-validation.ts
@backend/profile-service/src/middleware/validation.ts
@backend/migrations/021_add_after_hours_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration and add preferences validation chains</name>
  <files>
backend/migrations/022_add_after_hours_preferences_columns.sql
backend/profile-service/src/middleware/after-hours-validation.ts
  </files>
  <action>
**Step 1: Create the database migration file:**

Create `backend/migrations/022_add_after_hours_preferences_columns.sql`:
```sql
-- Migration 022: Add age range and orientation to After Hours preferences
-- Date: 2026-01-22

ALTER TABLE after_hours_preferences
  ADD COLUMN IF NOT EXISTS min_age INTEGER DEFAULT 18,
  ADD COLUMN IF NOT EXISTS max_age INTEGER DEFAULT 99,
  ADD COLUMN IF NOT EXISTS sexual_orientation VARCHAR(50);

COMMENT ON COLUMN after_hours_preferences.min_age IS 'Minimum age preference for matching (default 18)';
COMMENT ON COLUMN after_hours_preferences.max_age IS 'Maximum age preference for matching (default 99)';
COMMENT ON COLUMN after_hours_preferences.sexual_orientation IS 'Sexual orientation filter for matching';
```

**Step 2: Run the migration:**

Execute the migration against the database:
```bash
cd backend/migrations && npm run migrate
```

If `npm run migrate` does not exist, run the SQL directly:
```bash
# With DATABASE_URL set in environment
psql "$DATABASE_URL" -f backend/migrations/022_add_after_hours_preferences_columns.sql
```

Verify migration applied by checking table structure:
```bash
psql "$DATABASE_URL" -c "\d after_hours_preferences"
# Should show min_age, max_age, sexual_orientation columns
```

**Step 3: Add preferences validation chains to after-hours-validation.ts:**

Add to the existing after-hours-validation.ts file:

1. `validatePreferences` - for preferences creation (all fields optional since we apply smart defaults):
   - `seekingGender`: optional, isIn(['Any', 'Male', 'Female', 'Non-binary'])
   - `maxDistanceKm`: optional, isInt({ min: 1, max: 200 })
   - `minAge`: optional, isInt({ min: 18, max: 99 })
   - `maxAge`: optional, isInt({ min: 18, max: 99 })
   - `sexualOrientation`: optional, isIn(['Straight', 'Gay', 'Bisexual', 'Pansexual', 'Queer', 'Other'])
   - Apply custom validation: if both minAge and maxAge provided, minAge must be <= maxAge

2. `validatePreferencesUpdate` - same validation as create (partial update support)

Follow the exact pattern from RESEARCH.md and existing validation.ts.

Export the new validators.
  </action>
  <verify>
Migration file exists: `ls backend/migrations/022_add_after_hours_preferences_columns.sql`
Migration applied: `psql "$DATABASE_URL" -c "SELECT column_name FROM information_schema.columns WHERE table_name='after_hours_preferences' AND column_name IN ('min_age', 'max_age', 'sexual_orientation');"` returns 3 rows
TypeScript compiles: `cd backend/profile-service && npx tsc --noEmit`
File exports validatePreferences and validatePreferencesUpdate
  </verify>
  <done>
Migration 022 created and applied, adding min_age, max_age, sexual_orientation columns. Preferences validation chains added with seeking gender, distance, age range, and orientation validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add preferences endpoints to After Hours router</name>
  <files>backend/profile-service/src/routes/after-hours.ts</files>
  <action>
Add preferences endpoints to the existing After Hours router (created by Plan 02-01):

1. Import the new validation middleware:
   ```typescript
   import { validatePreferences, validatePreferencesUpdate } from '../middleware/after-hours-validation';
   ```

2. Implement POST /preferences - Create preferences (with smart defaults):
   ```typescript
   router.post('/preferences', validatePreferences, async (req, res) => {
     const userId = req.user!.userId;
     const { seekingGender, maxDistanceKm, minAge, maxAge, sexualOrientation } = req.body;

     // Check if preferences already exist
     const existing = await pool.query(
       'SELECT user_id FROM after_hours_preferences WHERE user_id = $1',
       [userId]
     );

     if (existing.rows.length > 0) {
       return res.status(409).json({
         success: false,
         error: 'After Hours preferences already exist. Use PATCH to update.'
       });
     }

     // Apply smart defaults from main profile if values not provided
     let finalSeekingGender = seekingGender;
     let finalMaxDistance = maxDistanceKm;
     let finalMinAge = minAge;
     let finalMaxAge = maxAge;
     let finalOrientation = sexualOrientation;

     // Only apply smart defaults on creation (not updates)
     if (!seekingGender || !maxDistanceKm || !minAge || !maxAge) {
       const mainProfileResult = await pool.query(
         `SELECT gender, sexual_preference FROM profiles WHERE user_id = $1`,
         [userId]
       );

       const mainProfile = mainProfileResult.rows[0];
       if (mainProfile) {
         // Infer seeking gender from sexual preference if not provided
         if (!finalSeekingGender && mainProfile.sexual_preference) {
           // Map sexual preference to seeking gender (rough heuristic)
           finalSeekingGender = 'Any'; // Safe default
         }
         finalSeekingGender = finalSeekingGender || 'Any';
       }
     }

     // Apply safe defaults for any remaining nulls
     finalSeekingGender = finalSeekingGender || 'Any';
     finalMaxDistance = finalMaxDistance || 10;
     finalMinAge = finalMinAge || 18;
     finalMaxAge = finalMaxAge || 99;

     // Insert with defaults applied
     const result = await pool.query(
       `INSERT INTO after_hours_preferences
        (user_id, seeking_gender, max_distance_km, min_age, max_age, sexual_orientation)
        VALUES ($1, $2, $3, $4, $5, $6)
        RETURNING *`,
       [userId, finalSeekingGender, finalMaxDistance, finalMinAge, finalMaxAge, finalOrientation]
     );

     res.status(201).json({
       success: true,
       preferences: {
         seekingGender: result.rows[0].seeking_gender,
         maxDistanceKm: result.rows[0].max_distance_km,
         minAge: result.rows[0].min_age,
         maxAge: result.rows[0].max_age,
         sexualOrientation: result.rows[0].sexual_orientation
       }
     });
   });
   ```

3. Implement GET /preferences - Get preferences:
   ```typescript
   router.get('/preferences', async (req, res) => {
     const userId = req.user!.userId;

     const result = await pool.query(
       'SELECT * FROM after_hours_preferences WHERE user_id = $1',
       [userId]
     );

     if (result.rows.length === 0) {
       return res.status(404).json({
         success: false,
         error: 'After Hours preferences not found'
       });
     }

     const prefs = result.rows[0];
     res.json({
       success: true,
       preferences: {
         seekingGender: prefs.seeking_gender,
         maxDistanceKm: prefs.max_distance_km,
         minAge: prefs.min_age,
         maxAge: prefs.max_age,
         sexualOrientation: prefs.sexual_orientation
       }
     });
   });
   ```

4. Implement PATCH /preferences - Update preferences:
   ```typescript
   router.patch('/preferences', validatePreferencesUpdate, async (req, res) => {
     const userId = req.user!.userId;
     const { seekingGender, maxDistanceKm, minAge, maxAge, sexualOrientation } = req.body;

     const result = await pool.query(
       `UPDATE after_hours_preferences SET
          seeking_gender = COALESCE($2, seeking_gender),
          max_distance_km = COALESCE($3, max_distance_km),
          min_age = COALESCE($4, min_age),
          max_age = COALESCE($5, max_age),
          sexual_orientation = COALESCE($6, sexual_orientation),
          updated_at = NOW()
        WHERE user_id = $1
        RETURNING *`,
       [userId, seekingGender, maxDistanceKm, minAge, maxAge, sexualOrientation]
     );

     if (result.rows.length === 0) {
       return res.status(404).json({
         success: false,
         error: 'After Hours preferences not found'
       });
     }

     const prefs = result.rows[0];
     res.json({
       success: true,
       preferences: {
         seekingGender: prefs.seeking_gender,
         maxDistanceKm: prefs.max_distance_km,
         minAge: prefs.min_age,
         maxAge: prefs.max_age,
         sexualOrientation: prefs.sexual_orientation
       }
     });
   });
   ```
  </action>
  <verify>
TypeScript compiles: `cd backend/profile-service && npx tsc --noEmit`
Server starts without errors
  </verify>
  <done>
Preferences POST/GET/PATCH endpoints implemented with smart defaults, added to existing After Hours router
  </done>
</task>

</tasks>

<verification>
Run TypeScript compilation:
```bash
cd backend/profile-service && npx tsc --noEmit
```

Verify migration applied:
```bash
psql "$DATABASE_URL" -c "\d after_hours_preferences"
```

Run existing tests:
```bash
cd backend/profile-service && npm test
```

Manual verification (requires running server + test user JWT):
```bash
curl -X POST http://localhost:3002/api/after-hours/preferences \
  -H "Authorization: Bearer <jwt>" \
  -H "Content-Type: application/json" \
  -d '{"seekingGender":"Any","maxDistanceKm":10}'
```
</verification>

<success_criteria>
1. Migration 022 exists and runs successfully
2. TypeScript compiles without errors
3. POST /api/after-hours/preferences creates preferences with smart defaults
4. GET /api/after-hours/preferences returns preferences
5. PATCH /api/after-hours/preferences updates preferences
6. Validation rejects invalid seeking gender, out-of-range distances/ages
</success_criteria>

<output>
After completion, create `.planning/phases/02-profile-session-management/02-02-SUMMARY.md`
</output>
