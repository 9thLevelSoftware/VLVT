---
phase: 02-profile-session-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/profile-service/src/routes/after-hours.ts
  - backend/profile-service/src/middleware/after-hours-validation.ts
  - backend/profile-service/src/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can create After Hours profile with description"
    - "User can upload single photo to After Hours profile"
    - "User can view their After Hours profile"
    - "User can update After Hours profile description"
    - "After Hours endpoints require premium, verified, consent"
  artifacts:
    - path: "backend/profile-service/src/routes/after-hours.ts"
      provides: "After Hours router with profile endpoints"
      exports: ["afterHoursRouter"]
    - path: "backend/profile-service/src/middleware/after-hours-validation.ts"
      provides: "Validation chains for After Hours profile"
      exports: ["validateAfterHoursProfile", "validateAfterHoursProfileUpdate"]
  key_links:
    - from: "backend/profile-service/src/index.ts"
      to: "backend/profile-service/src/routes/after-hours.ts"
      via: "app.use('/api/after-hours', afterHoursRouter)"
      pattern: "app\\.use.*after-hours.*afterHoursRouter"
    - from: "backend/profile-service/src/routes/after-hours.ts"
      to: "@vlvt/shared"
      via: "createAfterHoursAuthMiddleware import"
      pattern: "createAfterHoursAuthMiddleware"
---

<objective>
Create After Hours profile CRUD endpoints with photo upload capability

Purpose: Users need a dedicated After Hours profile (separate from main profile) before they can activate sessions. This plan establishes the profile management APIs.

Output:
- `/api/after-hours/profile` POST/GET/PATCH endpoints
- `/api/after-hours/profile/photo` POST endpoint
- Validation middleware for profile data
- Integration with existing photo upload pipeline
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profile-session-management/02-CONTEXT.md
@.planning/phases/02-profile-session-management/02-RESEARCH.md
@.planning/phases/01-foundation-safety/01-03-SUMMARY.md

@backend/profile-service/src/index.ts
@backend/profile-service/src/middleware/validation.ts
@backend/profile-service/src/utils/image-handler.ts
@backend/profile-service/src/utils/r2-client.ts
@backend/shared/src/middleware/after-hours-auth.ts
@backend/migrations/021_add_after_hours_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create After Hours validation middleware</name>
  <files>backend/profile-service/src/middleware/after-hours-validation.ts</files>
  <action>
Create express-validator validation chains following the pattern in `middleware/validation.ts`:

1. `validateAfterHoursProfile` - for profile creation:
   - `description`: optional, trim, max 500 characters

2. `validateAfterHoursProfileUpdate` - for profile updates:
   - `description`: optional, trim, max 500 characters

3. Export `handleValidationErrors` (reuse from validation.ts pattern)

Note: Photo validation is handled separately by multer and image-handler (existing pattern).
  </action>
  <verify>
File exists at `backend/profile-service/src/middleware/after-hours-validation.ts`
TypeScript compiles without errors: `cd backend/profile-service && npx tsc --noEmit`
  </verify>
  <done>
Validation middleware exports validateAfterHoursProfile, validateAfterHoursProfileUpdate, handleValidationErrors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create After Hours profile router with CRUD and photo upload</name>
  <files>backend/profile-service/src/routes/after-hours.ts</files>
  <action>
Create a new router file following existing patterns from `index.ts`:

1. Import required modules:
   - Express Router
   - authMiddleware from '../middleware/auth'
   - createAfterHoursAuthMiddleware from '@vlvt/shared'
   - Pool from 'pg' (use existing pool from index.ts via dependency injection or import)
   - Validation middleware from '../middleware/after-hours-validation'
   - Image handler utilities (validateImage, validateImageMagicBytes, processImage)
   - R2 client (resolvePhotoUrls)
   - multer (reuse upload configuration)
   - logger

2. Create factory function `createAfterHoursRouter(pool: Pool, upload: multer.Multer)`:

3. Apply middleware chain to all routes:
   - authMiddleware (JWT)
   - createAfterHoursAuthMiddleware({ pool, logger }) (premium + verified + consent)

4. Implement endpoints:

   POST /profile - Create After Hours profile
   - Validate request body with validateAfterHoursProfile
   - Insert into after_hours_profiles (user_id, photo_url, description)
   - **photo_url pattern:** The database schema (migration 021) defines `photo_url TEXT NOT NULL`.
     On profile creation, set photo_url to empty string '' (satisfies NOT NULL constraint).
     Users upload their photo separately via POST /profile/photo, which updates photo_url with the R2 key.
     This two-step pattern allows profile creation without immediate photo upload.
   - Return created profile with 201

   GET /profile - Get own After Hours profile
   - Query after_hours_profiles by user_id from JWT
   - JOIN with profiles to get name, age (inherited from main)
   - Resolve photo_url to presigned URL if present (skip if empty string)
   - Return 404 if no profile exists
   - Return profile with inherited name/age

   PATCH /profile - Update After Hours profile
   - Validate request body with validateAfterHoursProfileUpdate
   - Update description, updated_at
   - Return updated profile

   POST /profile/photo - Upload/replace After Hours photo
   - Use multer upload.single('photo')
   - Validate with validateImage and validateImageMagicBytes (existing pattern)
   - Process with processImage
   - Use R2 key prefix: `after-hours-photos/${userId}/${photoId}.jpg`
   - Update after_hours_profiles.photo_url with R2 key (replaces empty string or previous photo)
   - Return presigned URL

5. Error handling:
   - 409 for duplicate profile creation (catch error code 23505)
   - 404 for profile not found
   - 400 for validation errors
   - 500 for database errors

Export the factory function.
  </action>
  <verify>
File exists at `backend/profile-service/src/routes/after-hours.ts`
TypeScript compiles: `cd backend/profile-service && npx tsc --noEmit`
Exports createAfterHoursRouter function
  </verify>
  <done>
Router file created with POST/GET/PATCH /profile and POST /profile/photo endpoints, all protected by After Hours auth middleware. photo_url initialized to empty string on creation, updated via POST /profile/photo.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mount After Hours router in main app</name>
  <files>backend/profile-service/src/index.ts</files>
  <action>
Integrate the After Hours router into the main Express app:

1. Import the router factory:
   ```typescript
   import { createAfterHoursRouter } from './routes/after-hours';
   ```

2. After pool initialization and upload configuration, create and mount the router:
   ```typescript
   // After Hours routes
   const afterHoursRouter = createAfterHoursRouter(pool, upload);
   app.use('/api/after-hours', afterHoursRouter);
   ```

3. Mount BEFORE the Sentry error handler and generic error handler (follow existing route mounting pattern)

4. Add logger info on startup:
   ```typescript
   logger.info('After Hours routes mounted at /api/after-hours');
   ```
  </action>
  <verify>
`cd backend/profile-service && npx tsc --noEmit` passes
`npm run build` succeeds in backend/profile-service
Server starts without errors: `npm run dev` (can Ctrl+C after startup log)
  </verify>
  <done>
After Hours router mounted at /api/after-hours, TypeScript compiles, server starts
  </done>
</task>

</tasks>

<verification>
Run TypeScript compilation:
```bash
cd backend/profile-service && npx tsc --noEmit
```

Run existing tests to ensure no regressions:
```bash
cd backend/profile-service && npm test
```

Start server and verify route registration:
```bash
cd backend/profile-service && npm run dev
# Look for: "After Hours routes mounted" in logs
```

Manual API test (requires running server, test user JWT, and database):
```bash
# These will fail with 403 (premium/verified required) but confirm routes exist
curl -X POST http://localhost:3002/api/after-hours/profile -H "Authorization: Bearer <jwt>" -H "Content-Type: application/json" -d '{"description":"test"}'
```
</verification>

<success_criteria>
1. TypeScript compiles without errors
2. Existing tests pass (no regressions)
3. Server starts and logs route mounting
4. POST/GET/PATCH /api/after-hours/profile routes respond (even if 403 without proper auth)
5. POST /api/after-hours/profile/photo route responds
</success_criteria>

<output>
After completion, create `.planning/phases/02-profile-session-management/02-01-SUMMARY.md`
</output>
