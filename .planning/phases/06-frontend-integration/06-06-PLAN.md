---
phase: 06-frontend-integration
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/services/after_hours_service.dart
  - frontend/lib/providers/provider_tree.dart
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "AfterHoursService makes real HTTP calls to backend APIs"
    - "AfterHoursProfileService is accessible via Provider throughout the app"
    - "Background location continues during After Hours sessions"
  artifacts:
    - path: "frontend/lib/services/after_hours_service.dart"
      provides: "Real API integration for session lifecycle"
      contains: "authenticatedPost|authenticatedGet|authenticatedDelete"
    - path: "frontend/lib/providers/provider_tree.dart"
      provides: "AfterHoursProfileService provider registration"
      contains: "AfterHoursProfileService"
  key_links:
    - from: "frontend/lib/services/after_hours_service.dart"
      to: "/api/v1/after-hours/session"
      via: "HTTP POST/DELETE requests"
      pattern: "profileUrl.*session"
    - from: "frontend/lib/providers/provider_tree.dart"
      to: "frontend/lib/services/after_hours_profile_service.dart"
      via: "ChangeNotifierProxyProvider import and registration"
      pattern: "AfterHoursProfileService"
---

<objective>
Close 3 verification gaps in Phase 06 Frontend Integration by implementing real API calls, registering the missing provider, and initializing background location support.

Purpose: Make After Hours Mode fully functional with real backend communication and proper provider accessibility.

Output: Working frontend that communicates with backend APIs, accessible services via Provider, and background location for Android.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-VERIFICATION.md

# Backend API Reference (from profile-service/routes/after-hours.ts):
# - POST /session/start - Start session (body: duration, latitude, longitude)
# - POST /session/end - End session early
# - GET /session - Get current session status
# - POST /match/decline - Decline match (body: matchId)
# Note: match accept is socket-based (joinAfterHoursChat), not HTTP

# Existing services to reference:
@frontend/lib/services/after_hours_service.dart
@frontend/lib/services/after_hours_profile_service.dart
@frontend/lib/services/base_api_service.dart
@frontend/lib/providers/provider_tree.dart
@frontend/lib/config/app_config.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement real API calls in AfterHoursService</name>
  <files>frontend/lib/services/after_hours_service.dart</files>
  <action>
Replace TODO stubs with real HTTP calls using the same patterns as AfterHoursProfileService.

1. Add required imports at top of file:
   - `import 'dart:convert';`
   - `import 'package:http/http.dart' as http;`
   - `import '../config/app_config.dart';`

2. Add HTTP helper method (similar to AfterHoursProfileService pattern):
   ```dart
   /// Build a versioned profile service URL for After Hours endpoints
   String _url(String path) => AppConfig.profileUrl(path);

   /// Get authorization headers
   Map<String, String> get _authHeaders => {
     'Content-Type': 'application/json',
     if (_authService.token != null) 'Authorization': 'Bearer ${_authService.token}',
   };
   ```

3. Implement startSession() - replace TODO block (around line 253):
   ```dart
   // Make API call to start session
   final response = await http.post(
     Uri.parse(_url('/after-hours/session/start')),
     headers: _authHeaders,
     body: json.encode({
       'duration': durationMinutes,
       'latitude': lat,
       'longitude': lng,
     }),
   );

   if (response.statusCode == 201) {
     final data = json.decode(response.body);
     if (data['success'] == true && data['session'] != null) {
       _sessionId = data['session']['id'] as String;
       _expiresAt = DateTime.parse(data['session']['expiresAt'] as String);
       _setState(AfterHoursState.searching);
       return true;
     }
   }

   debugPrint('AfterHoursService: Failed to start session: ${response.statusCode}');
   debugPrint('Response: ${response.body}');
   _setState(AfterHoursState.inactive);
   return false;
   ```

4. Implement endSession() - replace TODO block (around line 286):
   ```dart
   // Make API call to end session
   final response = await http.post(
     Uri.parse(_url('/after-hours/session/end')),
     headers: _authHeaders,
   );

   if (response.statusCode == 200) {
     resetToInactive();
     return true;
   }

   debugPrint('AfterHoursService: Failed to end session: ${response.statusCode}');
   return false;
   ```

5. Implement acceptMatch() - around line 307:
   Note: Accept is socket-based, NOT HTTP. The current code already calls `_socketService.joinAfterHoursChat()`.
   Just remove the TODO comment and keep the socket-based approach. No HTTP call needed here.

6. Implement declineMatch() - replace TODO block (around line 336):
   ```dart
   // Make API call to decline match
   final response = await http.post(
     Uri.parse(_url('/after-hours/match/decline')),
     headers: _authHeaders,
     body: json.encode({'matchId': _currentMatch!.id}),
   );

   if (response.statusCode != 200) {
     debugPrint('AfterHoursService: Failed to decline match: ${response.statusCode}');
     // Continue with local state change even if API fails
   }
   ```
   Keep the existing state cleanup code after the API call.

7. Implement refreshSessionStatus() - replace TODO block (around line 359):
   ```dart
   // Make API call to get current session status
   final response = await http.get(
     Uri.parse(_url('/after-hours/session')),
     headers: _authHeaders,
   );

   if (response.statusCode == 200) {
     final data = json.decode(response.body);
     if (data['success'] == true) {
       if (data['active'] == true && data['session'] != null) {
         _sessionId = data['session']['id'] as String;
         _expiresAt = DateTime.parse(data['session']['expiresAt'] as String);
         // Check if session is expiring (less than 2 minutes left)
         if (remainingSeconds <= 120 && remainingSeconds > 0) {
           _setState(AfterHoursState.expiring);
         } else if (remainingSeconds > 0) {
           _setState(AfterHoursState.searching);
         } else {
           resetToInactive();
         }
       } else {
         // No active session
         resetToInactive();
       }
     }
   }
   ```
   Remove the local expiry check that currently exists after the TODO.

Preserve all existing socket event subscriptions and state machine logic - only replace the TODO stubs with real API calls.
  </action>
  <verify>
Run `cd frontend && flutter analyze` - no errors related to after_hours_service.dart.
Grep for "TODO" in after_hours_service.dart - should return 0 matches for API-related TODOs.
  </verify>
  <done>
AfterHoursService makes real HTTP calls for startSession, endSession, declineMatch, and refreshSessionStatus.
acceptMatch remains socket-based (correct behavior).
  </done>
</task>

<task type="auto">
  <name>Task 2: Register AfterHoursProfileService in provider tree</name>
  <files>frontend/lib/providers/provider_tree.dart</files>
  <action>
Add AfterHoursProfileService to the provider tree so it's accessible throughout the app.

1. Add import at top of file (after existing service imports):
   ```dart
   import '../services/after_hours_profile_service.dart';
   ```

2. Add ChangeNotifierProxyProvider for AfterHoursProfileService to the afterHours() method.
   Insert BEFORE the existing AfterHoursService provider (since profile service may be needed first):

   ```dart
   static List<SingleChildWidget> afterHours() => [
     ChangeNotifierProxyProvider<AuthService, AfterHoursProfileService>(
       create: (context) => AfterHoursProfileService(context.read<AuthService>()),
       update: (context, auth, previous) =>
           previous ?? AfterHoursProfileService(auth),
     ),
     ChangeNotifierProxyProvider2<AuthService, SocketService,
         AfterHoursService>(
       // ... existing code
     ),
     // ... rest of existing providers
   ];
   ```

The AfterHoursProfileService only depends on AuthService (not SocketService), so use ChangeNotifierProxyProvider (not ProxyProvider2).
  </action>
  <verify>
Run `cd frontend && flutter analyze` - no errors.
Grep provider_tree.dart for "AfterHoursProfileService" - should find import and provider registration.
  </verify>
  <done>
AfterHoursProfileService is registered in provider tree and accessible via `context.read<AfterHoursProfileService>()` throughout the app.
  </done>
</task>

<task type="auto">
  <name>Task 3: Initialize flutter_foreground_task for background location</name>
  <files>frontend/lib/services/after_hours_service.dart</files>
  <action>
Initialize and manage FlutterForegroundTask for background location support during After Hours sessions.

1. Add import at top of file:
   ```dart
   import 'package:flutter_foreground_task/flutter_foreground_task.dart';
   ```

2. Add initialization method to AfterHoursService class:
   ```dart
   /// Initialize foreground task for background location support
   static Future<void> initForegroundTask() async {
     FlutterForegroundTask.init(
       androidNotificationOptions: AndroidNotificationOptions(
         channelId: 'after_hours_session',
         channelName: 'After Hours Session',
         channelDescription: 'Keeps your After Hours session active',
         channelImportance: NotificationChannelImportance.LOW,
         priority: NotificationPriority.LOW,
         isSticky: true,
         visibility: NotificationVisibility.VISIBILITY_PUBLIC,
         iconData: const NotificationIconData(
           resType: ResourceType.mipmap,
           resPrefix: ResourcePrefix.ic,
           name: 'launcher',
         ),
       ),
       iosNotificationOptions: const IOSNotificationOptions(
         showNotification: false,
         playSound: false,
       ),
       foregroundTaskOptions: ForegroundTaskOptions(
         eventAction: ForegroundTaskEventAction.repeat(5000),
         autoRunOnBoot: false,
         autoRunOnMyPackageReplaced: false,
         allowWakeLock: true,
         allowWifiLock: false,
       ),
     );
   }
   ```

3. Add start/stop methods for the foreground service:
   ```dart
   /// Start foreground service when session begins
   Future<void> _startForegroundService() async {
     final isRunning = await FlutterForegroundTask.isRunningService;
     if (isRunning) return;

     await FlutterForegroundTask.startService(
       notificationTitle: 'After Hours Active',
       notificationText: 'Your session is running',
       callback: null, // No background callback needed, just keeping app alive
     );
     debugPrint('AfterHoursService: Foreground service started');
   }

   /// Stop foreground service when session ends
   Future<void> _stopForegroundService() async {
     final isRunning = await FlutterForegroundTask.isRunningService;
     if (!isRunning) return;

     await FlutterForegroundTask.stopService();
     debugPrint('AfterHoursService: Foreground service stopped');
   }
   ```

4. Call _startForegroundService() in startSession() after successful API call:
   After setting state to searching, add:
   ```dart
   // Start foreground service for background location
   await _startForegroundService();
   ```

5. Call _stopForegroundService() in resetToInactive():
   At the beginning of resetToInactive(), add:
   ```dart
   // Stop foreground service
   _stopForegroundService();
   ```

Note: The foreground service keeps the app alive on Android 14+ when in background. The notification shows "After Hours Active" so users know the session is running.
  </action>
  <verify>
Run `cd frontend && flutter analyze` - no errors.
Grep after_hours_service.dart for "FlutterForegroundTask" - should find import and usage.
  </verify>
  <done>
FlutterForegroundTask is initialized, starts when session begins, and stops when session ends.
Background location continues working during After Hours sessions on Android 14+.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run static analysis:
   ```bash
   cd frontend && flutter analyze
   ```
   Expected: No errors

2. Verify API integration:
   ```bash
   grep -n "TODO.*API" frontend/lib/services/after_hours_service.dart
   ```
   Expected: No matches (all TODOs replaced with real code)

3. Verify provider registration:
   ```bash
   grep -n "AfterHoursProfileService" frontend/lib/providers/provider_tree.dart
   ```
   Expected: Import and ChangeNotifierProxyProvider registration found

4. Verify foreground task integration:
   ```bash
   grep -n "FlutterForegroundTask" frontend/lib/services/after_hours_service.dart
   ```
   Expected: Import and initialization/start/stop calls found

5. Build test (optional):
   ```bash
   cd frontend && flutter build apk --debug
   ```
   Expected: Build succeeds
</verification>

<success_criteria>
- All 3 gaps from VERIFICATION.md are closed
- AfterHoursService makes HTTP calls to profile-service endpoints
- AfterHoursProfileService is accessible via Provider
- FlutterForegroundTask keeps sessions alive in background
- Static analysis passes with no errors
- No regressions to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-06-SUMMARY.md`
</output>
