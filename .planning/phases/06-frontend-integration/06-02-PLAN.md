---
phase: 06-frontend-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/services/after_hours_profile_service.dart
  - frontend/lib/screens/after_hours_profile_screen.dart
  - frontend/lib/screens/after_hours_preferences_screen.dart
  - frontend/lib/providers/provider_tree.dart
autonomous: true

must_haves:
  truths:
    - "User can create and edit After Hours profile (photo, bio)"
    - "User can set After Hours preferences (gender seeking, age range, distance)"
    - "Profile data persists via backend API"
    - "Preferences data persists via backend API"
  artifacts:
    - path: "frontend/lib/services/after_hours_profile_service.dart"
      provides: "API client for After Hours profile and preferences"
      exports: ["AfterHoursProfileService", "AfterHoursProfile", "AfterHoursPreferences"]
      min_lines: 150
    - path: "frontend/lib/screens/after_hours_profile_screen.dart"
      provides: "Profile creation and edit UI"
      contains: "AfterHoursProfileScreen"
      min_lines: 150
    - path: "frontend/lib/screens/after_hours_preferences_screen.dart"
      provides: "Preferences settings UI"
      contains: "AfterHoursPreferencesScreen"
      min_lines: 100
  key_links:
    - from: "frontend/lib/screens/after_hours_profile_screen.dart"
      to: "after_hours_profile_service.dart"
      via: "API calls for profile CRUD"
      pattern: "context\\.read<AfterHoursProfileService>"
    - from: "frontend/lib/screens/after_hours_preferences_screen.dart"
      to: "after_hours_profile_service.dart"
      via: "API calls for preferences CRUD"
      pattern: "context\\.read<AfterHoursProfileService>"
---

<objective>
Create After Hours profile and preferences screens with API service for data persistence.

Purpose: Users need to set up their After Hours identity (separate from main profile) and matching preferences before activating a session.

Output: Working profile creation/edit screen, preferences screen, and API service for backend communication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-CONTEXT.md
@.planning/phases/06-frontend-integration/06-RESEARCH.md

Reference existing patterns:
@frontend/lib/services/profile_api_service.dart (API service pattern)
@frontend/lib/screens/profile_edit_screen.dart (profile editing pattern)
@frontend/lib/screens/discovery_filters_screen.dart (preferences/filters pattern)
@frontend/lib/widgets/photo_manager_widget.dart (photo upload pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AfterHoursProfileService API client</name>
  <files>frontend/lib/services/after_hours_profile_service.dart</files>
  <action>
Create AfterHoursProfileService following existing ProfileApiService patterns:

1. Models (at top of file):
   ```dart
   /// After Hours profile data
   class AfterHoursProfile {
     final String? id;
     final String? photoUrl;
     final String? bio;
     final String? name;  // inherited from main profile
     final int? age;      // inherited from main profile

     AfterHoursProfile({
       this.id,
       this.photoUrl,
       this.bio,
       this.name,
       this.age,
     });

     factory AfterHoursProfile.fromJson(Map<String, dynamic> json) {
       return AfterHoursProfile(
         id: json['id'] as String?,
         photoUrl: json['photo_url'] as String?,
         bio: json['bio'] as String?,
         name: json['name'] as String?,
         age: json['age'] as int?,
       );
     }

     bool get isComplete => photoUrl != null && photoUrl!.isNotEmpty && bio != null && bio!.isNotEmpty;
   }

   /// After Hours matching preferences
   class AfterHoursPreferences {
     final String? id;
     final String? genderSeeking;  // 'male', 'female', 'any'
     final int? minAge;
     final int? maxAge;
     final double? maxDistanceKm;

     AfterHoursPreferences({
       this.id,
       this.genderSeeking,
       this.minAge,
       this.maxAge,
       this.maxDistanceKm,
     });

     factory AfterHoursPreferences.fromJson(Map<String, dynamic> json) {
       return AfterHoursPreferences(
         id: json['id'] as String?,
         genderSeeking: json['gender_seeking'] as String?,
         minAge: json['min_age'] as int?,
         maxAge: json['max_age'] as int?,
         maxDistanceKm: (json['max_distance_km'] as num?)?.toDouble(),
       );
     }

     bool get isComplete => genderSeeking != null;
   }
   ```

2. Service class extending ChangeNotifier:
   ```dart
   class AfterHoursProfileService extends ChangeNotifier {
     final AuthService _authService;

     AfterHoursProfile? _profile;
     AfterHoursPreferences? _preferences;
     bool _isLoading = false;

     AfterHoursProfile? get profile => _profile;
     AfterHoursPreferences? get preferences => _preferences;
     bool get isLoading => _isLoading;
     bool get isSetupComplete => (_profile?.isComplete ?? false) && (_preferences?.isComplete ?? false);

     AfterHoursProfileService(this._authService);

     String get _baseUrl => AppConfig.profileServiceUrl;
   ```

3. Profile methods:
   - `Future<AfterHoursProfile?> getProfile()` - GET /api/after-hours/profile
   - `Future<AfterHoursProfile?> createProfile({required String bio})` - POST /api/after-hours/profile
   - `Future<AfterHoursProfile?> updateProfile({String? bio})` - PATCH /api/after-hours/profile
   - `Future<String?> uploadPhoto(File imageFile)` - POST /api/after-hours/profile/photo (multipart)

4. Preferences methods:
   - `Future<AfterHoursPreferences?> getPreferences()` - GET /api/after-hours/preferences
   - `Future<AfterHoursPreferences?> createPreferences({String? genderSeeking, int? minAge, int? maxAge, double? maxDistanceKm})` - POST /api/after-hours/preferences
   - `Future<AfterHoursPreferences?> updatePreferences({String? genderSeeking, int? minAge, int? maxAge, double? maxDistanceKm})` - PATCH /api/after-hours/preferences

5. Utility method:
   - `Future<void> loadAll()` - loads both profile and preferences, caches in _profile/_preferences, calls notifyListeners()

6. Error handling: return null on error, use debugPrint for logging, follow existing patterns.

7. Photo upload uses multipart/form-data, follow existing PhotoManagerWidget patterns for image handling.

Import AppConfig for base URL, http package for requests, dart:io for File.
  </action>
  <verify>
    - `flutter analyze frontend/lib/services/after_hours_profile_service.dart` shows no errors
    - All API methods match backend endpoints from Phase 2
  </verify>
  <done>AfterHoursProfileService exists with profile CRUD, photo upload, and preferences CRUD</done>
</task>

<task type="auto">
  <name>Task 2: Create After Hours profile screen</name>
  <files>frontend/lib/screens/after_hours_profile_screen.dart</files>
  <action>
Create AfterHoursProfileScreen following existing profile_edit_screen.dart patterns:

1. StatefulWidget with:
   - `_isLoading` state
   - `_isSaving` state
   - `_bioController` TextEditingController
   - `_currentPhotoUrl` String? for displaying current photo
   - `_selectedImage` File? for new photo selection

2. initState:
   - Call `_loadProfile()` to fetch existing profile

3. UI structure:
   ```dart
   Scaffold(
     appBar: AppBar(
       title: Text('After Hours Profile'),
       actions: [
         // Save button (enabled when form valid)
         TextButton(
           onPressed: _isSaving ? null : _saveProfile,
           child: _isSaving ? CircularProgressIndicator() : Text('Save'),
         ),
       ],
     ),
     body: _isLoading ? VlvtLoader() : SingleChildScrollView(
       child: Column(
         children: [
           // Photo section
           _buildPhotoSection(),

           // Bio section
           Padding(
             padding: EdgeInsets.all(16),
             child: Column(
               crossAxisAlignment: CrossAxisAlignment.start,
               children: [
                 Text('After Hours Bio', style: VlvtTextStyles.labelLarge),
                 SizedBox(height: 8),
                 Text(
                   'Describe what you\'re looking for tonight',
                   style: VlvtTextStyles.bodySmall.copyWith(color: VlvtColors.textMuted),
                 ),
                 SizedBox(height: 12),
                 VlvtInput(
                   controller: _bioController,
                   hintText: 'Looking for...',
                   maxLines: 4,
                   maxLength: 500,
                 ),
               ],
             ),
           ),

           // Info banner
           Container(
             margin: EdgeInsets.all(16),
             padding: EdgeInsets.all(12),
             decoration: BoxDecoration(
               color: VlvtColors.gold.withOpacity(0.1),
               borderRadius: BorderRadius.circular(8),
             ),
             child: Row(
               children: [
                 Icon(Icons.info_outline, color: VlvtColors.gold),
                 SizedBox(width: 12),
                 Expanded(
                   child: Text(
                     'Your After Hours profile is separate from your main profile and only visible during active sessions.',
                     style: VlvtTextStyles.bodySmall,
                   ),
                 ),
               ],
             ),
           ),
         ],
       ),
     ),
   )
   ```

4. Photo section:
   - Show current photo or placeholder
   - Tap to pick new photo (use image_picker)
   - Show loading indicator during upload

5. Methods:
   - `_loadProfile()` - fetch profile from service, populate bio controller
   - `_pickImage()` - use image_picker to select image
   - `_saveProfile()` - upload photo if changed, then create/update profile
   - Validate bio is not empty before saving

6. Navigation: pop with result true on successful save so caller knows to refresh

Use VlvtColors, VlvtTextStyles, VlvtInput, VlvtButton, VlvtLoader widgets.
  </action>
  <verify>
    - `flutter analyze frontend/lib/screens/after_hours_profile_screen.dart` shows no errors
    - Screen has photo upload and bio input
  </verify>
  <done>AfterHoursProfileScreen exists with photo upload and bio editing functionality</done>
</task>

<task type="auto">
  <name>Task 3: Create After Hours preferences screen and register service</name>
  <files>frontend/lib/screens/after_hours_preferences_screen.dart, frontend/lib/providers/provider_tree.dart</files>
  <action>
1. Create AfterHoursPreferencesScreen following discovery_filters_screen.dart patterns:

   StatefulWidget with:
   - `_isLoading` state
   - `_isSaving` state
   - `_genderSeeking` String? ('male', 'female', 'any')
   - `_minAge` int (default 18)
   - `_maxAge` int (default 99)
   - `_maxDistanceKm` double (default 50)

   UI structure:
   ```dart
   Scaffold(
     appBar: AppBar(
       title: Text('After Hours Preferences'),
       actions: [
         TextButton(
           onPressed: _isSaving ? null : _savePreferences,
           child: _isSaving ? CircularProgressIndicator() : Text('Save'),
         ),
       ],
     ),
     body: _isLoading ? VlvtLoader() : SingleChildScrollView(
       child: Column(
         crossAxisAlignment: CrossAxisAlignment.start,
         children: [
           // Gender seeking section
           Padding(
             padding: EdgeInsets.all(16),
             child: Column(
               crossAxisAlignment: CrossAxisAlignment.start,
               children: [
                 Text('Show me', style: VlvtTextStyles.labelLarge),
                 SizedBox(height: 12),
                 // Radio buttons or segmented control for male/female/any
                 _buildGenderOptions(),
               ],
             ),
           ),

           Divider(),

           // Age range section
           Padding(
             padding: EdgeInsets.all(16),
             child: Column(
               crossAxisAlignment: CrossAxisAlignment.start,
               children: [
                 Text('Age range', style: VlvtTextStyles.labelLarge),
                 SizedBox(height: 8),
                 Text('$_minAge - $_maxAge years', style: VlvtTextStyles.bodyMedium),
                 RangeSlider(
                   values: RangeValues(_minAge.toDouble(), _maxAge.toDouble()),
                   min: 18,
                   max: 99,
                   divisions: 81,
                   onChanged: (values) {
                     setState(() {
                       _minAge = values.start.round();
                       _maxAge = values.end.round();
                     });
                   },
                 ),
               ],
             ),
           ),

           Divider(),

           // Distance section
           Padding(
             padding: EdgeInsets.all(16),
             child: Column(
               crossAxisAlignment: CrossAxisAlignment.start,
               children: [
                 Text('Maximum distance', style: VlvtTextStyles.labelLarge),
                 SizedBox(height: 8),
                 Text('${_maxDistanceKm.round()} km', style: VlvtTextStyles.bodyMedium),
                 Slider(
                   value: _maxDistanceKm,
                   min: 1,
                   max: 100,
                   divisions: 99,
                   onChanged: (value) {
                     setState(() {
                       _maxDistanceKm = value;
                     });
                   },
                 ),
               ],
             ),
           ),
         ],
       ),
     ),
   )
   ```

   Methods:
   - `_loadPreferences()` - fetch from service, populate form state
   - `_savePreferences()` - validate genderSeeking is set, then create/update
   - `_buildGenderOptions()` - returns Row of RadioListTile or ChoiceChip widgets

2. Update provider_tree.dart to add AfterHoursProfileService:

   Add to the afterHours() method:
   ```dart
   ChangeNotifierProxyProvider<AuthService, AfterHoursProfileService>(
     create: (context) => AfterHoursProfileService(context.read<AuthService>()),
     update: (context, auth, previous) => previous ?? AfterHoursProfileService(auth),
   ),
   ```

   Add import at top:
   ```dart
   import '../services/after_hours_profile_service.dart';
   ```
  </action>
  <verify>
    - `flutter analyze frontend/lib/screens/after_hours_preferences_screen.dart` shows no errors
    - `flutter analyze frontend/lib/providers/provider_tree.dart` shows no errors
    - AfterHoursProfileService is registered in provider tree
  </verify>
  <done>AfterHoursPreferencesScreen exists with gender/age/distance settings, AfterHoursProfileService registered in providers</done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter analyze` - no errors in new files
2. Navigate to profile screen from After Hours tab (will need temporary navigation for testing)
3. Create profile with photo and bio
4. Navigate to preferences screen
5. Set preferences and save
6. Verify data persists (refresh and data still there)
</verification>

<success_criteria>
- AfterHoursProfileService has working API methods for profile and preferences
- Profile screen allows photo upload and bio editing
- Preferences screen allows gender seeking, age range, and distance settings
- Both screens validate required fields before saving
- Data persists via backend API
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-02-SUMMARY.md`
</output>
