---
phase: 06-frontend-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/services/after_hours_service.dart
  - frontend/lib/providers/provider_tree.dart
  - frontend/lib/screens/main_screen.dart
autonomous: true

must_haves:
  truths:
    - "AfterHoursService exists and manages session state machine"
    - "Service subscribes to all After Hours socket events"
    - "Premium users see After Hours tab in navigation"
    - "Service is accessible via Provider throughout app"
  artifacts:
    - path: "frontend/lib/services/after_hours_service.dart"
      provides: "After Hours session state machine"
      exports: ["AfterHoursService", "AfterHoursState"]
      min_lines: 150
    - path: "frontend/lib/providers/provider_tree.dart"
      provides: "AfterHoursService registration"
      contains: "AfterHoursService"
    - path: "frontend/lib/screens/main_screen.dart"
      provides: "After Hours tab for premium users"
      contains: "AfterHoursTabScreen"
  key_links:
    - from: "frontend/lib/services/after_hours_service.dart"
      to: "socket_service.dart"
      via: "StreamSubscription to After Hours events"
      pattern: "_socketService\\.on"
    - from: "frontend/lib/providers/provider_tree.dart"
      to: "after_hours_service.dart"
      via: "ChangeNotifierProxyProvider2"
      pattern: "AfterHoursService"
---

<objective>
Create the core AfterHoursService state machine and integrate After Hours tab into main navigation for premium users.

Purpose: Establishes the central coordination service for all After Hours functionality and makes it accessible throughout the app.

Output: Working state machine service with socket event subscriptions and visible tab entry point.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-CONTEXT.md
@.planning/phases/06-frontend-integration/06-RESEARCH.md

Reference existing patterns:
@frontend/lib/services/socket_service.dart (After Hours event streams)
@frontend/lib/services/subscription_service.dart (ChangeNotifier pattern)
@frontend/lib/providers/provider_tree.dart (provider registration)
@frontend/lib/screens/main_screen.dart (tab navigation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AfterHoursService state machine</name>
  <files>frontend/lib/services/after_hours_service.dart</files>
  <action>
Create AfterHoursService extending ChangeNotifier with:

1. AfterHoursState enum:
   - `inactive` - user not in session, show setup/start UI
   - `activating` - checking profile/preferences, preparing session
   - `searching` - session active, looking for matches
   - `matched` - match found, showing match card
   - `chatting` - user accepted match, in ephemeral chat
   - `expiring` - 2-minute warning before session ends
   - `expired` - session ended

2. State properties:
   - `_state: AfterHoursState` (default: inactive)
   - `_sessionId: String?`
   - `_expiresAt: DateTime?`
   - `_currentMatch: AfterHoursMatch?` (create simple model class in same file)
   - `_nearbyCount: int` (from no_matches events)
   - `_partnerSaved: bool` (for save button state)

3. Getters:
   - `state`, `sessionId`, `expiresAt`, `currentMatch`, `nearbyCount`, `partnerSaved`
   - `remainingSeconds` -> calculated from expiresAt and DateTime.now()
   - `isSessionActive` -> state is searching, matched, chatting, or expiring

4. Constructor takes AuthService and SocketService:
   ```dart
   AfterHoursService(this._authService, this._socketService);
   ```

5. Private subscriptions (StreamSubscription? for each):
   - `_matchSubscription` -> onAfterHoursMatch
   - `_messageSubscription` -> onAfterHoursMessage (for unread count later)
   - `_expiringSubscription` -> onSessionExpiring
   - `_expiredSubscription` -> onSessionExpired
   - `_noMatchesSubscription` -> onNoMatches
   - `_matchExpiredSubscription` -> onMatchExpired
   - `_partnerSavedSubscription` -> onPartnerSaved
   - `_matchSavedSubscription` -> onMatchSaved

6. Methods:
   - `_setState(AfterHoursState newState)` - updates state and calls notifyListeners()
   - `_subscribeToEvents()` - sets up all socket subscriptions
   - `_unsubscribeFromEvents()` - cancels all subscriptions
   - `startSession({required int durationMinutes, required double lat, required double lng})` - async, sets activating then searching
   - `endSession()` - async, ends session early
   - `acceptMatch()` - transitions to chatting state, joins socket room
   - `declineMatch()` - calls decline API, returns to searching
   - `refreshSessionStatus()` - async, checks with API if session still active (for app resume)
   - `dispose()` - unsubscribes from events

7. Socket event handlers (in _subscribeToEvents):
   - `after_hours:match` -> parse to AfterHoursMatch, set _currentMatch, setState(matched)
   - `after_hours:session_expiring` -> setState(expiring)
   - `after_hours:session_expired` -> reset state to inactive, clear session data
   - `after_hours:no_matches` -> update _nearbyCount from payload
   - `after_hours:match_expired` -> clear _currentMatch, setState(searching)
   - `after_hours:partner_saved` -> set _partnerSaved = true, notifyListeners()
   - `after_hours:match_saved` -> transition to permanent match notification

8. AfterHoursMatch model (simple class in same file):
   ```dart
   class AfterHoursMatch {
     final String id;
     final String oduserId;
     final String name;
     final int age;
     final String? photoUrl;
     final String? bio;
     final double distance;
     final DateTime? autoDeclineAt;
     // fromJson constructor
   }
   ```

Follow existing SocketService and SubscriptionService patterns exactly. Use debugPrint for logging.
  </action>
  <verify>
    - `flutter analyze frontend/lib/services/after_hours_service.dart` shows no errors
    - File exports AfterHoursService and AfterHoursState
  </verify>
  <done>AfterHoursService class exists with state machine, socket subscriptions, and AfterHoursMatch model</done>
</task>

<task type="auto">
  <name>Task 2: Register AfterHoursService in provider tree</name>
  <files>frontend/lib/providers/provider_tree.dart</files>
  <action>
Update provider_tree.dart to include AfterHoursService:

1. Add import:
   ```dart
   import '../services/after_hours_service.dart';
   import '../services/after_hours_chat_service.dart';
   ```

2. Add new `afterHours()` static method following existing pattern:
   ```dart
   /// After Hours feature providers
   /// Used for After Hours mode session management and chat
   static List<SingleChildWidget> afterHours() => [
     ChangeNotifierProxyProvider2<AuthService, SocketService, AfterHoursService>(
       create: (context) => AfterHoursService(
         context.read<AuthService>(),
         context.read<SocketService>(),
       ),
       update: (context, auth, socket, previous) =>
           previous ?? AfterHoursService(auth, socket),
     ),
     ChangeNotifierProxyProvider2<AuthService, SocketService, AfterHoursChatService>(
       create: (context) => AfterHoursChatService(
         context.read<AuthService>(),
         context.read<SocketService>(),
       ),
       update: (context, auth, socket, previous) =>
           previous ?? AfterHoursChatService(auth, socket),
     ),
   ];
   ```

3. Update `all()` method to include afterHours():
   ```dart
   static List<SingleChildWidget> all(ThemeService themeService) => [
     ...core(themeService),
     ...discovery(),
     ...profile(),
     ...chat(),
     ...safety(),
     ...dating(),
     ...afterHours(),  // ADD THIS
   ];
   ```

4. Update `authenticatedUser()` method similarly:
   ```dart
   static List<SingleChildWidget> authenticatedUser() => [
     ...discovery(),
     ...profile(),
     ...chat(),
     ...safety(),
     ...dating(),
     ...afterHours(),  // ADD THIS
   ];
   ```

5. Add extension method for After Hours providers:
   ```dart
   /// Wrap with After Hours feature providers
   Widget withAfterHoursProviders() {
     return MultiProvider(
       providers: ProviderTree.afterHours(),
       child: this,
     );
   }
   ```

Note: ChangeNotifierProxyProvider2 is used because AfterHoursService depends on both AuthService AND SocketService.
  </action>
  <verify>
    - `flutter analyze frontend/lib/providers/provider_tree.dart` shows no errors
    - AfterHoursService appears in the provider tree
  </verify>
  <done>AfterHoursService and AfterHoursChatService registered in provider tree with correct dependencies</done>
</task>

<task type="auto">
  <name>Task 3: Add After Hours tab to main navigation</name>
  <files>frontend/lib/screens/main_screen.dart, frontend/lib/screens/after_hours_tab_screen.dart</files>
  <action>
1. Create placeholder after_hours_tab_screen.dart:
   ```dart
   /// After Hours Tab Screen
   /// Entry point for After Hours mode
   library;

   import 'package:flutter/material.dart';
   import 'package:provider/provider.dart';
   import '../services/after_hours_service.dart';
   import '../theme/vlvt_colors.dart';
   import '../theme/vlvt_text_styles.dart';

   class AfterHoursTabScreen extends StatelessWidget {
     const AfterHoursTabScreen({super.key});

     @override
     Widget build(BuildContext context) {
       final afterHoursService = context.watch<AfterHoursService>();
       final state = afterHoursService.state;

       return Scaffold(
         backgroundColor: VlvtColors.background,
         appBar: AppBar(
           backgroundColor: VlvtColors.background,
           title: Text('After Hours', style: VlvtTextStyles.h2),
         ),
         body: Center(
           child: Column(
             mainAxisAlignment: MainAxisAlignment.center,
             children: [
               Icon(
                 Icons.nightlife,
                 size: 64,
                 color: VlvtColors.gold,
               ),
               const SizedBox(height: 16),
               Text(
                 'After Hours Mode',
                 style: VlvtTextStyles.h2,
               ),
               const SizedBox(height: 8),
               Text(
                 'Current state: ${state.name}',
                 style: VlvtTextStyles.bodyMedium.copyWith(
                   color: VlvtColors.textSecondary,
                 ),
               ),
               const SizedBox(height: 24),
               Text(
                 'Coming soon...',
                 style: VlvtTextStyles.labelMedium.copyWith(
                   color: VlvtColors.textMuted,
                 ),
               ),
             ],
           ),
         ),
       );
     }
   }
   ```

2. Update main_screen.dart:
   - Add import: `import 'after_hours_tab_screen.dart';`
   - In the premium user section (around line 124), insert After Hours between Discovery and Matches:

   ```dart
   if (hasPremium) {
     screens = const [
       DiscoveryScreen(),
       AfterHoursTabScreen(),  // NEW
       MatchesScreen(),
       ChatsScreen(),
       ProfileScreen(),
     ];
     navItems = const [
       BottomNavigationBarItem(
         icon: Icon(Icons.explore),
         label: 'Discovery',
       ),
       BottomNavigationBarItem(  // NEW
         icon: Icon(Icons.nightlife),
         label: 'After Hours',
       ),
       BottomNavigationBarItem(
         icon: Icon(Icons.favorite),
         label: 'Matches',
       ),
       BottomNavigationBarItem(
         icon: Icon(Icons.chat_bubble),
         label: 'Chats',
       ),
       BottomNavigationBarItem(
         icon: Icon(Icons.person),
         label: 'Profile',
       ),
     ];
   }
   ```

3. Update _handleNotificationTap in main.dart to handle the new tab index:
   - For premium users, Matches tab is now index 2 (was 1)
   - Update the targetTab calculation accordingly
  </action>
  <verify>
    - `flutter analyze frontend/lib/screens/main_screen.dart` shows no errors
    - `flutter analyze frontend/lib/screens/after_hours_tab_screen.dart` shows no errors
    - Run app, login as premium user, verify 5 tabs visible with After Hours tab showing placeholder
  </verify>
  <done>After Hours tab visible in navigation for premium users, placeholder screen shows current state</done>
</task>

</tasks>

<verification>
1. `cd frontend && flutter analyze` - no errors in new/modified files
2. Run app as premium user - verify 5 tabs visible (Discovery, After Hours, Matches, Chats, Profile)
3. Tap After Hours tab - see placeholder with "Current state: inactive"
4. Check provider tree - AfterHoursService accessible via context.read()
</verification>

<success_criteria>
- AfterHoursService exists with full state machine (7 states)
- AfterHoursService subscribes to all 8 After Hours socket event streams
- AfterHoursService registered in provider tree with correct dependencies
- Premium users see After Hours tab (non-premium users do not)
- Placeholder screen displays and shows current state from service
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-01-SUMMARY.md`
</output>
