---
phase: 05-monitoring-alerting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/auth-service/src/index.ts
  - backend/profile-service/src/index.ts
  - backend/chat-service/src/index.ts
  - backend/shared/src/middleware/correlation-id.ts
  - backend/shared/src/middleware/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Sentry errors show service name in dashboard grouping"
    - "Sentry events include release version for tracking"
    - "PII is scrubbed before events reach Sentry dashboard"
    - "Every HTTP request has a correlation ID in logs and response headers"
  artifacts:
    - path: "backend/shared/src/middleware/correlation-id.ts"
      provides: "Correlation ID middleware"
      exports: ["correlationMiddleware"]
    - path: "backend/auth-service/src/index.ts"
      provides: "Enhanced Sentry init with service name and beforeSend"
      contains: "serviceName.*auth-service"
    - path: "backend/profile-service/src/index.ts"
      provides: "Enhanced Sentry init with service name and beforeSend"
      contains: "serviceName.*profile-service"
    - path: "backend/chat-service/src/index.ts"
      provides: "Enhanced Sentry init with service name and beforeSend"
      contains: "serviceName.*chat-service"
  key_links:
    - from: "backend/*/src/index.ts"
      to: "Sentry.init()"
      via: "beforeSend callback"
      pattern: "beforeSend.*event"
    - from: "backend/shared/src/middleware/correlation-id.ts"
      to: "backend/*/src/index.ts"
      via: "app.use(correlationMiddleware)"
      pattern: "correlationMiddleware"
---

<objective>
Enhance Sentry configuration and add correlation ID middleware across all services.

Purpose: Production errors need proper grouping by service and release version for effective debugging. Every request needs a traceable correlation ID for log correlation across async operations.

Output: Enhanced Sentry configuration with service names, release tracking, PII scrubbing in beforeSend; correlation ID middleware propagating IDs through request lifecycle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-monitoring-alerting/05-RESEARCH.md

# Existing infrastructure
@backend/shared/src/errors/error-response.ts - Has generateCorrelationId()
@backend/shared/src/utils/logger.ts - SENSITIVE_FIELDS for reference
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create correlation ID middleware in shared package</name>
  <files>backend/shared/src/middleware/correlation-id.ts, backend/shared/src/middleware/index.ts</files>
  <action>
Create `backend/shared/src/middleware/correlation-id.ts`:

```typescript
/**
 * Correlation ID Middleware
 * Generates or propagates correlation IDs across the request lifecycle
 * for log tracing and debugging (MON-05)
 */

import { Request, Response, NextFunction } from 'express';
import { generateCorrelationId } from '../errors/error-response';

// Extend Express Request type to include correlationId
declare global {
  namespace Express {
    interface Request {
      correlationId?: string;
    }
  }
}

/**
 * Middleware that ensures every request has a correlation ID.
 * - Uses incoming X-Correlation-ID header if present (for service-to-service calls)
 * - Generates new ID if not present
 * - Attaches to request object for use in handlers
 * - Sets X-Correlation-ID response header for client tracing
 */
export function correlationMiddleware(req: Request, res: Response, next: NextFunction): void {
  // Use incoming correlation ID if present, otherwise generate new one
  const correlationId = (req.headers['x-correlation-id'] as string) || generateCorrelationId();

  // Attach to request for use in handlers
  req.correlationId = correlationId;

  // Set response header for client-side tracing
  res.setHeader('X-Correlation-ID', correlationId);

  next();
}
```

Update `backend/shared/src/middleware/index.ts` to export the new middleware:
- Add: `export * from './correlation-id';`

Verify the shared package exports are correct.
  </action>
  <verify>
Run `npm run build` in backend/shared to verify TypeScript compiles.
Check that `correlationMiddleware` is exported from index.
  </verify>
  <done>
Correlation ID middleware exists and is exported from @vlvt/shared.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Sentry configuration across all services</name>
  <files>backend/auth-service/src/index.ts, backend/profile-service/src/index.ts, backend/chat-service/src/index.ts</files>
  <action>
For each service (auth-service, profile-service, chat-service), enhance the existing Sentry.init() block:

1. **Add service name via initialScope.tags** for dashboard grouping
2. **Add release version** from package.json or environment variable
3. **Add beforeSend callback** to scrub PII before events reach Sentry

The enhanced Sentry.init() should look like this (adapt service name for each):

```typescript
if (process.env.SENTRY_DSN) {
  Sentry.init({
    dsn: process.env.SENTRY_DSN,
    environment: process.env.NODE_ENV || 'development',
    tracesSampleRate: 0.1, // 10% of transactions (keep existing)

    // Service identification for dashboard grouping
    initialScope: {
      tags: {
        service: 'auth-service', // or profile-service, chat-service
      },
    },

    // Release tracking (use RAILWAY_GIT_COMMIT_SHA in production, or npm version)
    release: process.env.RAILWAY_GIT_COMMIT_SHA || process.env.npm_package_version || 'development',

    // PII scrubbing before events reach Sentry
    beforeSend(event) {
      // Scrub request body (may contain passwords, tokens, messages)
      if (event.request?.data) {
        event.request.data = '[REDACTED]';
      }

      // Scrub query strings (may contain tokens)
      if (event.request?.query_string) {
        event.request.query_string = '[REDACTED]';
      }

      // Scrub cookies (contain session tokens)
      if (event.request?.cookies) {
        event.request.cookies = {};
      }

      // Scrub authorization headers
      if (event.request?.headers) {
        const sensitiveHeaders = ['authorization', 'cookie', 'x-csrf-token'];
        for (const header of sensitiveHeaders) {
          if (event.request.headers[header]) {
            event.request.headers[header] = '[REDACTED]';
          }
        }
      }

      return event;
    },
  });
}
```

Also add correlation ID middleware after other middleware but before routes:
- Import: `import { correlationMiddleware } from '@vlvt/shared';`
- Add: `app.use(correlationMiddleware);` (after body parsers, before routes)
  </action>
  <verify>
For each service:
1. `npm run build` compiles without errors
2. `grep -n "initialScope" src/index.ts` shows service tag
3. `grep -n "beforeSend" src/index.ts` shows PII scrubbing callback
4. `grep -n "correlationMiddleware" src/index.ts` shows middleware usage
  </verify>
  <done>
All three services have enhanced Sentry configuration with:
- Service name tag for dashboard grouping
- Release version for tracking deployments
- beforeSend callback scrubbing request body, query strings, cookies, and auth headers
- Correlation ID middleware propagating IDs through request lifecycle
  </done>
</task>

</tasks>

<verification>
1. `cd backend/shared && npm run build` - shared package compiles
2. `cd backend/auth-service && npm run build` - auth-service compiles
3. `cd backend/profile-service && npm run build` - profile-service compiles
4. `cd backend/chat-service && npm run build` - chat-service compiles
5. Verify Sentry init blocks contain: `initialScope`, `release`, `beforeSend`
6. Verify all services import and use `correlationMiddleware`
</verification>

<success_criteria>
- Sentry.init() in all 3 services includes service name tag
- Sentry.init() in all 3 services includes release tracking
- Sentry.init() in all 3 services has beforeSend PII scrubbing
- Correlation ID middleware exists in shared package
- All 3 services use correlation ID middleware
- All services build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-monitoring-alerting/05-01-SUMMARY.md`
</output>
