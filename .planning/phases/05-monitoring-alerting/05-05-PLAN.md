---
phase: 05-monitoring-alerting
plan: 05
type: execute
wave: 3
depends_on: ["05-01"]
files_modified:
  - backend/shared/src/middleware/request-logger.ts
  - backend/shared/src/middleware/index.ts
  - backend/shared/src/index.ts
  - backend/auth-service/src/index.ts
  - backend/profile-service/src/index.ts
  - backend/chat-service/src/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Every HTTP request log entry contains correlationId field"
    - "Correlation IDs propagate from middleware to log output"
    - "Log output is structured JSON with correlationId included"
  artifacts:
    - path: "backend/shared/src/middleware/request-logger.ts"
      provides: "Request logger middleware that attaches child logger with correlationId"
      exports: ["requestLoggerMiddleware", "createRequestLogger"]
    - path: "backend/shared/src/middleware/index.ts"
      provides: "Export of requestLoggerMiddleware"
      contains: "requestLoggerMiddleware"
  key_links:
    - from: "correlation-id.ts"
      to: "request-logger.ts"
      via: "req.correlationId used in child logger"
      pattern: "req\\.correlationId"
    - from: "request-logger.ts"
      to: "all services index.ts"
      via: "app.use(requestLoggerMiddleware)"
      pattern: "requestLoggerMiddleware"
    - from: "req.logger"
      to: "log output"
      via: "child logger with correlationId in defaultMeta"
      pattern: "correlationId"
---

<objective>
Wire correlation IDs into actual log output by creating request logger middleware.

Purpose: MON-05 requires correlation IDs in logs for request tracing. The correlation ID middleware (05-01) sets req.correlationId and X-Correlation-ID response header, but this value is never included in actual log output. This plan creates a request logger middleware that attaches a child logger with correlationId to each request, enabling request tracing across async operations.

Output: Request logger middleware in shared package, integrated into all three services, producing logs with correlationId field.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-monitoring-alerting/05-01-SUMMARY.md
@backend/shared/src/middleware/correlation-id.ts - Existing correlation middleware
@backend/shared/src/utils/logger.ts - Winston logger with PII redaction
@backend/shared/src/middleware/index.ts - Middleware exports
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create request logger middleware</name>
  <files>backend/shared/src/middleware/request-logger.ts, backend/shared/src/middleware/index.ts, backend/shared/src/index.ts</files>
  <action>
Create `backend/shared/src/middleware/request-logger.ts`:

```typescript
/**
 * Request Logger Middleware
 * Attaches a child logger with correlationId to each request (MON-05)
 *
 * Must be used AFTER correlationMiddleware to access req.correlationId
 */

import { Request, Response, NextFunction } from 'express';
import winston from 'winston';
import { createLogger, LoggerOptions } from '../utils/logger';

// Extend Express Request type to include logger
declare global {
  namespace Express {
    interface Request {
      logger?: winston.Logger;
    }
  }
}

/**
 * Creates a child logger with correlationId in defaultMeta
 * Winston child loggers inherit parent config but add custom metadata
 */
export function createRequestLogger(
  parentLogger: winston.Logger,
  correlationId: string
): winston.Logger {
  return parentLogger.child({
    correlationId,
  });
}

/**
 * Middleware factory that creates request logger middleware for a service
 * @param logger - The service's Winston logger instance
 * @returns Express middleware that attaches req.logger with correlationId
 */
export function createRequestLoggerMiddleware(logger: winston.Logger) {
  return function requestLoggerMiddleware(
    req: Request,
    res: Response,
    next: NextFunction
  ): void {
    // Use correlationId from correlation middleware (must run after correlationMiddleware)
    const correlationId = req.correlationId || 'unknown';

    // Create child logger with correlationId in metadata
    req.logger = createRequestLogger(logger, correlationId);

    // Log request start
    req.logger.info('Request started', {
      method: req.method,
      path: req.path,
      userAgent: req.get('user-agent'),
    });

    // Log request completion
    const startTime = Date.now();
    res.on('finish', () => {
      const duration = Date.now() - startTime;
      req.logger?.info('Request completed', {
        method: req.method,
        path: req.path,
        statusCode: res.statusCode,
        durationMs: duration,
      });
    });

    next();
  };
}

export default createRequestLoggerMiddleware;
```

**Key design decisions:**
1. Uses Winston's `child()` method which inherits parent format, transports, and level but adds correlationId to metadata
2. The middleware logs request start/completion with automatic timing
3. Extends Express Request interface to add optional `logger` property
4. Requires correlationMiddleware to run first (documented in comments)

**Export from middleware index.ts:**
Add to `backend/shared/src/middleware/index.ts`:
```typescript
// Request logging with correlation ID (MON-05)
export { createRequestLoggerMiddleware, createRequestLogger } from './request-logger';
```

**Export from main index.ts:**
Add to `backend/shared/src/index.ts`:
```typescript
// Request logging middleware
export { createRequestLoggerMiddleware, createRequestLogger } from './middleware/request-logger';
```
  </action>
  <verify>
1. `cd backend/shared && npm run build` compiles successfully
2. `grep -n "correlationId" backend/shared/dist/middleware/request-logger.js` shows correlationId in output
3. `grep -n "createRequestLoggerMiddleware" backend/shared/src/index.ts` shows export
  </verify>
  <done>
Request logger middleware created in shared package with Winston child logger pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate request logger into all services</name>
  <files>backend/auth-service/src/index.ts, backend/profile-service/src/index.ts, backend/chat-service/src/index.ts</files>
  <action>
Update each service's index.ts to:
1. Import createRequestLoggerMiddleware from @vlvt/shared
2. Add requestLoggerMiddleware AFTER correlationMiddleware

**Pattern for each service:**

1. Add import (near existing @vlvt/shared imports):
```typescript
import {
  // ... existing imports ...
  createRequestLoggerMiddleware,
} from '@vlvt/shared';
```

2. Create the middleware instance after logger is defined:
```typescript
// Create request logger middleware with service logger
const requestLoggerMiddleware = createRequestLoggerMiddleware(logger);
```

3. Add middleware AFTER correlationMiddleware:
```typescript
// Correlation ID middleware - generates/propagates IDs for request tracing (MON-05)
app.use(correlationMiddleware);

// Request logger middleware - attaches child logger with correlationId (MON-05)
app.use(requestLoggerMiddleware);
```

**Order is critical:**
- correlationMiddleware MUST run first (sets req.correlationId)
- requestLoggerMiddleware runs second (uses req.correlationId)
- CSRF and other middleware run after

**For auth-service (around line 295):**
Find:
```typescript
// Correlation ID middleware - generates/propagates IDs for request tracing (MON-05)
app.use(correlationMiddleware);
```

Replace with:
```typescript
// Correlation ID middleware - generates/propagates IDs for request tracing (MON-05)
app.use(correlationMiddleware);

// Request logger middleware - attaches child logger with correlationId (MON-05)
app.use(requestLoggerMiddleware);
```

**Repeat for profile-service and chat-service.**
  </action>
  <verify>
1. `cd backend/auth-service && npm run build` compiles
2. `cd backend/profile-service && npm run build` compiles
3. `cd backend/chat-service && npm run build` compiles
4. `grep -n "requestLoggerMiddleware" backend/*/src/index.ts` shows all 3 services
  </verify>
  <done>
Request logger middleware integrated into auth-service, profile-service, and chat-service.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify correlation IDs appear in log output</name>
  <files>backend/auth-service/src/index.ts</files>
  <action>
Run a quick verification to confirm correlation IDs appear in log output:

**Start auth-service locally and make a test request:**
```bash
cd backend/auth-service
npm run dev &
sleep 3
curl -v http://localhost:3001/health
```

**Check console output for:**
1. `correlationId` field in JSON logs
2. `Request started` log entry with correlationId
3. `Request completed` log entry with correlationId

**Expected log format (development console):**
```
12:00:00 [auth-service] info: Request started {"correlationId":"abc123","method":"GET","path":"/health","userAgent":"curl/7.x"}
12:00:00 [auth-service] info: Request completed {"correlationId":"abc123","method":"GET","path":"/health","statusCode":200,"durationMs":5}
```

**Expected log format (production JSON):**
```json
{"level":"info","message":"Request started","correlationId":"abc123","method":"GET","path":"/health","service":"auth-service","timestamp":"..."}
```

**If logs don't show correlationId:**
1. Check middleware order (correlation must be before request-logger)
2. Check createRequestLogger uses `child()` method correctly
3. Verify Winston child logger inherits format settings

**Kill the test server after verification:**
```bash
pkill -f "ts-node.*auth-service" || true
```
  </action>
  <verify>
1. Log output contains `correlationId` field in both development and JSON format
2. Request start/completion logs both include the same correlationId
3. Health endpoint responds with X-Correlation-ID header
  </verify>
  <done>
Correlation IDs confirmed in log output - MON-05 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. `cd backend/shared && npm run build` - shared package compiles
2. `cd backend/auth-service && npm run build` - auth-service compiles
3. `cd backend/profile-service && npm run build` - profile-service compiles
4. `cd backend/chat-service && npm run build` - chat-service compiles
5. Log output contains correlationId field
6. Request start/completion logs show same correlationId for each request
</verification>

<success_criteria>
- Request logger middleware created in @vlvt/shared
- Middleware uses Winston child() to add correlationId to metadata
- All 3 services use requestLoggerMiddleware after correlationMiddleware
- Log output contains correlationId field in structured JSON
- MON-05 gap closed: correlation IDs now appear in actual log output
</success_criteria>

<output>
After completion, create `.planning/phases/05-monitoring-alerting/05-05-SUMMARY.md`
</output>
