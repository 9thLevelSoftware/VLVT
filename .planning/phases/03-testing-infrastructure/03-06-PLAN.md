---
phase: 03-testing-infrastructure
plan: 06
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/chat-service/tests/after-hours.test.ts
autonomous: true

must_haves:
  truths:
    - "After Hours session start is tested"
    - "After Hours matching flow is tested"
    - "After Hours ephemeral chat is tested"
    - "After Hours save-to-permanent is tested"
  artifacts:
    - path: "backend/chat-service/tests/after-hours.test.ts"
      provides: "After Hours flow tests"
      exports: ["describe"]
      min_lines: 150
  key_links:
    - from: "after-hours.test.ts"
      to: "after-hours-chat.ts routes"
      via: "supertest"
      pattern: "post.*after-hours"
---

<objective>
Add After Hours flow tests (TEST-05)

Purpose: TEST-05 requires After Hours flow tests including session start, matching, ephemeral chat, and save. Research shows NO After Hours tests exist - routes are in profile-service (session/matching) and chat-service (messaging/save).

Output: New after-hours.test.ts with comprehensive After Hours flow tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-testing-infrastructure/03-RESEARCH.md
@backend/chat-service/src/routes/after-hours-chat.ts
@backend/profile-service/src/routes/after-hours.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create after-hours.test.ts for chat-service After Hours endpoints</name>
  <files>backend/chat-service/tests/after-hours.test.ts</files>
  <action>
Create new test file backend/chat-service/tests/after-hours.test.ts.

Reference the routes in after-hours-chat.ts:
- GET /after-hours/messages/:matchId
- POST /after-hours/matches/:matchId/save
- POST /after-hours/matches/:matchId/block
- POST /after-hours/matches/:matchId/report

Test setup pattern:
```typescript
import jwt from 'jsonwebtoken';

jest.mock('pg', () => {
  const mPool = {
    query: jest.fn(),
    on: jest.fn(),
    connect: jest.fn(),
  };
  return { Pool: jest.fn(() => mPool) };
});

jest.mock('@sentry/node', () => ({
  init: jest.fn(),
  setupExpressErrorHandler: jest.fn(),
}));

jest.mock('../src/services/match-conversion-service', () => ({
  recordSaveVote: jest.fn(),
}));

jest.mock('../src/services/after-hours-safety-service', () => ({
  blockAfterHoursUser: jest.fn(),
  reportAfterHoursUser: jest.fn(),
  VALID_REPORT_REASONS: ['inappropriate', 'harassment', 'spam', 'underage', 'other'],
}));

jest.mock('../src/socket/after-hours-handler', () => ({
  emitPartnerSaved: jest.fn(),
  emitMatchSaved: jest.fn(),
}));

import request from 'supertest';
import { Pool } from 'pg';
import { recordSaveVote } from '../src/services/match-conversion-service';
import { blockAfterHoursUser, reportAfterHoursUser } from '../src/services/after-hours-safety-service';

const JWT_SECRET = process.env.JWT_SECRET!;
```

Test cases to implement:

**describe('GET /after-hours/messages/:matchId')**
1. Should retrieve After Hours messages for own match
   - Mock match with user as participant
   - Mock messages query
   - Expect messages array

2. Should return 403 for match user is not part of

3. Should return 404 for non-existent match

4. Should return 400 for invalid matchId format (not UUID)

5. Should support 'before' cursor pagination

**describe('POST /after-hours/matches/:matchId/save')**
6. Should record save vote
   - Mock recordSaveVote returning { success: true, mutualSave: false }
   - Expect 200 with mutualSave: false

7. Should return mutualSave and permanentMatchId on mutual save
   - Mock recordSaveVote returning { success: true, mutualSave: true, permanentMatchId: 'xxx' }
   - Expect 200 with mutualSave: true, permanentMatchId

8. Should return 403 when user not in match

9. Should return 404 for non-existent match

**describe('POST /after-hours/matches/:matchId/block')**
10. Should block After Hours user
    - Mock blockAfterHoursUser returning { success: true }
    - Expect 200

11. Should return 403 for match user is not part of

12. Should return 404 for non-existent match

**describe('POST /after-hours/matches/:matchId/report')**
13. Should report After Hours user with valid reason
    - Mock reportAfterHoursUser returning { success: true }
    - Expect 200

14. Should return 400 for missing reason

15. Should return 400 for invalid reason

16. Should return 403 for match user is not part of
  </action>
  <verify>
Run: `cd backend/chat-service && npm test -- --testPathPattern="after-hours.test.ts" --verbose`
All After Hours tests should pass.
  </verify>
  <done>after-hours.test.ts created with 16 test cases for After Hours chat flows</done>
</task>

<task type="auto">
  <name>Task 2: Create after-hours-session.test.ts for profile-service After Hours endpoints</name>
  <files>backend/profile-service/tests/after-hours-session.test.ts</files>
  <action>
Create new test file backend/profile-service/tests/after-hours-session.test.ts.

Reference the routes in after-hours.ts (profile-service):
- POST /after-hours/session/start
- POST /after-hours/session/end
- GET /after-hours/session
- POST /after-hours/match/decline
- GET /after-hours/match/current

Note: The After Hours auth middleware requires premium + ID verification + consent. Mock these.

Test setup pattern:
```typescript
import jwt from 'jsonwebtoken';

jest.mock('pg', () => {
  const mPool = {
    query: jest.fn(),
    on: jest.fn(),
    connect: jest.fn().mockResolvedValue({
      query: jest.fn(),
      release: jest.fn(),
    }),
  };
  return { Pool: jest.fn(() => mPool) };
});

jest.mock('@sentry/node', () => ({
  init: jest.fn(),
  setupExpressErrorHandler: jest.fn(),
}));

jest.mock('@vlvt/shared', () => ({
  createAfterHoursAuthMiddleware: jest.fn(() => (req: any, res: any, next: any) => next()),
  // ... other shared mocks
}));

jest.mock('../src/services/session-scheduler', () => ({
  scheduleSessionExpiry: jest.fn().mockResolvedValue(undefined),
  cancelSessionExpiry: jest.fn().mockResolvedValue(undefined),
  extendSessionExpiry: jest.fn().mockResolvedValue(undefined),
  scheduleSessionExpiryWarning: jest.fn().mockResolvedValue(undefined),
  cancelSessionExpiryWarning: jest.fn().mockResolvedValue(undefined),
}));

jest.mock('../src/services/matching-scheduler', () => ({
  triggerMatchingForUser: jest.fn().mockResolvedValue(undefined),
  cancelAutoDecline: jest.fn().mockResolvedValue(undefined),
}));
```

Test cases to implement:

**describe('POST /after-hours/session/start')**
1. Should start session with valid location and duration
   - Mock profile exists
   - Mock no active session
   - Mock session insertion
   - Expect 201 with session object

2. Should return 400 when profile doesn't exist

3. Should return 409 when session already active

4. Should validate duration range

**describe('POST /after-hours/session/end')**
5. Should end active session
   - Mock active session exists
   - Expect 200

6. Should return 404 when no active session

**describe('GET /after-hours/session')**
7. Should return active session status
   - Mock active session
   - Expect active: true, remainingSeconds

8. Should return active: false when no session

**describe('POST /after-hours/match/decline')**
9. Should decline current match
   - Mock active session
   - Mock match exists with user
   - Expect 200

10. Should return 400 without active session

11. Should return 404 for non-existent match

**describe('GET /after-hours/match/current')**
12. Should return current match when matched
   - Mock active session
   - Mock undeclined match
   - Expect status: 'matched'

13. Should return status: 'searching' when no match

14. Should return status: 'no_session' without active session
  </action>
  <verify>
Run: `cd backend/profile-service && npm test -- --testPathPattern="after-hours-session.test.ts" --verbose`
All session tests should pass.
  </verify>
  <done>after-hours-session.test.ts created with 14 test cases for After Hours session flows</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run all After Hours tests:
```bash
cd backend/chat-service && npm test -- --testPathPattern="after-hours" --verbose
cd backend/profile-service && npm test -- --testPathPattern="after-hours" --verbose
```

2. Verify TEST-05 coverage:
- Session lifecycle (start, end, extend, status)
- Matching (current match, decline)
- Ephemeral chat (messages)
- Save to permanent (mutual save)

Success: All After Hours tests pass across both services.
</verification>

<success_criteria>
- [ ] chat-service after-hours.test.ts created (16 tests)
- [ ] profile-service after-hours-session.test.ts created (14 tests)
- [ ] Session start/end tested
- [ ] Match decline tested
- [ ] Messages retrieval tested
- [ ] Save-to-permanent tested
- [ ] All tests pass
- [ ] TEST-05 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-06-SUMMARY.md`
</output>
