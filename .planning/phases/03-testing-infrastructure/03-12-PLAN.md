---
phase: 03-testing-infrastructure
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/profile-service/tests/profile.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Profile service tests pass without 500 errors"
    - "Mock state preserved across tests"
  artifacts:
    - path: "backend/profile-service/tests/profile.test.ts"
      provides: "Fixed test setup with stable mocking"
  key_links:
    - from: "profile.test.ts"
      to: "src/index.ts"
      via: "single app import"
      pattern: "import.*from.*index"
---

<objective>
Fix profile.test.ts failures caused by jest.resetModules() breaking mock state.

Purpose: Same pattern as chat.test.ts - each test uses resetModules and dynamic require, which breaks the mock registry and causes 500 errors from unmocked services (R2, Firebase).

Output: profile.test.ts tests pass without 500 errors
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-testing-infrastructure/03-VERIFICATION.md

@backend/profile-service/tests/profile.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove jest.resetModules and use single app import</name>
  <files>backend/profile-service/tests/profile.test.ts</files>
  <action>
Refactor profile.test.ts to NOT use jest.resetModules():

1. Remove from beforeEach:
   ```typescript
   // DELETE THESE LINES
   jest.resetModules();
   delete require.cache[require.resolve('../src/index')];
   ```

2. Import app ONCE at module level (after mocks):
   ```typescript
   // At top, AFTER jest.mock() calls
   import request from 'supertest';
   import { Pool } from 'pg';
   import app from '../src/index';  // Single import
   ```

3. Remove dynamic require from each test:
   ```typescript
   // DELETE FROM EACH TEST:
   const appModule = require('../src/index');
   app = appModule.default || appModule;
   ```

4. Keep `jest.clearAllMocks()` in beforeEach to reset mock call counts.

5. Remove `let app: any;` declaration - use imported app directly.
  </action>
  <verify>
```bash
cd backend/profile-service && npm test -- --testPathPattern=profile.test.ts --testNamePattern="Health" --verbose
```
Health check should pass.
  </verify>
  <done>App imported once, no resetModules, health check passes</done>
</task>

<task type="auto">
  <name>Task 2: Add missing mocks for external services</name>
  <files>backend/profile-service/tests/profile.test.ts</files>
  <action>
Profile-service uses R2 (Cloudflare) and Firebase. Add mocks at top:

1. Mock @vlvt/shared (CSRF, audit logging):
```typescript
jest.mock('@vlvt/shared', () => ({
  createCsrfMiddleware: jest.fn(() => (req: any, res: any, next: any) => next()),
  createCsrfTokenHandler: jest.fn(() => (req: any, res: any) => res.json({ token: 'mock-token' })),
  createAuditLogger: jest.fn(() => ({
    logAction: jest.fn().mockResolvedValue(undefined),
    logDataChange: jest.fn().mockResolvedValue(undefined),
  })),
  AuditAction: {},
  AuditResourceType: {},
  addVersionToHealth: jest.fn((obj: any) => obj),
  createVersionMiddleware: jest.fn(() => (req: any, res: any, next: any) => next()),
  API_VERSIONS: { V1: 'v1' },
  CURRENT_API_VERSION: 'v1',
}));
```

2. Mock R2 client if profile-service uses it for photo storage:
```typescript
jest.mock('@aws-sdk/client-s3', () => ({
  S3Client: jest.fn(() => ({
    send: jest.fn().mockResolvedValue({}),
  })),
  PutObjectCommand: jest.fn(),
  DeleteObjectCommand: jest.fn(),
  GetObjectCommand: jest.fn(),
}));
```

3. Mock Firebase Admin if used:
```typescript
jest.mock('firebase-admin', () => ({
  initializeApp: jest.fn(),
  credential: {
    cert: jest.fn(),
  },
  messaging: jest.fn(() => ({
    send: jest.fn().mockResolvedValue('message-id'),
  })),
}));
```

4. Mock Sharp for image processing:
```typescript
jest.mock('sharp', () => {
  return jest.fn(() => ({
    resize: jest.fn().mockReturnThis(),
    webp: jest.fn().mockReturnThis(),
    toBuffer: jest.fn().mockResolvedValue(Buffer.from('mock-image')),
    metadata: jest.fn().mockResolvedValue({ width: 800, height: 600 }),
  }));
});
```

Check profile-service imports to identify all external dependencies needing mocks.
  </action>
  <verify>
```bash
cd backend/profile-service && npm test -- --testPathPattern=profile.test.ts --verbose 2>&1 | head -100
```
Check for import errors or missing mock warnings.
  </verify>
  <done>All required external service mocks in place</done>
</task>

<task type="auto">
  <name>Task 3: Verify full profile.test.ts suite passes</name>
  <files>backend/profile-service/tests/profile.test.ts</files>
  <action>
Run full profile.test.ts suite and fix remaining issues:

1. Health Check test should now pass with proper app import
2. POST /profile tests should work with mocked DB
3. GET /profile/:userId tests should work
4. PUT /profile/:userId tests should work
5. DELETE /profile/:userId tests should work
6. GET /profiles/discover - verify mock sequence

For any 500 errors, trace:
- Which query is being made?
- Is the mock returning the expected structure?
- Is the mock being called in expected order?

The tests that pass (validate age, validate required fields, return 401 without auth) prove the basic mock setup works. Focus on tests that interact with mocked services.
  </action>
  <verify>
```bash
cd backend/profile-service && npm test -- --testPathPattern=profile.test.ts --verbose
```
  </verify>
  <done>profile.test.ts: all tests pass or have clear skip reasons</done>
</task>

</tasks>

<verification>
```bash
cd backend/profile-service && npm test -- --testPathPattern=profile.test.ts --verbose
```
Expected: Tests pass without 500 Internal Server Errors
</verification>

<success_criteria>
- [ ] No jest.resetModules() in profile.test.ts
- [ ] App imported once at module level
- [ ] R2/Firebase/Sharp mocks in place
- [ ] @vlvt/shared mock in place
- [ ] Tests don't fail with 500 errors
- [ ] Profile CRUD operations all tested
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-12-SUMMARY.md`
</output>
