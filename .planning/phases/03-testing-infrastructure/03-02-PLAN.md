---
phase: 03-testing-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/auth-service/tests/auth.test.ts
autonomous: true

must_haves:
  truths:
    - "Logout flow test verifies token is invalidated"
    - "Token refresh tests verify access token renewal works"
    - "All existing auth tests continue to pass"
  artifacts:
    - path: "backend/auth-service/tests/auth.test.ts"
      provides: "Complete auth flow test coverage"
      contains: "describe('POST /auth/logout'"
  key_links:
    - from: "auth.test.ts logout tests"
      to: "/auth/logout endpoint"
      via: "supertest request"
      pattern: "post.*logout"
---

<objective>
Complete authentication flow test coverage (TEST-01)

Purpose: TEST-01 requires tests for login, signup, logout, token refresh, and password reset. Research shows existing auth.test.ts covers login/signup/verify/forgot/reset but MISSING logout and token refresh tests.

Output: auth.test.ts extended with logout and token refresh test cases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-testing-infrastructure/03-RESEARCH.md
@backend/auth-service/tests/auth.test.ts
@backend/auth-service/tests/token-rotation.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logout endpoint tests to auth.test.ts</name>
  <files>backend/auth-service/tests/auth.test.ts</files>
  <action>
Add a new describe block for 'POST /auth/logout' after the existing auth tests.

Test cases to add:
1. Should logout successfully with valid token
   - Create valid JWT token
   - Mock pool.query for refresh token deletion
   - POST /auth/logout with Authorization header
   - Expect 200 with success: true

2. Should return 401 for missing token
   - POST /auth/logout without Authorization header
   - Expect 401

3. Should return 401 for invalid token
   - POST /auth/logout with invalid Bearer token
   - Expect 401

4. Should handle non-existent refresh token gracefully
   - Mock pool.query to return empty rows (token not found)
   - Should still return success (idempotent logout)

Follow existing test patterns in the file:
- Use mockPool.query.mockResolvedValueOnce() for sequenced mocks
- Use jwt.sign() with JWT_SECRET for test tokens
- Use request(app).post('/auth/logout').set('Authorization', `Bearer ${token}`)
  </action>
  <verify>
Run: `cd backend/auth-service && npm test -- --testPathPattern="auth.test.ts" -t "logout" --verbose`
All logout tests should pass.
  </verify>
  <done>4 logout test cases added and passing</done>
</task>

<task type="auto">
  <name>Task 2: Add token refresh tests to auth.test.ts</name>
  <files>backend/auth-service/tests/auth.test.ts</files>
  <action>
Add a new describe block for 'POST /auth/refresh' after the logout tests.

Test cases to add:
1. Should refresh token with valid refresh token
   - Create refresh token (longer expiry JWT)
   - Mock pool.query for refresh token lookup and new token storage
   - POST /auth/refresh with refreshToken in body
   - Expect 200 with new access token and refresh token

2. Should return 401 for missing refresh token
   - POST /auth/refresh with empty body
   - Expect 401

3. Should return 401 for invalid refresh token
   - POST /auth/refresh with invalid/malformed token
   - Expect 401

4. Should return 401 for expired refresh token
   - Create expired refresh token (jwt.sign with expiresIn: '-1s')
   - Expect 401

5. Should return 401 for revoked/non-existent refresh token
   - Mock pool.query to return empty rows
   - Expect 401

Note: Check if endpoint is at /auth/refresh or /auth/token/refresh by examining src/index.ts routes.

Follow existing token-rotation.test.ts patterns for mock setup.
  </action>
  <verify>
Run: `cd backend/auth-service && npm test -- --testPathPattern="auth.test.ts" -t "refresh" --verbose`
All refresh tests should pass.
  </verify>
  <done>5 token refresh test cases added and passing</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run full auth test suite:
```bash
cd backend/auth-service && npm test -- --testPathPattern="auth.test.ts" --verbose
```

2. Verify test count increased:
```bash
cd backend/auth-service && npm test -- --testPathPattern="auth.test.ts" --json 2>/dev/null | grep -o '"numPassedTests":[0-9]*'
```

3. Verify no regressions in existing tests.

Success: All auth tests pass including new logout and refresh tests.
</verification>

<success_criteria>
- [ ] Logout endpoint has 4 passing tests
- [ ] Token refresh endpoint has 5 passing tests
- [ ] All existing auth tests still pass
- [ ] TEST-01 requirement satisfied (login, signup, logout, token refresh, password reset all tested)
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-02-SUMMARY.md`
</output>
