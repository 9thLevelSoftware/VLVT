---
phase: 03-testing-infrastructure
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/chat-service/tests/chat.test.ts
autonomous: true

must_haves:
  truths:
    - "Message send flow is tested"
    - "Message retrieval is tested"
    - "Block and report flows are tested (TEST-04)"
  artifacts:
    - path: "backend/chat-service/tests/chat.test.ts"
      provides: "Message and safety flow tests"
      contains: "describe.*message"
  key_links:
    - from: "chat.test.ts"
      to: "/messages endpoint"
      via: "supertest"
      pattern: "post.*messages"
---

<objective>
Complete chat and safety flow tests (TEST-03 + TEST-04)

Purpose: TEST-03 requires message send/receive tests, TEST-04 requires block/report/unblock tests. Research shows chat.test.ts exists but coverage needs verification and extension.

Output: chat.test.ts extended with message flow and safety flow tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-testing-infrastructure/03-RESEARCH.md
@backend/chat-service/tests/chat.test.ts
@backend/chat-service/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Review and extend message flow tests in chat.test.ts</name>
  <files>backend/chat-service/tests/chat.test.ts</files>
  <action>
Review existing chat.test.ts and add missing message flow tests.

Required test coverage for TEST-03 (messaging):

**describe('POST /messages') - if not exists**
1. Should send message to valid match
   - Mock match exists with user as participant
   - Mock message insertion
   - Expect 200 with message object

2. Should return 403 when sending to match user is not part of
   - Mock match exists but user not participant
   - Expect 403

3. Should return 404 for non-existent match
   - Mock no match found
   - Expect 404

4. Should return 400 for empty message text

5. Should return 401 without auth

**describe('GET /messages/:matchId') - if not exists**
6. Should retrieve messages for own match
   - Mock match with user as participant
   - Mock messages query
   - Expect array of messages

7. Should return 403 for match user is not part of

8. Should support pagination (if implemented)

Check existing tests and only add what's missing. Do NOT duplicate.
  </action>
  <verify>
Run: `cd backend/chat-service && npm test -- --testPathPattern="chat.test.ts" -t "message" --verbose`
Message tests should pass.
  </verify>
  <done>Message flow tests verified/extended - send and retrieve covered</done>
</task>

<task type="auto">
  <name>Task 2: Add safety flow tests (block, report, unblock) for TEST-04</name>
  <files>backend/chat-service/tests/chat.test.ts</files>
  <action>
Add safety flow tests to chat.test.ts for TEST-04 requirements.

**describe('POST /blocks') - Block user flow**
1. Should block another user
   - POST with blockedUserId
   - Mock block insertion
   - Expect 200

2. Should return 400 when blocking self

3. Should return 400 for already blocked user (or 200 idempotent)

4. Should return 401 without auth

**describe('DELETE /blocks/:blockedUserId') - Unblock flow**
5. Should unblock a blocked user
   - Mock block deletion
   - Expect 200

6. Should return 404 for non-blocked user

7. Should return 401 without auth

**describe('POST /reports') - Report user flow**
8. Should report user with valid reason
   - POST with reportedUserId, reason
   - Mock report insertion
   - Expect 200

9. Should return 400 for missing reason

10. Should return 400 for invalid reason value

11. Should auto-block when reporting (if implemented)

12. Should return 401 without auth

Examine src/index.ts or routes to find exact endpoint paths. Adapt as needed.
  </action>
  <verify>
Run: `cd backend/chat-service && npm test -- --testPathPattern="chat.test.ts" -t "block|report|unblock" --verbose`
Safety tests should pass.
  </verify>
  <done>Safety flow tests added - block, unblock, report all covered</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run full chat-service test suite:
```bash
cd backend/chat-service && npm test --verbose 2>&1 | tail -40
```

2. Verify coverage of TEST-03 (messages) and TEST-04 (safety):
```bash
cd backend/chat-service && npm test -- --testPathPattern="chat.test.ts" --verbose
```

Success: All message and safety tests pass.
</verification>

<success_criteria>
- [ ] Message send tests exist and pass
- [ ] Message retrieve tests exist and pass
- [ ] Block user tests added (4 cases)
- [ ] Unblock user tests added (3 cases)
- [ ] Report user tests added (5 cases)
- [ ] All tests pass
- [ ] TEST-03 (messaging) and TEST-04 (safety) requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-05-SUMMARY.md`
</output>
