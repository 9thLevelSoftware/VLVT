---
phase: 03-testing-infrastructure
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/auth-service/tests/auth.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Email login tests pass without timeout"
    - "Password reset flow tests pass"
    - "Email verification tests pass"
  artifacts:
    - path: "backend/auth-service/tests/auth.test.ts"
      provides: "Fixed mock sequences and updated expectations"
  key_links:
    - from: "auth.test.ts"
      to: "src/services/email-service"
      via: "properly scoped mock"
      pattern: "jest.mock.*email-service"
---

<objective>
Fix auth.test.ts test failures related to email login, password reset, and verification flows.

Purpose: 29 tests fail due to:
1. Tests timing out in email login block (mock query sequence issues)
2. Password validation changes (now requires 12+ chars, uppercase)
3. Verification token tests returning "Invalid input data" instead of expected errors
4. Email service mock being called when it shouldn't be

Output: auth.test.ts passes all tests (~90 tests)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-testing-infrastructure/03-VERIFICATION.md

@backend/auth-service/tests/auth.test.ts
@backend/auth-service/src/services/email-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix password validation test expectations</name>
  <files>backend/auth-service/tests/auth.test.ts</files>
  <action>
Update password validation tests to match current requirements.

Current password requirements (based on test failures):
- Minimum 12 characters (was 8)
- Must contain uppercase letter
- Must contain lowercase letter
- Cannot be common/easily guessable
- Cannot contain keyboard sequences

Fix these tests:

1. "should reject weak password - missing letter" (line ~517):
   - Test expects "Password must contain at least one letter"
   - Actual returns multiple errors including uppercase/lowercase requirements
   - Update expectation to check for uppercase or lowercase requirement

2. "should accept password with only lowercase and numbers" (line ~565):
   - Test sends "validpass123" (only 12 chars, no uppercase)
   - Password now requires uppercase
   - Change test password to: "ValidPassword123" (meets all requirements)

3. Update any other password test cases using passwords that don't meet new requirements.

Valid test password examples:
- "SecurePassword123!" (meets all requirements)
- "ValidPassword123" (meets all requirements)
- "TestPassword99" (meets all requirements)

Invalid password examples should remain for rejection tests.
  </action>
  <verify>
```bash
cd backend/auth-service && npm test -- --testPathPattern=auth.test.ts --testNamePattern="password" --verbose
```
  </verify>
  <done>Password validation tests updated to match current requirements</done>
</task>

<task type="auto">
  <name>Task 2: Fix email login test timeouts</name>
  <files>backend/auth-service/tests/auth.test.ts</files>
  <action>
Fix the 6 email login tests that timeout. The issue is mock query sequence not matching actual query flow.

Review the actual login flow and update mock sequences:

1. checkAccountLocked is called first
2. Credential lookup query
3. bcrypt.compare for password verification
4. recordSuccessfulLogin or recordFailedLogin
5. Token issuance queries

For each failing login test, trace the actual queries and ensure mocks match:

1. "should login with valid credentials" - Check mock sequence matches:
   - checkAccountLocked mock
   - Credentials lookup mock
   - recordSuccessfulLogin mock (handles both function path and fallback)
   - Token issuance mocks

2. "should reject invalid password" - Ensure bcrypt.compare mock returns false BEFORE the credential lookup mock resolves

3. "should reject unverified email" - Mock must return email_verified: false

4. "should reject non-existent email" - Both checkAccountLocked fallback AND credential lookup must return empty

5. "should reject missing email/password" - These should NOT need mocks (validation happens before DB query)

Key insight: Tests may be hanging because mocks resolve in wrong order. Use explicit mockResolvedValueOnce chains that match exact query sequence.

If queries are running in parallel or sequence differs, trace with console.log temporarily or review src/index.ts login implementation.
  </action>
  <verify>
```bash
cd backend/auth-service && npm test -- --testPathPattern=auth.test.ts --testNamePattern="email/login" --verbose --detectOpenHandles
```
  </verify>
  <done>Email login tests pass without timeout (6 tests)</done>
</task>

<task type="auto">
  <name>Task 3: Fix email verification and reset tests</name>
  <files>backend/auth-service/tests/auth.test.ts</files>
  <action>
Fix verification token and password reset test failures:

1. "should verify with valid token" - Returns 400 "Invalid input data":
   - Token validation may now require specific format
   - Check if endpoint validates token format before DB query
   - May need to generate a valid-looking token (hex string, UUID, etc.)

2. "should reject invalid token" - Expects "Invalid or expired verification token", gets "Invalid input data":
   - Same issue - validation happens before DB query
   - Update expectation OR use a valid-format but non-existent token

3. "should reject expired token" - Similar input validation issue

4. "should always return success (enumeration prevention)" for forgot password:
   - Test expects sendPasswordResetEmail NOT to be called for non-existent email
   - But mock shows it WAS called with undefined email
   - Review mock setup - may need to clear mocks more carefully
   - Use emailService.sendPasswordResetEmail.mockClear() before EACH test in the describe block

5. "should send reset email for existing account":
   - Expects email service to be called but it wasn't
   - Mock query sequence may not be triggering email send code path

Key insight: Input validation was likely added (SEC-07 input sanitization). Update tests to use valid-format tokens, then mock DB responses.

Token format suggestions:
- Verification tokens: 64-char hex string (like crypto.randomBytes(32).toString('hex'))
- Reset tokens: Same format
  </action>
  <verify>
```bash
cd backend/auth-service && npm test -- --testPathPattern=auth.test.ts --testNamePattern="verify|reset|forgot" --verbose
```
  </verify>
  <done>Verification and reset tests pass with correct mock behavior</done>
</task>

</tasks>

<verification>
```bash
cd backend/auth-service && npm test -- --testPathPattern=auth.test.ts --verbose
```
Expected: All auth.test.ts tests pass (no timeouts, no assertion failures)
</verification>

<success_criteria>
- [ ] Password validation tests match current requirements
- [ ] Email login tests don't timeout (complete within 10s)
- [ ] Verification token tests use valid format tokens
- [ ] Password reset tests have correct mock sequences
- [ ] Email service mocks properly cleared between tests
- [ ] Total auth.test.ts: 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-09-SUMMARY.md`
</output>
