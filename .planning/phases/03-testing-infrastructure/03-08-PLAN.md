---
phase: 03-testing-infrastructure
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/auth-service/tests/middleware.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Auth middleware tests pass without import errors"
    - "All 8 middleware.test.ts tests pass"
  artifacts:
    - path: "backend/auth-service/tests/middleware.test.ts"
      provides: "Fixed middleware import and stable test setup"
  key_links:
    - from: "middleware.test.ts"
      to: "src/middleware/auth.ts"
      via: "correct export name import"
      pattern: "authenticateJWT"
---

<objective>
Fix auth middleware test import and setup issues causing 8 test failures.

Purpose: The middleware.test.ts imports `authMiddleware` but the actual export is `authenticateJWT`. Additionally, `jest.resetModules()` in beforeEach breaks the import chain.

Output: 8 passing middleware tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-testing-infrastructure/03-VERIFICATION.md

@backend/auth-service/tests/middleware.test.ts
@backend/auth-service/src/middleware/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix middleware import and remove resetModules</name>
  <files>backend/auth-service/tests/middleware.test.ts</files>
  <action>
Fix two issues in middleware.test.ts:

1. Import the correct export name from auth.ts:
   - WRONG: `authMiddleware = middlewareModule.authMiddleware`
   - RIGHT: Import `authenticateJWT` from '../src/middleware/auth'

2. Remove `jest.resetModules()` from beforeEach - this breaks the import:
   - Remove the `jest.resetModules()` call
   - Import `authenticateJWT` at the top level (after mocks if any)
   - Keep `jest.clearAllMocks()` in beforeEach

The middleware is a pure function that doesn't need module resets between tests.
It only needs mock request/response objects reset.

Example fix structure:
```typescript
import jwt from 'jsonwebtoken';
import { Request, Response, NextFunction } from 'express';
import { authenticateJWT } from '../src/middleware/auth';

const JWT_SECRET = process.env.JWT_SECRET!;

describe('Auth Middleware', () => {
  let mockRequest: Partial<Request>;
  let mockResponse: Partial<Response>;
  let nextFunction: NextFunction;

  beforeEach(() => {
    jest.clearAllMocks();
    // Reset mock objects only, not modules
    mockRequest = { headers: {}, user: undefined };
    mockResponse = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn().mockReturnThis(),
    };
    nextFunction = jest.fn();
  });

  // Tests use authenticateJWT instead of authMiddleware
  it('should call next() with valid token', () => {
    // ...
    authenticateJWT(mockRequest as Request, mockResponse as Response, nextFunction);
    // ...
  });
});
```
  </action>
  <verify>
Run middleware tests:
```bash
cd backend/auth-service && npm test -- --testPathPattern=middleware.test.ts
```
All 8 tests should pass.
  </verify>
  <done>middleware.test.ts: 8/8 tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Align error message expectations</name>
  <files>backend/auth-service/tests/middleware.test.ts</files>
  <action>
After fixing the import, verify error message expectations match the actual middleware responses:

Check auth.ts returns:
- "No authorization header provided" (not "No authorization header")
- "Invalid authorization header format. Use: Bearer <token>" (check test expectation)
- "Invalid token" (from jwt.JsonWebTokenError)
- "Token expired" (from jwt.TokenExpiredError)

Update test expectations in middleware.test.ts to match exact error messages from auth.ts.

For example:
- Line 31-32: error message is "Invalid authorization header format. Use: Bearer <token>", not just "Invalid authorization header format"
- Line 100-102: error message is "Invalid token", not "Invalid or expired token"

Reference src/middleware/auth.ts lines 25, 31, 39, 69, 74 for exact messages.
  </action>
  <verify>
```bash
cd backend/auth-service && npm test -- --testPathPattern=middleware.test.ts --verbose
```
Confirm all 8 tests pass with correct assertions.
  </verify>
  <done>All middleware test assertions match actual error responses</done>
</task>

</tasks>

<verification>
```bash
cd backend/auth-service && npm test -- --testPathPattern=middleware.test.ts --verbose
```
Expected: 8/8 tests passing, no timeouts
</verification>

<success_criteria>
- [ ] middleware.test.ts imports `authenticateJWT` correctly
- [ ] No `jest.resetModules()` in beforeEach
- [ ] All 8 middleware tests pass
- [ ] Error message expectations match actual middleware responses
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-08-SUMMARY.md`
</output>
