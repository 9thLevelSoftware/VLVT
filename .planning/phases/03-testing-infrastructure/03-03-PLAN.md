---
phase: 03-testing-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/auth-service/tests/subscription.test.ts
autonomous: true

must_haves:
  truths:
    - "RevenueCat webhook signature validation is tested"
    - "Subscription entitlement checks are tested"
    - "Premium feature gates are verified"
  artifacts:
    - path: "backend/auth-service/tests/subscription.test.ts"
      provides: "RevenueCat subscription test coverage"
      exports: ["describe"]
      min_lines: 100
  key_links:
    - from: "subscription.test.ts"
      to: "RevenueCat webhook endpoint"
      via: "supertest POST /webhooks/revenuecat"
      pattern: "post.*webhooks.*revenuecat"
---

<objective>
Add RevenueCat subscription flow tests (TEST-02)

Purpose: TEST-02 requires payment flow tests for RevenueCat subscription and entitlement checks. Research shows revenuecat-webhook.test.ts exists but only tests webhook auth validation - missing subscription state tests.

Output: New subscription.test.ts with comprehensive RevenueCat integration tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-testing-infrastructure/03-RESEARCH.md
@backend/auth-service/tests/revenuecat-webhook.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subscription.test.ts for RevenueCat flows</name>
  <files>backend/auth-service/tests/subscription.test.ts</files>
  <action>
Create new test file backend/auth-service/tests/subscription.test.ts.

Follow the existing mock pattern from revenuecat-webhook.test.ts and auth.test.ts:

```typescript
// Mock dependencies before importing
jest.mock('pg', () => {
  const mPool = {
    query: jest.fn(),
    on: jest.fn(),
  };
  return { Pool: jest.fn(() => mPool) };
});

jest.mock('@sentry/node', () => ({
  init: jest.fn(),
  setupExpressErrorHandler: jest.fn(),
}));

// Mock rate limiters
jest.mock('../src/middleware/rate-limiter', () => ({
  authLimiter: (req: any, res: any, next: any) => next(),
  verifyLimiter: (req: any, res: any, next: any) => next(),
  generalLimiter: (req: any, res: any, next: any) => next(),
}));
```

Test cases to implement:

**describe('RevenueCat Webhook Subscription Events')**
1. Should process INITIAL_PURCHASE event
   - Valid webhook signature
   - Mock user exists in DB
   - Expect subscription record created/updated
   - Expect 200 OK

2. Should process RENEWAL event
   - Mock existing subscription
   - Expect subscription expiry extended

3. Should process CANCELLATION event
   - Mock active subscription
   - Expect subscription marked as cancelled

4. Should process EXPIRATION event
   - Expect subscription marked as expired

5. Should ignore events for unknown users
   - Mock user not found
   - Should return 200 (no error) but not create subscription

**describe('Subscription Status Endpoints')**
6. GET /subscription/status - Should return active subscription
   - Mock active subscription in DB
   - Expect isPremium: true, expiresAt, etc.

7. GET /subscription/status - Should return inactive for expired
   - Mock expired subscription
   - Expect isPremium: false

8. GET /subscription/status - Should return 401 without auth

**describe('Premium Feature Gates')**
9. After Hours endpoint should require premium
   - If there's a premium check endpoint, test gate behavior

Reference RevenueCat webhook event structure:
```json
{
  "event": {
    "type": "INITIAL_PURCHASE",
    "app_user_id": "user_id",
    "product_id": "premium_monthly",
    "expiration_at_ms": 1234567890000
  }
}
```
  </action>
  <verify>
Run: `cd backend/auth-service && npm test -- --testPathPattern="subscription.test.ts" --verbose`
All subscription tests should pass.
  </verify>
  <done>subscription.test.ts created with 8+ test cases covering webhook events and subscription status</done>
</task>

<task type="auto">
  <name>Task 2: Verify webhook auth tests in revenuecat-webhook.test.ts</name>
  <files>backend/auth-service/tests/revenuecat-webhook.test.ts</files>
  <action>
Review existing revenuecat-webhook.test.ts and ensure it covers:
1. Valid Authorization header accepted
2. Missing Authorization header rejected (401)
3. Invalid Authorization header rejected (401)

If any of these are missing, add them. If all exist, document coverage in summary.

Do NOT duplicate tests that already exist - this task is verification only.
  </action>
  <verify>
Run: `cd backend/auth-service && npm test -- --testPathPattern="revenuecat-webhook.test.ts" --verbose`
Webhook auth tests should pass.
  </verify>
  <done>RevenueCat webhook auth tests verified complete</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run all subscription-related tests:
```bash
cd backend/auth-service && npm test -- --testPathPattern="subscription|revenuecat" --verbose
```

2. Verify TEST-02 coverage:
- Webhook events: INITIAL_PURCHASE, RENEWAL, CANCELLATION, EXPIRATION
- Subscription status endpoint
- Auth validation

Success: All subscription and webhook tests pass.
</verification>

<success_criteria>
- [ ] subscription.test.ts created with 8+ test cases
- [ ] Webhook event processing tested (INITIAL_PURCHASE, RENEWAL, CANCELLATION, EXPIRATION)
- [ ] Subscription status endpoint tested
- [ ] All tests pass
- [ ] TEST-02 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-03-SUMMARY.md`
</output>
