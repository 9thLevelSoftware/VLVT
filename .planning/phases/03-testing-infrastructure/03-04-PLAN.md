---
phase: 03-testing-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/profile-service/tests/swipe.test.ts
autonomous: true

must_haves:
  truths:
    - "Swipe/like action is tested"
    - "Discovery feed retrieval is tested"
    - "Match creation on mutual like is tested"
  artifacts:
    - path: "backend/profile-service/tests/swipe.test.ts"
      provides: "Swipe and discovery flow tests"
      exports: ["describe"]
      min_lines: 80
  key_links:
    - from: "swipe.test.ts"
      to: "swipe/discovery endpoints"
      via: "supertest"
      pattern: "post.*(swipe|like|discover)"
---

<objective>
Add swipe and discovery flow tests (TEST-03 partial)

Purpose: TEST-03 requires match/chat flow tests including swipe. Research shows profile-service handles swipes/discovery but no swipe-specific tests exist.

Output: New swipe.test.ts with discovery and swipe action tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-testing-infrastructure/03-RESEARCH.md
@backend/profile-service/tests/profile.test.ts
@backend/profile-service/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create swipe.test.ts for discovery and swipe flows</name>
  <files>backend/profile-service/tests/swipe.test.ts</files>
  <action>
Create new test file backend/profile-service/tests/swipe.test.ts.

First, examine profile-service/src/index.ts to identify the actual swipe/discovery endpoints. Look for:
- GET /discover or GET /profiles/discover
- POST /swipe or POST /like
- Any endpoint creating swipes/likes

Follow existing test patterns from profile.test.ts:

```typescript
import jwt from 'jsonwebtoken';

jest.mock('pg', () => {
  const mPool = {
    query: jest.fn(),
    on: jest.fn(),
  };
  return { Pool: jest.fn(() => mPool) };
});

jest.mock('@sentry/node', () => ({
  init: jest.fn(),
  setupExpressErrorHandler: jest.fn(),
}));

// Mock other dependencies as needed (sharp, S3, etc.)

import request from 'supertest';
import { Pool } from 'pg';

const JWT_SECRET = process.env.JWT_SECRET!;
```

Test cases to implement:

**describe('GET /discover or equivalent')**
1. Should return discovery profiles
   - Mock user with profile
   - Mock potential matches query
   - Expect array of profiles

2. Should exclude already-swiped profiles
   - Mock swipes table to exclude certain users
   - Expect those users not in results

3. Should respect distance/age filters
   - Mock preferences
   - Verify query includes filters

4. Should return 401 without auth

**describe('POST /swipe or /like')**
5. Should record swipe action (like)
   - POST with targetUserId and action: 'like'
   - Mock swipe insertion
   - Expect 200

6. Should record swipe action (pass)
   - POST with action: 'pass'
   - Expect 200

7. Should create match on mutual like
   - Mock that target already liked user
   - Expect match created
   - Response should indicate match: true

8. Should return 400 for missing targetUserId

9. Should return 403 for swiping on self

10. Should return 401 without auth

Adapt endpoint paths based on what's actually in the codebase.
  </action>
  <verify>
Run: `cd backend/profile-service && npm test -- --testPathPattern="swipe.test.ts" --verbose`
All swipe tests should pass.
  </verify>
  <done>swipe.test.ts created with 10 test cases for discovery and swipe flows</done>
</task>

</tasks>

<verification>
After task completes:

1. Run swipe tests:
```bash
cd backend/profile-service && npm test -- --testPathPattern="swipe.test.ts" --verbose
```

2. Run full profile-service test suite to ensure no regressions:
```bash
cd backend/profile-service && npm test --verbose 2>&1 | tail -30
```

Success: All swipe tests pass, no regressions in other tests.
</verification>

<success_criteria>
- [ ] swipe.test.ts created with 10 test cases
- [ ] Discovery endpoint tested
- [ ] Swipe like/pass actions tested
- [ ] Mutual like -> match creation tested
- [ ] Auth and validation tested
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-04-SUMMARY.md`
</output>
