---
phase: 03-testing-infrastructure
plan: 07
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04", "03-05", "03-06"]
files_modified:
  - backend/auth-service/tests/security-regression.test.ts
autonomous: true

must_haves:
  truths:
    - "SQL injection prevention is regression-tested"
    - "XSS prevention is regression-tested"
    - "BOLA/IDOR fixes have regression tests"
    - "Security fixes from Phase 1 cannot be accidentally reverted"
  artifacts:
    - path: "backend/auth-service/tests/security-regression.test.ts"
      provides: "Security regression test suite"
      exports: ["describe"]
      min_lines: 100
  key_links:
    - from: "security-regression.test.ts"
      to: "Input validation utils"
      via: "import"
      pattern: "validateAndSanitizeString|validateEmail"
---

<objective>
Consolidate security regression tests (TEST-06)

Purpose: TEST-06 requires security regression tests preventing reintroduction of fixed vulnerabilities. Research shows security-tests.ts exists with input validation tests but needs consolidation into a regression suite that documents what each test protects.

Output: security-regression.test.ts with documented regression tests for Phase 1 security fixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-testing-infrastructure/03-RESEARCH.md
@backend/auth-service/tests/security-tests.ts
@.planning/phases/01-security-hardening/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security-regression.test.ts consolidating Phase 1 protections</name>
  <files>backend/auth-service/tests/security-regression.test.ts</files>
  <action>
Create backend/auth-service/tests/security-regression.test.ts that documents and tests Phase 1 security fixes.

Structure the file with clear documentation of WHAT vulnerability each test prevents:

```typescript
/**
 * Security Regression Tests
 *
 * These tests ensure Phase 1 security fixes cannot be accidentally reverted.
 * Each describe block documents the vulnerability and the fix.
 *
 * Related requirements: SEC-01 through SEC-09, TEST-06
 */

import request from 'supertest';
import jwt from 'jsonwebtoken';

// Standard mocks
jest.mock('pg', () => {
  const mPool = { query: jest.fn(), on: jest.fn() };
  return { Pool: jest.fn(() => mPool) };
});

jest.mock('@sentry/node', () => ({
  init: jest.fn(),
  setupExpressErrorHandler: jest.fn(),
}));

jest.mock('../src/middleware/rate-limiter', () => ({
  authLimiter: (req: any, res: any, next: any) => next(),
  verifyLimiter: (req: any, res: any, next: any) => next(),
  generalLimiter: (req: any, res: any, next: any) => next(),
}));

import { Pool } from 'pg';
import app from '../src/index';
import {
  validateAndSanitizeString,
  validateEmail,
  validateUserId,
} from '../src/utils/input-validation';

const JWT_SECRET = process.env.JWT_SECRET!;
```

Test sections to include:

**describe('SEC-07: SQL Injection Prevention')**
Document: PII logging was fixed, but SQL injection in inputs could expose data.
Tests from security-tests.ts:
- Reject `OR '1'='1` patterns
- Reject `DROP TABLE` patterns
- Reject `UNION SELECT` patterns
- Sanitize `--` comment sequences

**describe('SEC-07: XSS Prevention')**
Document: Input validation prevents XSS in user-provided content.
Tests:
- Reject `<script>` tags
- Reject `javascript:` URLs
- Reject `onerror=` event handlers

**describe('SEC-04: BOLA/IDOR Prevention')**
Document: Users cannot access other users' resources.
Tests:
- GET /matches/:userId returns 403 for other user's matches
- Verify Authorization header required on all protected endpoints
- Add test that accessing profile by ID requires ownership or valid relationship

**describe('SEC-05: Rate Limiting')**
Document: Brute force attacks are rate-limited.
Tests (may need to be marked skip in dev if rate limiter mock):
- Multiple rapid login attempts trigger rate limit
- Rate limit applies to auth endpoints

**describe('SEC-03: Dependency Security')**
Document: No critical CVEs in dependencies.
This is more of a CI check, but include a test that parses npm audit:
```typescript
it.skip('should have no critical vulnerabilities (run npm audit)', () => {
  // This is verified by CI pipeline
  // Document here for regression tracking
});
```

**describe('SEC-06: No Hardcoded Secrets')**
Document: Secrets must come from environment variables.
Test:
- JWT_SECRET from env is used
- No secrets in code (static analysis would catch this)

Reference existing security-tests.ts and incorporate/adapt those tests with better documentation.
  </action>
  <verify>
Run: `cd backend/auth-service && npm test -- --testPathPattern="security-regression.test.ts" --verbose`
Security regression tests should pass.
  </verify>
  <done>security-regression.test.ts created documenting all Phase 1 security protections</done>
</task>

<task type="auto">
  <name>Task 2: Add BOLA regression tests across services</name>
  <files>backend/auth-service/tests/security-regression.test.ts</files>
  <action>
Extend security-regression.test.ts with BOLA tests for key endpoints.

Add tests that verify authorization checks from Phase 1 (01-06):

**Additional BOLA tests:**
1. User cannot access another user's profile settings
2. User cannot modify another user's profile
3. User cannot send messages in matches they're not part of
4. User cannot view matches they're not part of
5. User cannot delete another user's photos

These may need to be integration-style tests. Use the existing mock patterns.

For endpoints in profile-service or chat-service, consider adding brief BOLA tests in their respective test files or document that those tests exist in their authorization.test.ts files.

At minimum, add comments in security-regression.test.ts pointing to where BOLA tests live:

```typescript
/**
 * BOLA tests exist in:
 * - backend/auth-service/tests/authorization.test.ts
 * - backend/profile-service/tests/authorization.test.ts
 * - backend/chat-service/tests/authorization.test.ts
 *
 * These were added in Phase 1 Plan 06.
 * Key protections:
 * - All 60 endpoints audited
 * - 53 endpoints verified protected
 * - 7 endpoints verified N/A (public auth)
 */
```
  </action>
  <verify>
Run: `cd backend/auth-service && npm test -- --testPathPattern="authorization|security-regression" --verbose`
Authorization and security tests should pass.
  </verify>
  <done>BOLA regression documentation complete with cross-references to authorization.test.ts files</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run security regression tests:
```bash
cd backend/auth-service && npm test -- --testPathPattern="security-regression.test.ts" --verbose
```

2. Run all authorization tests:
```bash
cd backend/auth-service && npm test -- --testPathPattern="authorization" --verbose
cd backend/profile-service && npm test -- --testPathPattern="authorization" --verbose
cd backend/chat-service && npm test -- --testPathPattern="authorization" --verbose
```

3. Verify TEST-06 complete: Security fixes have documented regression tests.

Success: All security and authorization tests pass.
</verification>

<success_criteria>
- [ ] security-regression.test.ts created
- [ ] SQL injection prevention tests documented and passing
- [ ] XSS prevention tests documented and passing
- [ ] BOLA/IDOR protections documented
- [ ] Cross-references to authorization.test.ts files
- [ ] All tests pass
- [ ] TEST-06 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-07-SUMMARY.md`
</output>
